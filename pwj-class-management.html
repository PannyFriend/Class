<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ - æ•´åˆå¢å¼ºç‰ˆ</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.staticfile.net/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      /* ç¬¬äºŒä¸ªç³»ç»Ÿçš„æ¸…æ–°é…è‰²æ–¹æ¡ˆ */
      :root {
        --cream: #fff8ee;
        --paper: #ffffff;
        --green: #a7d7c5;
        --green2: #bde3d5;
        --sun: #ffd45a;
        --ink: #3a3a3a;
        --sub: #8e8c84;
        --line: #efe7da;
        --accent: #f7c873;
        --warn: #ffb4a8;
        --ok: #9ed39e;
        /* --primary: #a7d7c5; */
        --primary: #69a790;

        --secondary: #bde3d5;
        --accent1: #ffd45a;
        --accent2: #9ed39e;
        --accent3: #f7c873;
        --text: #3a3a3a;
        --text-light: #8e8c84;
        --border: #efe7da;
        --light: #fff8ee;
        --white: #ffffff;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--cream);
        font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
          system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          sans-serif;
        color: var(--ink);
        line-height: 1.6;
        min-height: 100vh;
      }

      /* å¤´éƒ¨æ ·å¼ */
      header {
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .wrap {
        /* max-width: 1400px; */
        margin: 0 auto;
        padding: 0 30px;
      }
      /* å°å±å¹•è®¾å¤‡ï¼ˆæ‰‹æœºï¼Œå±å¹•å®½åº¦ < 768pxï¼‰ */
      @media (max-width: 767.98px) {
        .wrap {
          padding: 0 16px; /* æ›´çª„çš„å†…è¾¹è·ï¼Œé¿å…å†…å®¹å¤ªé è¾¹ */
        }
      }

      .hero {
        background: linear-gradient(180deg, var(--green), var(--green2));
        border-radius: 28px;
        box-shadow: 0 10px 30px rgba(74, 119, 104, 0.15);
        padding: 16px;
        border: 2px solid #cfece2;
        margin: 12px 0;
        transition: all 0.3s;
        overflow: hidden;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .logo {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: #fff;
        border: 2px solid #dff4ec;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
      }

      .title {
        font-size: 22px;
        margin: 0;
        font-weight: 900;
      }

      .sun {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--sun);
        border: 3px solid #eac24f;
        box-shadow: 0 6px 0 rgba(234, 194, 79, 0.35);
        margin-left: auto;
        cursor: pointer;
      }

      .bubble {
        display: inline-block;
        background: #fff;
        border: 2px solid var(--line);
        padding: 8px 12px;
        border-radius: 18px;
        margin-bottom: 10px;
        color: #5a5a5a;
      }

      /* å·¥å…·æ æ ·å¼ */
      .toolbar-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin: 10px 0;
      }

      .header-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-start;
        margin-top: 10px;
      }

      /* æŒ‰é’®æ ·å¼ */
      .btn {
        border: 2px solid var(--line);
        background: var(--accent);
        color: #6a530b;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 0 #d9c08b;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        text-decoration: none;
        border: none;
      }

      .btn:hover {
        transform: translateY(1px);
        box-shadow: 0 3px 0 #d9c08b;
      }

      .btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #d9c08b;
      }

      .btn.ghost {
        background: #fff;
        color: #5b775e;
        border-color: #bfe4d5;
        box-shadow: 0 4px 0 #bfe4d5;
      }

      .btn.flat {
        background: #fff9e9;
        color: #6b5a2a;
        border-color: #eadfcb;
        box-shadow: 0 4px 0 #e1cfaa;
      }

      .btn.warn {
        background: var(--warn);
        color: #6b2222;
        border-color: #f3b1a8;
        box-shadow: 0 4px 0 #f3b1a8;
      }

      .btn.ok {
        background: var(--ok);
        color: #194f19;
        border-color: #bde8bd;
        box-shadow: 0 4px 0 #bde8bd;
      }

      .btn.primary {
        background: var(--primary);
        color: #2d5a47;
        border-color: #8cc5a8;
        box-shadow: 0 4px 0 #8cc5a8;
      }

      .btn.secondary {
        background: var(--secondary);
        color: #2d5a47;
        border-color: #9fd4b8;
        box-shadow: 0 4px 0 #9fd4b8;
      }

      .btn.rule {
        background: #e9f3ff;
        color: #2a616b;
        border-color: #cbeae4;
        box-shadow: 0 4px 0 #aadce1;
      }

      .btn.mall {
        background: #f2ffe9;
        color: #4c6b2a;
        border-color: #dfeacb;
        box-shadow: 0 4px 0 #bbe1aa;
      }
      .btn-sm {
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 16px;
      }

      .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* è¡¨å•å…ƒç´ æ ·å¼ */
      input,
      select,
      textarea {
        padding: 10px 12px;
        border: 2px solid var(--line);
        border-radius: 14px;
        background: #fff;
        font-family: inherit;
        font-size: 14px;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(167, 215, 197, 0.3);
      }

      .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid var(--line);
        border-radius: 14px;
        background: #fff;
      }

      /* å¸ƒå±€æ ·å¼ */
      .layout {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 16px;
        margin-top: 16px;
      }

      @media (max-width: 1200px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }

      .main-content {
        display: flex;
        gap: 20px;
      }

      .left-panel {
        flex: 2;
      }

      .right-panel {
        flex: 1;
        min-width: 320px;
      }

      /* å­¦ç”Ÿå¡ç‰‡æ ·å¼ */
      .student-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .student-list {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 16px;
      }

      .student-card {
        flex: 0 0 calc(25% - 16px);
        /* æ¯è¡Œ3ä¸ªå¡ç‰‡ */
        box-sizing: border-box;
      }

      @media (max-width: 992px) {
        .student-card {
          flex: 0 0 calc(50% - 16px);
          /* ä¸­ç­‰å±å¹•æ¯è¡Œ2ä¸ª */
        }
      }
      @media (max-width: 1500px) {
        .student-card {
          flex: 0 0 calc(33.333333333333% - 16px);
        }
      }
      @media (max-width: 576px) {
        .student-card {
          flex: 0 0 100%;
          /* å°å±å¹•æ¯è¡Œ1ä¸ª */
        }
      }

      @media (min-width: 1800px) {
        .student-card {
          flex: 0 0 calc(20% - 16px);
        }
      }

      @media (min-width: 2040px) {
        .student-card {
          flex: 0 0 calc(16.6666666% - 16px);
        }
      }

      .student-card {
        background: var(--paper);
        border: 2px solid var(--line);
        border-radius: 22px;
        box-shadow: 0 8px 0 #efe4cf;
        padding: 16px;
        position: relative;
        transition: all 0.3s ease;
        cursor: move;
      }

      .student-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 0 #efe4cf;
      }

      .student-card.male {
        border-left: 4px solid var(--secondary);
      }

      .student-card.female {
        border-left: 4px solid var(--warn);
      }

      .student-avatar {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid var(--line);
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        color: var(--text);
        cursor: pointer;
        margin: 0 auto 12px auto;
        position: relative;
        transition: all 0.2s ease;
      }

      .student-avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .student-avatar.male {
        background: linear-gradient(135deg, var(--secondary) 0%, #a8dcc2 100%);
        color: #2d5a47;
      }

      .student-avatar.female {
        background: linear-gradient(135deg, var(--warn) 0%, #ffc7c0 100%);
        color: #6b2222;
      }

      .student-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .student-info {
        text-align: left;
      }

      .student-name-container {
        margin-bottom: 8px;
      }

      .student-name-input {
        color: var(--text);
        font-family: inherit;
      }

      .student-name-input:focus {
        outline: none;
      }

      /* å¤šé€‰å¤é€‰æ¡†æ ·å¼ä¼˜åŒ– */
      .multi-select-checkbox {
        position: absolute;
        top: 12px;
        left: 12px;
        width: 18px;
        height: 18px;
        display: none;
        z-index: 15;
        cursor: pointer;
        accent-color: var(--primary);
      }

      body.multi-select-mode .multi-select-checkbox {
        display: block;
      }

      body.multi-select-mode .student-controls {
        opacity: 0.5;
        pointer-events: none;
      }

      .student-controls {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        margin-top: 12px;
      }

      .control-btn {
        padding: 8px 0;
        text-align: center;
        font-weight: 800;
        border: 2px solid var(--line);
        background: #fff;
        cursor: pointer;
        border-radius: 12px;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .control-btn:hover {
        transform: translateY(1px);
      }

      .plus-btn {
        background: #e6f6ec;
        color: #194f19;
      }

      .minus-btn {
        background: #ffeae5;
        color: #6b2222;
      }

      .history-btn {
        background: #edebff;
        color: #4a4a8a;
      }

      .shop-btn {
        background: #fff4d8;
        color: #6b5a2a;
      }

      .delete-btn {
        background: #f8f6f1;
        color: #666;
      }

      /* ä¾§è¾¹æ æ ·å¼ */
      .side {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .panel {
        background: var(--paper);
        border: 2px solid var(--line);
        border-radius: 18px;
        box-shadow: 0 6px 0 #efe4cf;
        padding: 16px;
      }

      .panel h4 {
        margin: 0 0 12px;
        font-size: 16px;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .panel_rule {
        border: 0;
        box-shadow: none;
        padding: 0;
      }

      .leaderboard-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 580px;
        overflow-y: scroll;
      }

      .leaderboard-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: var(--light);
        border-radius: 12px;
        border: 1px solid var(--line);
      }

      .rank-badge {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 12px;
        border: 2px solid var(--line);
      }

      .rank-1 {
        background: #ffd76a;
        color: #6b5a2a;
      }

      .rank-2 {
        background: #e0e0e0;
        color: #666;
      }

      .rank-3 {
        background: #f3b493;
        color: #6b4a2a;
      }

      .leaderboard-info {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .leaderboard-name {
        font-weight: 600;
      }

      .leaderboard-points {
        font-weight: 800;
        color: var(--primary);
      }

      /* æ¨¡æ€æ¡†æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        background: var(--paper);
        border-radius: 18px;
        width: 90%;
        max-width: 600px;
        margin: 10vh auto;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        border: 2px solid var(--line);
      }

      .modal-header {
        padding: 20px 24px;
        background: var(--primary);
        color: #2d5a47;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 800;
        margin: 0;
      }

      .close {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #2d5a47;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      .modal-body {
        padding: 20px 24px;
        max-height: 70vh;
        overflow-y: auto;
      }

      .modal-footer {
        padding: 16px 24px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        border-top: 1px solid var(--line);
      }

      /* æ ‡ç­¾é¡µæ ·å¼ */
      .tabs {
        display: flex;
        background: var(--paper);
        border: 2px solid var(--line);
        border-radius: 18px 18px 0 0;
        overflow: hidden;
      }

      .tab-btn {
        flex: 1;
        padding: 12px 16px;
        background: var(--light);
        color: var(--text);
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .tab-btn:hover {
        background: #f0f8f4;
      }

      .tab-btn.active {
        background: var(--paper);
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
      }

      .tab-content {
        display: none;
        background: var(--paper);
        border: 2px solid var(--line);
        border-top: none;
        border-radius: 0 0 18px 18px;
        padding: 20px;
      }

      .tab-content.active {
        display: block;
      }

      /* æœç´¢æ¡†æ ·å¼ */
      .search-container {
        margin-bottom: 16px;
      }

      /* å¤šé€‰æ¨¡å¼æ ·å¼ */
      .multi-select-checkbox {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 18px;
        height: 18px;
        display: none;
      }

      body.multi-select-mode .multi-select-checkbox {
        display: block;
      }

      body.multi-select-mode .student-controls {
        opacity: 0.5;
        pointer-events: none;
      }

      /* æ‹–æ‹½æ ·å¼ */
      .dropzone {
        border: 2px dashed var(--line);
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .dropzone.drag-over {
        border-color: var(--primary);
        background: rgba(167, 215, 197, 0.1);
      }

      /* åŠ¨ç”»æ•ˆæœ */
      .point-animation {
        position: absolute;
        z-index: 1000;
        font-weight: 800;
        font-size: 24px;
        animation: floatUp 1.2s forwards;
        pointer-events: none;
      }

      .point-animation.positive {
        color: var(--ok);
      }

      .point-animation.negative {
        color: var(--warn);
      }

      @keyframes floatUp {
        0% {
          opacity: 0;
          transform: translateY(0) scale(0.5);
        }

        20% {
          opacity: 1;
          transform: translateY(-20px) scale(1.2);
        }

        100% {
          opacity: 0;
          transform: translateY(-80px) scale(1);
        }
      }

      /* åˆ†å‰²çº¿è£…é¥° */
      .divider {
        height: 18px;
        background: radial-gradient(
            circle at 20px -8px,
            #fff 20px,
            rgba(0, 0, 0, 0) 21px
          )
          left/40px 18px repeat-x;
        margin: 8px 0;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .toolbar-row {
          flex-direction: column;
          align-items: stretch;
        }

        .toolbar-row > * {
          width: 100%;
        }

        .header-controls {
          justify-content: center;
        }

        .student-list {
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        }

        .layout {
          grid-template-columns: 1fr;
        }
      }

      /* è§„åˆ™é€‰é¡¹æ ·å¼ */
      .rules-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }

      .rule-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid var(--line);
      }

      .rule-option.positive {
        background: rgba(158, 211, 158, 0.1);
        border-color: var(--ok);
      }

      .rule-option.negative {
        background: rgba(255, 180, 168, 0.1);
        border-color: var(--warn);
      }

      .rule-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* å¯¼å…¥å¯¼å‡ºæ ·å¼ */
      .import-help {
        background: var(--light);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 16px;
        font-size: 13px;
        color: var(--sub);
      }

      .import-help code {
        background: var(--paper);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
      }

      /* ç‰ˆæƒä¿¡æ¯ */
      .copyright {
        text-align: center;
        padding: 20px;
        color: var(--sub);
        font-size: 12px;
        margin-top: 40px;
      }

      /* å·¥å…·æç¤º */
      .tooltip {
        position: fixed;
        background: var(--text);
        color: var(--paper);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 1001;
        display: none;
        max-width: 200px;
      }

      /* å°ç»„éƒ¨åˆ†æ ·å¼ */
      .group-section {
        width: 100%;
        margin-bottom: 24px;
      }

      .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--light);
        border: 2px solid var(--line);
        border-radius: 16px;
        margin-bottom: 12px;
      }

      .group-name {
        font-size: 16px;
        font-weight: 800;
        color: var(--text);
      }

      .group-stats {
        font-size: 13px;
        color: var(--sub);
      }

      .rank-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #eee;
      }

      .rank-item:hover {
        background: #f8f9fa;
      }
      .rank-tabs button {
        background: #ffe0e0;
        color: #6b5a2a;
        border-color: #eacbcb;
        box-shadow: 0 4px 0 #e1aaaa;
        margin: 20px 10px 0 0;
        padding: 10px 20px;
        border-radius: 6px;
      }

      .active_rank_item {
        background-color: #2d5a47;
        color: #fff;
      }
      .active_rank_item:hover {
        background-color: #2d5a47;
        color: #fff;
      }
      .diygrade {
        display: flex;
        gap: 12px;
        margin: 12px 0;
      }

      /* å°å±å¹•è®¾å¤‡ï¼ˆæ‰‹æœºï¼Œå±å¹•å®½åº¦ < 768pxï¼‰ */
      @media (max-width: 767.98px) {
        .diygrade {
          display: block;
        }
        .diygrade input {
          margin-bottom: 8px;
        }
        .diygrade button {
          display: block;
          margin-left: auto;
        }
      }

      .bubble_classList {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      @media (max-width: 767.98px) {
        .bubble_classList {
          display: block;
        }
      }

      /* ä¹å®«æ ¼æ ·å¼ */
      .lottery-container {
        display: inline-block;
        margin: 25px 0;
      }

      .lottery-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        width: 400px;
        height: 400px;
        background: linear-gradient(145deg, #f0f8f0, #e8f5e8);
        border-radius: 25px;
        padding: 20px;
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1),
          0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .grid-item {
        background: linear-gradient(135deg, #ffffff, #f8fff8);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #4a9d6f;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        border: 2px solid transparent;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .grid-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .grid-item.active {
        background: linear-gradient(135deg, #ff7043, #ff5722);
        color: white;
        transform: scale(1.05);
        border-color: #ff3d00;
        box-shadow: 0 0 25px rgba(255, 87, 34, 0.6),
          0 4px 15px rgba(0, 0, 0, 0.2);
        animation: pulse 0.6s ease-in-out;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .grid-item.center {
        background: linear-gradient(135deg, #4a9d6f, #2e7d4f);
        color: white;
        font-size: 18px;
        cursor: pointer;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .grid-item.center:hover {
        background: linear-gradient(135deg, #2e7d4f, #1b5e3f);
        transform: translateY(-2px) scale(1.02);
      }

      .grid-item.empty {
        background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
        color: #bbb;
        cursor: not-allowed;
        font-size: 24px;
      }

      @keyframes pulse {
        0% {
          transform: scale(1.05);
        }
        50% {
          transform: scale(1.12);
        }
        100% {
          transform: scale(1.05);
        }
      }

      .result {
        margin-top: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #e8f5e8, #d4f4d4);
        border-radius: 15px;
        font-size: 18px;
        font-weight: bold;
        color: #2e7d4f;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        border: 2px solid rgba(46, 125, 79, 0.2);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .result.winner {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        color: #e65100;
        border-color: rgba(230, 81, 0, 0.3);
        animation: celebrate 1s ease-in-out;
      }

      @keyframes celebrate {
        0%,
        100% {
          transform: scale(1);
        }
        25% {
          transform: scale(1.02);
        }
        50% {
          transform: scale(1.05);
        }
        75% {
          transform: scale(1.02);
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        .main-container {
          padding: 20px;
        }

        .lottery-grid {
          width: 320px;
          height: 320px;
          padding: 15px;
          gap: 6px;
        }

        .grid-item {
          font-size: 14px;
        }

        .grid-item.center {
          font-size: 16px;
        }

        .prize-input {
          flex-direction: column;
        }

        .prize-input input {
          min-width: 100%;
        }

        .control-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .action-buttons {
          width: 100%;
        }

        .btn {
          flex: 1;
          justify-content: center;
        }
      }
    </style>
  </head>
  <!-- 
ç§¯åˆ†è§„åˆ™é€»è¾‘

1.å°ç»„åŒå­¦åŠ åˆ†ï¼Œå°ç»„åŠ åˆ† æ”¯æŒï¼ˆå¾…æ·»åŠ å†å²è®°å½•ç»™å°ç»„  åŒºåˆ†ç±»å‹ï¼Œå°ç»„/å­¦å‘˜ï¼‰
2.å°ç»„åŠ åˆ†ï¼Œå°ç»„åŒå­¦åŠ åˆ† æ”¯æŒ ï¼ˆå¾…æ·»åŠ å°ç»„ç§¯åˆ†å†å²è®°å½•ï¼‰
3.åŒå­¦ç§¯åˆ†æ¶ˆè´¹ï¼Œåªæ‰£å‡å­¦å‘˜åˆ†ï¼Œä¸æ‰£å‡å°ç»„åˆ† å·²æ”¯æŒ
4.å°ç»„ç§¯åˆ†æ¶ˆè´¹ï¼ˆæ¸…é›¶ï¼‰ï¼Œåªæ‰£å‡å°ç»„åˆ†ï¼ŒåŒå­¦ä¸æ‰£å‡ ï¼ˆå¾…æ·»åŠ å°ç»„ç§¯åˆ†æ¶ˆè´¹è®°å½•ï¼‰
-->
  <body>
    <!-- å¤´éƒ¨åŒºåŸŸ -->
    <header>
      <div class="wrap">
        <div class="hero">
          <div class="brand">
            <div class="logo" id="logo">ğŸƒ</div>
            <div style="display: flex; align-items: center; gap: 8px">
              <h1 class="title" id="systemTitle">ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</h1>
              <button class="btn btn-sm" id="editTitleBtn" title="ä¿®æ”¹ç³»ç»Ÿåç§°">
                <i class="fas fa-pencil"></i>
              </button>
            </div>

            <div class="sun"></div>
            <div id="sun" class="btn flat">å±•å¼€</div>
          </div>
          <div class="bubble_classList">
            <div>
              <div class="bubble" id="systemSlogan">
                åœ¨è¿™é‡Œï¼Œç§¯åˆ†è®°å½•æ¯ä¸€æ¬¡æˆé•¿ ğŸ†
              </div>
              <button
                class="btn btn-sm"
                id="editSloganBtn"
                title="ä¿®æ”¹ç³»ç»Ÿåç§°"
              >
                <i class="fas fa-pencil"></i>
              </button>
            </div>
            <div>
              <div
                class="classList btn primary"
                id="switchClasses"
                onclick="concatAdmin()"
              >
                è”ç³»ç®¡ç†å‘˜
              </div>
              <div
                class="classList btn flat"
                id="switchClasses"
                onclick="switchClasses('add')"
              >
                ç­çº§ç®¡ç†
              </div>
              <div
                class="classList btn warn"
                id="switchClasses"
                onclick="switchClasses('dle')"
              >
                åˆ é™¤ç­çº§
              </div>
            </div>
            <!-- åˆ‡æ¢ç­çº§ -->
          </div>
          <!-- å­¦ç”Ÿç®¡ç†å·¥å…·æ  -->
          <div class="toolbar-row">
            <textarea
              id="studentNames"
              class="form-control"
              placeholder="è¾“å…¥å­¦ç”Ÿå§“åï¼Œæ¯è¡Œä¸€ä¸ªå­¦ç”Ÿå§“åï¼Œå›è½¦åˆ†éš”"
              style="min-width: 200px"
              rows="4"
            ></textarea>
            <div style="display: flex; gap: 10px">
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  background: #fff;
                  padding: 6px 12px;
                  border-radius: 20px;
                  border: 2px solid var(--line);
                "
              >
                <input type="radio" name="gender" value="male" checked /> ç”·ç”Ÿ
              </label>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  background: #fff;
                  padding: 6px 12px;
                  border-radius: 20px;
                  border: 2px solid var(--line);
                "
              >
                <input type="radio" name="gender" value="female" /> å¥³ç”Ÿ
              </label>
            </div>
            <button class="btn ok" id="addStudentBtn">
              <i class="fas fa-plus"></i> æ·»åŠ å­¦ç”Ÿ
            </button>

            <button class="btn ok" id="addStudentBtnFile">
              <i class="fas fa-upload"></i> å¯¼å…¥å­¦ç”Ÿæ•°æ®
            </button>
            <input
              type="file"
              id="studentFileInput"
              style="display: none"
              accept=".csv, .xlsx, .xls"
            />
            <button class="btn ok" id="downloadBtnFile">
              <i class="fas fa-download"></i> å¯¼å‡ºå­¦ç”Ÿæ•°æ®
            </button>
          </div>

          <!-- åŠŸèƒ½æŒ‰é’®ç»„ -->
          <div class="header-controls">
            <button class="btn primary" id="randomRollCallBtn">
              <i class="fas fa-dice"></i> éšæœºç‚¹å
            </button>
            <button class="btn flat" id="timerBtn">
              <i class="fas fa-stopwatch"></i> è®¡æ—¶å™¨
            </button>
            <!-- <button class="btn ghost" id="themeToggle"><i class="fas fa-palette"></i> æ›´æ¢ä¸»é¢˜</button> -->
            <button class="btn secondary" id="exportDataBtn">
              <i class="fas fa-download"></i> å¯¼å‡ºç­çº§æ•°æ®
            </button>
            <button class="btn ghost" id="importDataBtn">
              <i class="fas fa-upload"></i> å¯¼å…¥ç­çº§æ•°æ®
            </button>
            <button class="btn warn" id="resetAllPoints">
              <i class="fas fa-eraser"></i> ç§¯åˆ†æ¸…é›¶
            </button>
            <button class="btn flat" id="passwordSettingsBtn">
              <i class="fas fa-lock"></i> å¯†ç è®¾ç½®
            </button>

            <button class="btn rule" id="integrationruleBtn">
              <i class="fas fa-list-check"></i> ç§¯åˆ†è§„åˆ™
            </button>

            <button class="btn rule" id="integralshoppingmallBtn">
              <i class="fas fa-store"></i> ç§¯åˆ†å•†åº—
            </button>

            <button class="btn mall" id="setsetAward">
              <i class="fas fa-store"></i> æŠ½å¥–è®¾ç½®
            </button>

            <button class="btn mall" onclick="openLottery()">
              <i class="fas fa-store"></i> å»æŠ½å¥–
            </button>

            <button class="btn warn" id="removeAll">
              <i class="fas fa-store"></i> æ¸…ç†ç¼“å­˜
            </button>
          </div>
        </div>
      </div>
      <div class="divider"></div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="wrap">
      <div class="layout">
        <!-- å·¦ä¾§ä¸»é¢æ¿ -->
        <main>
          <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="students">
              <i class="fas fa-user-graduate"></i> å­¦ç”Ÿç®¡ç†
            </button>
            <button class="tab-btn" data-tab="groups">
              <i class="fas fa-users"></i> å°ç»„ç®¡ç†
            </button>
          </div>

          <!-- å­¦ç”Ÿç®¡ç†æ ‡ç­¾é¡µ -->
          <div id="students" class="tab-content active">
            <!-- å·¥å…·æ  -->
            <div
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 16px;
                align-items: center;
              "
            >
              <div style="display: flex; gap: 4px; align-items: center">
                <input
                  type="text"
                  id="studentSearchInput"
                  class="form-control"
                  placeholder="æœç´¢å­¦ç”Ÿå§“å..."
                  style="max-width: 200px"
                />
                <button
                  class="btn primary btn-icon"
                  id="searchBtn"
                  title="æœç´¢"
                >
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <button class="btn ok" id="globalAddPoints">
                <i class="fas fa-plus"></i> å…¨å‘˜åŠ åˆ†
              </button>
              <button class="btn warn" id="globalSubtractPoints">
                <i class="fas fa-minus"></i> å…¨å‘˜å‡åˆ†
              </button>
              <button class="btn secondary" id="multiSelectMode">
                <i class="fas fa-check-double"></i> å¤šé€‰ç¼–è¾‘
              </button>
              <button
                class="btn ghost"
                id="exitMultiSelectMode"
                style="display: none"
              >
                <i class="fas fa-times"></i> é€€å‡ºå¤šé€‰
              </button>
              <!-- å¤šé€‰æ¨¡å¼æ“ä½œæŒ‰é’® -->
              <div
                id="multiSelectActions"
                style="display: none; align-items: center"
              >
                <div style="margin-right: 15px">
                  <button class="btn secondary" id="selectAll">
                    <i class="fas fa-check-double"></i> å…¨é€‰
                  </button>
                </div>

                <div
                  style="
                    display: block;
                    flex-wrap: wrap;
                    gap: 10px;
                    margin-bottom: 0px;
                    padding: 12px;
                    background: var(--light);
                    border-radius: 12px;
                    border: 2px solid var(--primary);
                  "
                >
                  <div
                    style="
                      color: var(--primary);
                      font-weight: 600;
                      width: 100%;
                      margin-bottom: 8px;
                    "
                  >
                    <i class="fas fa-info-circle"></i> å·²é€‰æ‹©
                    <span id="selectedCount">0</span> åå­¦ç”Ÿï¼Œè¯·é€‰æ‹©æ“ä½œï¼š
                  </div>
                  <button class="btn ok" id="multiSelectAdd">
                    <i class="fas fa-plus"></i> åŠ åˆ†
                  </button>
                  <button class="btn warn" id="multiSelectSubtract">
                    <i class="fas fa-minus"></i> å‡åˆ†
                  </button>
                  <button class="btn flat" id="multiSelectDelete">
                    <i class="fas fa-trash"></i> åˆ é™¤å­¦ç”Ÿ
                  </button>
                </div>
              </div>
            </div>

            <!-- å­¦ç”Ÿå¡ç‰‡åˆ—è¡¨ -->
            <div id="allStudents" class="student-list dropzone"></div>
          </div>

          <!-- å°ç»„ç®¡ç†æ ‡ç­¾é¡µ -->
          <div id="groups" class="tab-content">
            <!-- å°ç»„åˆ›å»º -->
            <div
              style="
                display: flex;
                gap: 12px;
                margin-bottom: 20px;
                align-items: center;
              "
            >
              <input
                type="text"
                id="groupName"
                class="form-control"
                placeholder="è¾“å…¥å°ç»„åç§°"
                style="max-width: 200px"
              />
              <button id="addGroupBtn" class="btn ok">
                <i class="fas fa-plus"></i> æ·»åŠ å°ç»„
              </button>
            </div>

            <!-- å°ç»„åˆ—è¡¨ -->
            <div id="groupsArea"></div>
          </div>
        </main>

        <!-- å³ä¾§é¢æ¿ -->
        <aside class="side">
          <div class="rank-tabs">
            <button class="btn" onclick="showRankModal('day')">æ—¥æ¦œ</button>
            <button class="btn" onclick="showRankModal('week')">å‘¨æ¦œ</button>
            <button class="btn" onclick="showRankModal('month')">æœˆæ¦œ</button>
            <button class="btn" onclick="showRankModal('year')">å¹´æ¦œ</button>
          </div>
          <!-- ä¸ªäººæ’è¡Œæ¦œ -->
          <div class="panel">
            <h4><i class="fas fa-medal"></i> ä¸ªäººæ’è¡Œæ¦œ</h4>
            <div id="studentLeaderboardList" class="leaderboard-list"></div>
          </div>

          <!-- å°ç»„æ’è¡Œæ¦œ -->
          <div class="panel">
            <h4><i class="fas fa-users"></i> å°ç»„æ’è¡Œæ¦œ</h4>
            <div id="groupLeaderboardList" class="leaderboard-list"></div>
          </div>

          <!-- ç§¯åˆ†è§„åˆ™ -->
          <!-- <div class="panel">
            <h4><i class="fas fa-list-check"></i> ç§¯åˆ†è§„åˆ™</h4>
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="ruleName"
                class="form-control"
                placeholder="è§„åˆ™åç§°"
                style="flex: 1"
              />
              <input
                type="number"
                id="rulePoints"
                class="form-control"
                placeholder="åˆ†å€¼"
                style="width: 80px"
              />
              <button id="addRuleBtn" class="btn primary" style="padding: 8px">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              id="rulesList"
              style="max-height: 200px; overflow-y: auto"
            ></div>
          </div> -->

          <!-- ç§¯åˆ†å•†åº— -->
          <!-- <div class="panel">
            <h4><i class="fas fa-store"></i> ç§¯åˆ†å•†åº—</h4>
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="itemName"
                class="form-control"
                placeholder="å•†å“åç§°"
                style="flex: 1"
              />
              <input
                type="number"
                id="itemCost"
                class="form-control"
                placeholder="ç§¯åˆ†"
                style="width: 80px"
              />
              <button id="addItemBtn" class="btn primary" style="padding: 8px">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              id="shopItems"
              style="max-height: 200px; overflow-y: auto"
            ></div>
          </div> -->
        </aside>
      </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">æ“ä½œ</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body" id="modalContent"></div>
      </div>
    </div>

    <!-- éšæœºç‚¹åæ¨¡æ€æ¡† -->
    <div id="rollCallModal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-header">
          <h3 class="modal-title">éšæœºç‚¹å</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div
            id="rollCallStudentList"
            style="
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
              gap: 16px;
              padding: 20px;
              min-height: 300px;
              align-items: center;
            "
          ></div>
        </div>
        <div class="modal-footer">
          <label>æŠ½å–äººæ•°:</label>
          <select
            id="rollCallCount"
            style="width: auto; margin-left: 8px; margin-right: 16px"
          ></select>
          <button id="startRollCallBtn" class="btn primary">
            <i class="fas fa-play"></i> å¼€å§‹
          </button>
          <button
            id="resetRollCallBtn"
            class="btn secondary"
            style="display: none"
          >
            <i class="fas fa-redo"></i> é‡æ¥
          </button>
        </div>
      </div>
    </div>

    <!-- æ•°æ®å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">å¯¼å…¥æ•°æ®</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="import-help">
            æ”¯æŒ <strong>JSON</strong>ã€<strong>text</strong>
          </div>
          <div style="display: flex; gap: 12px; margin-bottom: 16px">
            <input
              type="file"
              id="importFile"
              accept=".json,.txt"
              class="form-control"
            />
            <button type="button" id="parseFileBtn" class="btn primary">
              è¯»å–æ–‡ä»¶
            </button>
          </div>
          <textarea
            id="importText"
            class="form-control"
            rows="8"
            placeholder="æˆ–åœ¨æ­¤ç²˜è´´â€¦ï¼ˆExcelå¤åˆ¶çš„è¡¨æ ¼ä¼šä»¥TSVæ ¼å¼ç²˜è´´ï¼‰"
            style="margin-bottom: 16px"
          ></textarea>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('importModal')"
          >
            å–æ¶ˆ
          </button>
          <button type="button" id="parseTextBtn" class="btn ok">
            è§£æå¹¶å¯¼å…¥
          </button>
        </div>
      </div>
    </div>
    <!-- è®¡æ—¶å™¨æ¨¡æ€æ¡† -->
    <div id="timerModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">è®¡æ—¶å™¨</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center; padding: 30px 0">
          <div
            id="timerDisplay"
            style="
              font-size: 48px;
              font-weight: bold;
              margin: 20px 0;
              color: var(--text);
            "
          >
            00:00:00
          </div>
          <div
            style="
              display: flex;
              justify-content: center;
              gap: 15px;
              margin-top: 30px;
            "
          >
            <div style="text-align: center; margin: 0 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  font-size: 14px;
                  color: var(--text-light);
                "
                >å°æ—¶</label
              >
              <input
                type="number"
                id="timerHours"
                class="form-control"
                value="0"
                min="0"
                max="23"
                style="width: 80px; text-align: center"
              />
            </div>
            <div style="text-align: center; margin: 0 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  font-size: 14px;
                  color: var(--text-light);
                "
                >åˆ†é’Ÿ</label
              >
              <input
                type="number"
                id="timerMinutes"
                class="form-control"
                value="0"
                min="0"
                max="59"
                style="width: 80px; text-align: center"
              />
            </div>
            <div style="text-align: center; margin: 0 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  font-size: 14px;
                  color: var(--text-light);
                "
                >ç§’é’Ÿ</label
              >
              <input
                type="number"
                id="timerSeconds"
                class="form-control"
                value="10"
                min="0"
                max="59"
                style="width: 80px; text-align: center"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="startTimerBtn" class="btn ok">
            <i class="fas fa-play"></i> å¼€å§‹
          </button>
          <button
            id="pauseTimerBtn"
            class="btn secondary"
            style="display: none"
          >
            <i class="fas fa-pause"></i> æš‚åœ
          </button>
          <button id="resetTimerBtn" class="btn ghost">
            <i class="fas fa-redo"></i> é‡ç½®
          </button>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ å¯†ç éªŒè¯æ¨¡æ€æ¡† -->
    <div
      id="passwordVerifyModal"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background-color: rgba(0, 0, 0, 0.5);
      "
    >
      <!-- é®ç½©å®¹å™¨ï¼Œç”¨äºå±…ä¸­æ¨¡æ€æ¡†å†…å®¹ -->
      <div
        style="
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100%;
        "
      >
        <div
          class="modal-content"
          style="
            max-width: 400px;
            width: 100%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
          "
        >
          <div
            class="modal-header"
            style="padding: 16px; border-bottom: 1px solid #eee"
          >
            <h3
              class="modal-title"
              style="margin: 0; font-size: 1.2rem; color: #333"
            >
              è¯·è¾“å…¥å¯†ç 
            </h3>
          </div>
          <div class="modal-body" style="padding: 20px">
            <p style="margin: 0 0 16px 0; color: #666">
              è¯¥ç³»ç»Ÿå·²è®¾ç½®å¯†ç ä¿æŠ¤ï¼Œè¯·è¾“å…¥å¯†ç è®¿é—®
            </p>
            <input
              type="password"
              id="verifyPassword"
              class="form-control"
              placeholder="è¯·è¾“å…¥å¯†ç "
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                margin-top: 16px;
                box-sizing: border-box;
              "
            />
            <div
              style="color: var(--warn); margin-top: 8px; display: none"
              id="passwordError"
            >
              å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥
            </div>
          </div>
          <div
            class="modal-footer"
            style="padding: 16px; border-top: 1px solid #eee; text-align: right"
          >
            <button
              type="button"
              id="forgetPasswordBtn"
              class="btn warn"
              style="
                padding: 8px 16px;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              å¿˜è®°å¯†ç 
            </button>
            <button
              type="button"
              id="submitPasswordBtn"
              class="btn ok"
              style="
                padding: 8px 16px;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              ç¡®è®¤
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ å¯†ç éªŒè¯æ¨¡æ€æ¡† -->
    <div
      id="forgetPasswordModal"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background-color: rgba(0, 0, 0, 0.5);
      "
    >
      <!-- é®ç½©å®¹å™¨ï¼Œç”¨äºå±…ä¸­æ¨¡æ€æ¡†å†…å®¹ -->
      <div
        style="
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100%;
        "
      >
        <div
          class="modal-content"
          style="
            max-width: 400px;
            width: 100%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
          "
        >
          <div
            class="modal-header"
            style="padding: 16px; border-bottom: 1px solid #eee"
          >
            <h3
              class="modal-title"
              style="margin: 0; font-size: 1.2rem; color: #333"
            >
              è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥
            </h3>
          </div>
          <div class="modal-body" style="padding: 20px">
            <p style="margin: 0 0 16px 0; color: #666">
              è¾“å…¥ç®¡ç†å‘˜å¯†é’¥ï¼Œä»¥æ¸…é™¤å¯†ç 
            </p>
            <input
              type="password"
              id="verifykey"
              class="form-control"
              placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥"
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                margin-top: 16px;
                box-sizing: border-box;
              "
            />
            <div
              style="color: var(--warn); margin-top: 8px; display: none"
              id="passwordError2"
            >
              å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥
            </div>
          </div>
          <div
            class="modal-footer"
            style="padding: 16px; border-top: 1px solid #eee; text-align: right"
          >
            <button
              type="button"
              id="backPasswordBtn"
              class="btn flat"
              style="
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              è¿”å›
            </button>
            <button
              type="button"
              id="removetPasswordBtn"
              class="btn ok"
              style="
                padding: 8px 16px;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              ç¡®è®¤
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ å¯†ç è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="passwordSettingsModal" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <div class="modal-header">
          <h3 class="modal-title">å¯†ç è®¾ç½®</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div
            id="currentPasswordSection"
            style="display: none; margin-bottom: 16px"
          >
            <label style="display: block; margin-bottom: 8px">å½“å‰å¯†ç </label>
            <input
              type="password"
              id="currentPassword"
              class="form-control"
              placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
            />
            <div
              style="color: var(--warn); margin-top: 8px; display: none"
              id="currentPasswordError"
            >
              å½“å‰å¯†ç é”™è¯¯
            </div>
          </div>

          <div style="margin-bottom: 16px">
            <label style="display: block; margin-bottom: 8px">æ–°å¯†ç </label>
            <input
              type="password"
              id="newPassword"
              class="form-control"
              placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
            />
          </div>

          <div>
            <label style="display: block; margin-bottom: 8px">ç¡®è®¤æ–°å¯†ç </label>
            <input
              type="password"
              id="confirmPassword"
              class="form-control"
              placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
            />
            <div
              style="color: var(--warn); margin-top: 8px; display: none"
              id="passwordMismatch"
            >
              ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´
            </div>
          </div>

          <div style="margin-top: 20px">
            <button id="clearPasswordBtn" class="btn warn" style="width: 100%">
              <i class="fas fa-unlock"></i> æ¸…é™¤å¯†ç 
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('passwordSettingsModal')"
          >
            å–æ¶ˆ
          </button>
          <button type="button" id="savePasswordBtn" class="btn ok">
            ä¿å­˜å¯†ç 
          </button>
        </div>
      </div>
    </div>
    <!-- ç§¯åˆ†è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="ruleSettingsModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h4><i class="fas fa-list-check"></i> ç§¯åˆ†è§„åˆ™</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="ruleName"
                class="form-control"
                placeholder="è§„åˆ™åç§°"
                style="flex: 1"
              />
              <input
                type="number"
                id="rulePoints"
                class="form-control"
                placeholder="åˆ†å€¼"
                style="width: 80px"
              />
              <button id="addRuleBtn" class="btn primary" style="padding: 8px">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              id="rulesList"
              style="max-height: 300px; overflow-y: auto"
            ></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('ruleSettingsModal')"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- ç§¯åˆ†å•†åº—æ¨¡æ€æ¡† -->
    <div id="mallSettingsModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> ç§¯åˆ†å•†åº—</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="itemName"
                class="form-control"
                placeholder="å•†å“åç§°"
                style="flex: 1"
              />
              <input
                type="number"
                id="itemStock"
                class="form-control"
                placeholder="åº“å­˜"
                style="width: 80px"
              />
              <input
                type="number"
                id="itemCost"
                class="form-control"
                placeholder="ç§¯åˆ†"
                style="width: 80px"
              />
              <button id="addItemBtn" class="btn primary" style="padding: 8px">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              id="shopItems"
              style="max-height: 400px; overflow-y: auto"
            ></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('mallSettingsModal')"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!--æŠ½å¥–è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="setsetAwardModal" class="modal">
      <div class="modal-content" style="max-width: 600px; text-align: center">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> æŠ½å¥–è®¾ç½®</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="awardName"
                class="form-control"
                placeholder="å¥–å“åç§°"
                style="flex: 1"
              />
              <button id="addAwardBtn" class="btn primary" style="padding: 8px">
                æ·»åŠ 
              </button>
            </div>
            <div
              id="awardList"
              style="max-height: 400px; overflow-y: auto"
            ></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('setsetAwardModal')"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- ç¼–è¾‘è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="editRuleModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> ç¼–è¾‘ç§¯åˆ†è§„åˆ™</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="edititemName"
                class="form-control"
                placeholder="å•†å“åç§°"
                style="flex: 1"
              />

              <input
                type="number"
                id="edititemCost"
                class="form-control"
                placeholder="ç§¯åˆ†"
                style="width: 80px"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('editRuleModal')"
          >
            å…³é—­
          </button>
          <button type="button" class="btn flat" id="editRulebtn">ç¡®å®š</button>
        </div>
      </div>
    </div>

    <!-- ç¼–è¾‘å•†åº—å•å“æ¨¡æ€æ¡† -->
    <div id="editStoreModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> ç¼–è¾‘å•†å“</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <div style="flex: 1">
                <p style="margin: 0 0 5px 5px; color: #999; font-size: 14px">
                  å•†å“åç§°
                </p>
                <input
                  type="text"
                  id="editStoreName"
                  class="form-control"
                  placeholder="å•†å“åç§°"
                  style="flex: 1"
                />
              </div>
              <div>
                <p style="margin: 0 0 5px 5px; color: #999; font-size: 14px">
                  åº“å­˜
                </p>
                <input
                  type="number"
                  id="editStoreStock"
                  class="form-control"
                  placeholder="åº“å­˜"
                  style="width: 80px"
                />
              </div>
              <div>
                <p style="margin: 0 0 5px 5px; color: #999; font-size: 14px">
                  ç§¯åˆ†
                </p>
                <input
                  type="number"
                  id="editStoreCost"
                  class="form-control"
                  placeholder="ç§¯åˆ†"
                  style="width: 80px"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('editStoreModal')"
          >
            å…³é—­
          </button>
          <button type="button" class="btn flat" id="editStoreItemBtn">
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>

    <!-- ä¹å®«æ ¼æŠ½å¥–æ¨¡æ€æ¡† -->
    <div class="modal" id="lotteryModal">
      <div class="modal-content" style="text-align: center">
        <div class="modal-header">
          <h2 class="modal-title">ğŸ‰ ä¹å®«æ ¼æŠ½å¥–</h2>
          <button class="close">&times;</button>
        </div>
        <!-- ä¹å®«æ ¼æŠ½å¥–åŒºåŸŸ -->
        <div class="lottery-container">
          <div class="lottery-grid" id="lotteryGrid">
            <!-- ä¹å®«æ ¼ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>

        <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
        <div class="result" id="result">
          ç‚¹å‡»ä¹å®«æ ¼ä¸­å¤®çš„"å¼€å§‹"æŒ‰é’®å¼€å§‹æŠ½å¥–ï¼ğŸ€
        </div>
      </div>
    </div>

    <!-- // è”ç³»ç®¡ç†å‘˜ -->
    <!--æŠ½å¥–è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="contactAdminModal" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> ç®¡ç†å‘˜ä¿¡æ¯</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div
            class="panel panel_rule"
            style="color: #2d5a47; font-weight: 700; font-size: 18px"
          >
            <div style="margin-bottom: 10px">å°çº¢ä¹¦ï¼šèµ›å°”å·å•Š</div>

            <div style="margin-bottom: 10px">id/å¾®ä¿¡ï¼šLidddd1122</div>

            <button type="button" class="btn flat" onclick="copyUrl()">
              å¤åˆ¶åº—é“ºé“¾æ¥
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('contactAdminModal')"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>
    <!-- ç‰ˆæƒä¿¡æ¯ -->
    <div class="copyright">
      èµ›å°”å· ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ - æ•´åˆå¢å¼ºç‰ˆ Â© 2025 | åŠŸèƒ½å®Œå–„ï¼Œæ“ä½œä¾¿æ·
    </div>

    <!-- å·¥å…·æç¤º -->
    <div id="tooltip" class="tooltip"></div>

    <script>
      const secretKey = "Xy7kL9mN";
      // =================================================================
      // å…¨å±€å˜é‡å’Œæ•°æ®ç»“æ„
      // =================================================================
      let classObj = {
        id: 1001,
        name: "ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ",
        title: "åœ¨è¿™é‡Œï¼Œç§¯åˆ†è®°å½•æ¯ä¸€æ¬¡æˆé•¿ ğŸ†",
      };
      let students = [];
      let groups = [];
      let rules = [
        { id: generateId(), name: "å›ç­”é—®é¢˜æ­£ç¡®", points: 1 },
        { id: generateId(), name: "è®¤çœŸå®Œæˆä½œä¸š", points: 2 },
        { id: generateId(), name: "å¸®åŠ©åŒå­¦", points: 3 },
        { id: generateId(), name: "è¯¾å ‚è¡¨ç°ä¼˜ç§€", points: 5 },
        { id: generateId(), name: "æ¯”èµ›è·å¥–", points: 10 },
        { id: generateId(), name: "æ‰°ä¹±è¯¾å ‚", points: -2 },
        { id: generateId(), name: "ä½œä¸šä¸å®Œæ•´", points: -1 },
        { id: generateId(), name: "è¿Ÿåˆ°", points: -1 },
        { id: generateId(), name: "ä¸å°Šé‡ä»–äºº", points: -3 },
      ];
      let shopItems = [];
      let isMultiSelectMode = false;
      let multiSelectedStudentIds = new Set();
      let rollCallInterval = null;
      let awardList = [
        { id: generateId(), name: "ç¬”è®°æœ¬" },
        { id: generateId(), name: "åœ†ç ç¬”" },
        { id: generateId(), name: "é“…ç¬”" },
        { id: generateId(), name: "æ°´å½©ç¬”" },
      ];
      // =================================================================
      // å·¥å…·å‡½æ•°
      // =================================================================

      function generateId() {
        return Date.now() + Math.floor(Math.random() * 10000);
      }
      // è·å–å­—ç¬¦ä¸²çš„å­—èŠ‚é•¿åº¦
      function getByteLength(str) {
        // ä½¿ç”¨ encodeURIComponent æ¥è·å–æ¥è¿‘çœŸå®å­—èŠ‚é•¿åº¦çš„ç»“æœ
        // è¿™ç§æ–¹æ³•è™½ç„¶ä¸æ˜¯æœ€å‡†ç¡®çš„ï¼Œä½†å¯ä»¥ä½œä¸ºä¸€ä¸ªè¿‘ä¼¼å€¼
        return encodeURIComponent(str).replace(/%../g, "x").length;
      }
      // è®¡ç®— æœ¬åœ°å­˜å‚¨å¤§å°
      function calculateLocalStorageSize() {
        let totalLength = 0;
        // éå† localStorage çš„æ‰€æœ‰é”®
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          // è®¡ç®—é”®å’Œå€¼çš„æ€»é•¿åº¦
          totalLength += getByteLength(key) + getByteLength(value);
        }
        return (totalLength / (1024 * 1024)).toFixed(2) + "M";
      }
      function saveAllData() {
        let dataList = JSON.parse(localStorage.getItem("classPointsData"));
        const currentClass = JSON.parse(localStorage.getItem("classObj"));
        classObj = currentClass;
        try {
          const data = {
            classId: currentClass.id,
            systemTitle: systemTitle, // ä¿å­˜ç³»ç»Ÿæ ‡é¢˜
            systemSlogan: systemSlogan, // ä¿å­˜ç³»ç»Ÿæ ‡è¯­
            students: students,
            groups: groups,
            rules: rules,
            shopItems: shopItems,
            awardList: awardList,

            timestamp: new Date().toISOString(),
          };

          console.log("data -->", data);

          if (!dataList || !dataList.length) {
            dataList = [data];
          } else {
            dataList.forEach((i) => {
              if (i.classId == currentClass.id) {
                i.systemTitle = data.systemTitle;
                i.systemSlogan = data.systemSlogan;
                i.students = data.students;
                i.groups = data.groups;
                i.rules = data.rules;
                i.shopItems = data.shopItems;
                i.timestamp = data.timestamp;
                i.awardList = data.awardList;
              }
            });
          }

          localStorage.setItem("classPointsData", JSON.stringify(dataList));
          localStorage.setItem("classObj", JSON.stringify(currentClass));
        } catch (error) {
          console.error("ä¿å­˜æ•°æ®å¤±è´¥:", error);
          alert("ä¿å­˜æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨æƒé™");
        }

        const size = calculateLocalStorageSize();
      }

      function loadAllData() {
        try {
          const class_obj = JSON.parse(localStorage.getItem("classObj"));
          const savedData = localStorage.getItem("classPointsData");

          if (savedData) {
            const data = JSON.parse(savedData).find((i) => {
              return class_obj.id == i.classId;
            });
            classId = class_obj?.id || 1001;
            students = data?.students || [];
            groups = data?.groups || [];
            rules = data?.rules || rules; // ä¿ç•™é»˜è®¤è§„åˆ™å¦‚æœæ²¡æœ‰ä¿å­˜çš„
            shopItems = data?.shopItems || [];
            awardList = data?.awardList || [];

            if (data?.systemTitle) {
              systemTitle = data.systemTitle;
              document.getElementById("systemTitle").textContent = systemTitle;
            }

            // è¯»å–ç³»ç»Ÿæ ‡è¯­
            if (data.systemSlogan) {
              systemSlogan = data.systemSlogan;
              document.getElementById("systemSlogan").textContent =
                systemSlogan;
            }
            console.log("ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®æˆåŠŸ");
          } else {
            students = [];
            groups = [];
            rules = rules; // ä¿ç•™é»˜è®¤è§„åˆ™å¦‚æœæ²¡æœ‰ä¿å­˜çš„
            shopItems = [];
            awardList = awardList;
            console.log("æœªæ‰¾åˆ°æœ¬åœ°å­˜å‚¨æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®");
            document.getElementById("systemTitle").textContent =
              "ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ";
            document.getElementById("systemSlogan").textContent =
              "åœ¨è¿™é‡Œï¼Œç§¯åˆ†è®°å½•æ¯ä¸€æ¬¡æˆé•¿ ğŸ†";
            localStorage.setItem("classObj", JSON.stringify(classObj));
          }
        } catch (error) {
          console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
          console.log("ä½¿ç”¨é»˜è®¤æ•°æ®");
        }
      }
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      function showModal(modalId) {
        document.getElementById(modalId).style.display = "block";
      }

      async function copyUrl() {
        console.log("222 -->", 222);
        const url =
          "https://www.xiaohongshu.com/user/profile/5bd082ba6d27b5000148a5db?tab=goods&channelType=share_outside&xhsshare=CopyLink&shareRedId=N0hGMDs3Rko8Szc5Sz0wNjY0PT9FOkpL&apptime=1757767218&share_id=05cdf3e03a7449d0932ccafec4764f6e";
        navigator.clipboard.writeText(url);
        alert("å¤åˆ¶æˆåŠŸ");
      }

      // =================================================================
      // å­¦ç”Ÿç®¡ç†åŠŸèƒ½
      // =================================================================

      function addStudent() {
        const namesText = document.getElementById("studentNames").value.trim();
        const gender = document.querySelector(
          'input[name="gender"]:checked'
        ).value;

        if (!namesText) return alert("è¯·è¾“å…¥å­¦ç”Ÿå§“å");

        const names = namesText
          .split("\n")
          .filter((name) => name.trim() !== "");

        names.forEach((name) => {
          const student = {
            id: generateId(),
            name: name.trim(),
            gender: gender,
            avatar: null,
            totalPoints: 0,
            usedPoints: 0,
            history: [],
            groupId: null,
          };
          students.push(student);
        });
        document.getElementById("studentNames").value = "";
        saveAllData();
        updateUI();
      }

      function deleteStudent(studentId) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥å­¦ç”Ÿå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼")) return;

        students = students.filter((s) => s.id !== studentId);
        saveAllData();
        updateUI();
      }

      function updateStudentName(studentId, newName) {
        const trimmedName = newName.trim();
        if (!trimmedName) {
          alert("å­¦ç”Ÿå§“åä¸èƒ½ä¸ºç©º");
          updateUI(); // é‡æ–°æ¸²æŸ“ä»¥æ¢å¤åŸåç§°
          return;
        }

        // æ£€æŸ¥å§“åæ˜¯å¦é‡å¤
        const existingStudent = students.find(
          (s) => s.id !== studentId && s.name === trimmedName
        );
        if (existingStudent) {
          alert("è¯¥å§“åå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–å§“å");
          updateUI(); // é‡æ–°æ¸²æŸ“ä»¥æ¢å¤åŸåç§°
          return;
        }

        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex !== -1) {
          students[studentIndex].name = trimmedName;
          console.log("students[studentIndex] -->", students[studentIndex]);
          saveAllData();
          updateUI();
        }
      }

      function uploadAvatar(studentId) {
        const fileInput = document.getElementById(`avatarInput_${studentId}`);
        if (fileInput) {
          fileInput.click();
        }
      }

      function handleAvatarUpload(studentId, fileInput) {
        const file = fileInput.files[0];
        if (!file) return;

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith("image/")) {
          alert("è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶");
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º2MB)
        if (file.size > 2 * 1024 * 1024) {
          alert("å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡2MB");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const studentIndex = students.findIndex((s) => s.id === studentId);
          if (studentIndex !== -1) {
            students[studentIndex].avatar = e.target.result;
            saveAllData();
            updateUI();
          }
        };
        reader.readAsDataURL(file);

        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
        fileInput.value = "";
      }

      function createStudentCard(student) {
        const card = document.createElement("div");
        card.className = `student-card ${student.gender}`;
        card.setAttribute("data-id", student.id);
        card.draggable = true;

        const availablePoints = student.totalPoints - student.usedPoints;
        const isChecked = multiSelectedStudentIds.has(student.id);

        card.innerHTML = `
        <input type="checkbox" class="multi-select-checkbox" data-id="${
          student.id
        }" ${isChecked ? "checked" : ""}>
        
        <!-- å³ä¸Šè§’ç§¯åˆ†æ˜¾ç¤º -->
        <div style="position: absolute; top: 8px; right: 8px; text-align: right; font-size: 11px; line-height: 1.2; z-index: 10;">
          <div style="background: var(--primary); color: #2d5a47; padding: 2px 6px; border-radius: 8px; margin-bottom: 2px; font-weight: 800;">
            ${student.totalPoints}æ€»
          </div>
          <div style="background: var(--ok); color: #194f19; padding: 2px 6px; border-radius: 8px; font-weight: 800;">
            ${availablePoints}å¯ç”¨
          </div>
        </div>

        <!-- å¤´åƒå’Œå§“åæ°´å¹³æ’åˆ— -->
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <!-- å¤´åƒåŒºåŸŸ -->
          <div class="student-avatar ${student.gender}" onclick="uploadAvatar(${
          student.id
        })" title="ç‚¹å‡»ä¸Šä¼ å¤´åƒ" style="margin: 0; flex-shrink: 0;">
            ${
              student.avatar
                ? `<img src="${student.avatar}" alt="${student.name}">`
                : student.name.charAt(0)
            }
            <div style="position: absolute; bottom: -2px; right: -2px; width: 16px; height: 16px; background: var(--accent1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 2px solid #fff;">
              <i class="fas fa-camera"></i>
            </div>
          </div>

          <!-- å§“ååŒºåŸŸ -->
          <div style="flex: 1;">
            <input type="text" value="${student.name}" 
                   class="student-name-input"
                   style="font-weight: 800; font-size: 16px; border: 1px solid transparent; background: transparent; padding: 4px 6px; border-radius: 4px; width: 100%; color: var(--text);"
                   onblur="updateStudentName(${student.id}, this.value)" 
                   onkeypress="if(event.key==='Enter') this.blur()"
                   onfocus="this.style.border='1px solid var(--primary)'; this.style.background='#fff'"
                   onblur="this.style.border='1px solid transparent'; this.style.background='transparent'"
                   title="ç‚¹å‡»ç¼–è¾‘å§“å">
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="student-controls">
          <button class="control-btn plus-btn" onclick="showPointsModal(${
            student.id
          }, 'add')" title="åŠ åˆ†">+</button>
          <button class="control-btn minus-btn" onclick="showPointsModal(${
            student.id
          }, 'subtract')" title="å‡åˆ†">-</button>
          <button class="control-btn history-btn" onclick="showHistoryModal(${
            student.id
          }, 'no')" title="æŸ¥çœ‹å†å²">ğŸ“‹è®°å½•</button>
          
          
          <button class="control-btn delete-btn" onclick="deleteStudent(${
            student.id
          })" title="åˆ é™¤å­¦ç”Ÿ">ğŸ—‘ï¸åˆ é™¤</button>
        <button class="control-btn " onclick="showHistoryModal(${
          student.id
        },'yes')" title="åˆ†æ•°æ’¤å›">âš™ï¸æ’¤å›</button>

          <button class="control-btn shop-btn color:"" onclick="showShopModal(${
            student.id
          })" title="ç§¯åˆ†å•†åº—">ğŸ›’å•†åº—</button>
          </div>


        <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡† -->
        <input type="file" id="avatarInput_${
          student.id
        }" accept="image/*" style="display: none;" onchange="handleAvatarUpload(${
          student.id
        }, this)">
      `;

        // æ·»åŠ å¤šé€‰åŠŸèƒ½
        const checkbox = card.querySelector(".multi-select-checkbox");
        if (checkbox) {
          checkbox.addEventListener("change", function (e) {
            e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
            if (this.checked) {
              multiSelectedStudentIds.add(student.id);
            } else {
              multiSelectedStudentIds.delete(student.id);
            }
            updateSelectedCount();
          });
        }

        // // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
        // card.addEventListener("dragstart", function (e) {
        //   console.log("e -->", e);
        //   e.dataTransfer.setData("text/plain", student.id);
        // });

        return card;
      }

      // =================================================================
      // ç§¯åˆ†ç®¡ç†åŠŸèƒ½
      // =================================================================

      function showPointsModal(studentId, type = null) {
        const student = students.find((s) => s.id === studentId);
        if (!student) return;

        const modalContent = document.getElementById("modalContent");
        let title =
          type === "add"
            ? `åŠ åˆ†ï¼š${student.name}`
            : type === "subtract"
            ? `å‡åˆ†ï¼š${student.name}`
            : `åŠ å‡åˆ†ï¼š${student.name}`;

        // æ ¹æ®ç±»å‹è¿‡æ»¤è§„åˆ™
        let filteredRules = rules;
        if (type === "add") {
          filteredRules = rules.filter((r) => r.points > 0);
        } else if (type === "subtract") {
          filteredRules = rules.filter((r) => r.points < 0);
        }

        let rulesHtml = "";
        filteredRules.forEach((rule) => {
          const sign = rule.points > 0 ? "+" : "";
          rulesHtml += `
          <div class="rule-option ${rule.points > 0 ? "positive" : "negative"}" 
               onclick="applyPoints(${student.id}, ${rule.points}, '${
            rule.name
          }')">
            <span>${rule.name}</span>
            <span>${sign}${rule.points}</span>
          </div>
        `;
        });

        modalContent.innerHTML = `
        <h3>${title}</h3>
        <div class="rules-options">
          ${rulesHtml || "<p>æ²¡æœ‰å¯ç”¨çš„è§„åˆ™</p>"}
        </div>
        <div style="margin-top: 20px;">
          <h4>è‡ªå®šä¹‰ç§¯åˆ†</h4>
          <div  style="display: flex;gap: 12px;margin: 12px 0;">
            <input type="number" id="customPoints" class="form-control" placeholder="åˆ†æ•°" style="width: 100px;">
            <input type="text" id="customReason" class="form-control" placeholder="åŸå› " style="flex: 1;">
            <button onclick="applyCustomPoints(${
              student.id
            })" class="btn primary">åº”ç”¨</button>
          </div>
        </div>
      `;

        showModal("modal");
      }

      function applyPoints(studentId, points, reason) {
        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex === -1) return;

        const groupId = students[studentIndex].groupId;
        const groupIndex = groups.findIndex((s) => s.id === groupId);

        console.log("students[studentIndex] -->", students[studentIndex]);
        students[studentIndex].totalPoints += points;
        students[studentIndex].history.push({
          date: new Date().toISOString(),
          points: points,
          reason: reason,
        });
        if (groupIndex != -1) {
          groups[groupIndex].history.push({
            date: new Date().toISOString(),
            points: points,
            reason: reason,
            title: `${students[studentIndex].name}  ${
              points > 0 ? "åŠ åˆ†" : "å‡åˆ†"
            }`,
          });
        }

        if (students[studentIndex].groupId) {
          const s = groups.find((i) => i.id == students[studentIndex].groupId);
          s.integral += points;
        }

        saveAllData();
        updateUI();

        closeModal("modal");
        // æ˜¾ç¤ºåŠ¨ç”»
        showPointAnimation(studentId, points);
      }

      function applyCustomPoints(studentId) {
        const points = parseInt(document.getElementById("customPoints").value);
        const reason =
          document.getElementById("customReason").value.trim() || "è‡ªå®šä¹‰";

        if (isNaN(points)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°");

        applyPoints(studentId, points, reason);
      }

      function showPointAnimation(studentId, points) {
        const studentCard = document.querySelector(
          `.student-card[data-id="${studentId}"]`
        );
        if (!studentCard) return;

        const animation = document.createElement("div");
        animation.className = `point-animation ${
          points > 0 ? "positive" : "negative"
        }`;
        animation.textContent = points > 0 ? `+${points}` : points;
        const rect = studentCard.getBoundingClientRect();

        // å…³é”®ï¼šå°†è§†å£åæ ‡è½¬æ¢ä¸ºæ–‡æ¡£ç»å¯¹åæ ‡
        const docLeft = rect.left + window.scrollX;
        const docTop = rect.top + window.scrollY;

        animation.style.left = `${docLeft - 20 + rect.width / 2}px`;
        animation.style.top = `${docTop - 25 + rect.height / 2}px`;
        console.log("studentCard -->", studentCard);
        // animation.style.left = `${rect.left}px`;
        // animation.style.top = `${rect.top}px`;
        console.log("rect -->", JSON.parse(JSON.stringify(rect)));
        document.body.appendChild(animation);
        console.log("animation -->", animation);
        // animation.addEventListener("animationend", function () {
        //   document.body.removeChild(animation);
        // });
      }
      // =================================================================
      // å†å²è®°å½•åŠŸèƒ½
      // =================================================================
      function showHistoryModal(studentId, flag) {
        const student = students.find((s) => s.id === studentId);
        const group = groups.find((s) => s.id === studentId);

        const modalContent = document.getElementById("modalContent");
        let historyHtml = "";
        if (student) {
          if (student.history && student.history.length > 0) {
            historyHtml = '<div style="max-height: 400px; overflow-y: auto;">';
            student.history
              .slice()
              .reverse()
              .forEach((record, index) => {
                const date = new Date(record.date).toLocaleString();
                const pointsClass = record.points > 0 ? "positive" : "negative";
                const sign = record.points > 0 ? "+" : "";
                const realIndex = student.history.length - 1 - index;

                if (flag === "yes") {
                  historyHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--light); border-radius: 8px; border-left: 4px solid ${
                      record.points > 0 ? "var(--ok)" : "var(--warn)"
                    };">
                      <div>
                        <div style="font-weight: 600;">${record.reason}</div>
                        <div style="font-size: 12px; color: var(--sub);">${date}</div>
                      </div>
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-weight: 800; font-size: 18px; color: ${
                          record.points > 0 ? "var(--ok)" : "var(--warn)"
                        };">${sign}${record.points}</span>
                        <button onclick="revertHistoryItem(${
                          student.id
                        }, ${realIndex})" class="btn-icon btn ghost" title="æ’¤å›æ­¤æ“ä½œ" style="width: 30px; height: 30px; padding: 0;">
                          <i class="fas fa-undo"></i>
                        </button>
                      </div>
                    </div>
                  `;
                } else {
                  historyHtml += `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--light); border-radius: 8px; border-left: 4px solid ${
                    record.points > 0 ? "var(--ok)" : "var(--warn)"
                  };">
                    <div>
                      <div style="font-weight: 600;">${record.reason}</div>
                      <div style="font-size: 12px; color: var(--sub);">${date}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <span style="font-weight: 800; font-size: 18px; color: ${
                        record.points > 0 ? "var(--ok)" : "var(--warn)"
                      };">${sign}${record.points}</span>
                    </div>
                  </div>
                `;
                }
              });
            historyHtml += "</div>";
          } else {
            historyHtml = "<p>æš‚æ— ç§¯åˆ†è®°å½•</p>";
          }

          modalContent.innerHTML = `
              <h3>${student.name} çš„ç§¯åˆ†å†å²</h3>
              ${historyHtml}
            `;
        } else if (group) {
          if (group.history && group.history.length > 0) {
            historyHtml = '<div style="max-height: 400px; overflow-y: auto;">';
            group.history
              .slice()
              .reverse()
              .forEach((record, index) => {
                const date = new Date(record.date).toLocaleString();
                const pointsClass = record.points > 0 ? "positive" : "negative";
                const sign = record.points > 0 ? "+" : "";
                const realIndex = group.history.length - 1 - index;

                historyHtml += `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--light); border-radius: 8px; border-left: 4px solid ${
                    record.points > 0 ? "var(--ok)" : "var(--warn)"
                  };">
                    <div>
                      <div style="font-weight: 600;">${record.reason} -- ${
                  record.title
                }</div>
                      <div style="font-size: 12px; color: var(--sub);">${date}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <span style="font-weight: 800; font-size: 18px; color: ${
                        record.points > 0 ? "var(--ok)" : "var(--warn)"
                      };">${sign}${record.points}</span>
                    </div>
                  </div>
                `;
              });
            historyHtml += "</div>";
          } else {
            historyHtml = "<p>æš‚æ— ç§¯åˆ†è®°å½•</p>";
          }

          modalContent.innerHTML = `
              <h3>${group.name} çš„ç§¯åˆ†å†å²</h3>
              ${historyHtml}
            `;
        }

        showModal("modal");
      }

      function revertHistoryItem(studentId, historyIndex) {
        if (!confirm("æ‚¨ç¡®å®šè¦æ’¤å›è¿™æ¡æ“ä½œå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;

        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex === -1) return;

        const student = students[studentIndex];
        const recordToRevert = student.history[historyIndex];

        if (!recordToRevert) return;

        // æ¢å¤åˆ†æ•°
        student.totalPoints -= recordToRevert.points;

        // å¦‚æœæ˜¯å•†å“å…‘æ¢ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        if (recordToRevert.reason.includes("å…‘æ¢å•†å“")) {
          const cost = Math.abs(recordToRevert.points);
          student.usedPoints -= cost;

          // è¿™é‡Œå¯ä»¥å¢åŠ æ¢å¤å•†å“åº“å­˜çš„é€»è¾‘
        }

        // ä»å†å²è®°å½•ä¸­ç§»é™¤è¯¥æ¡ç›®
        student.history.splice(historyIndex, 1);

        saveAllData();
        updateUI();
        showHistoryModal(studentId); // åˆ·æ–°å†å²æ¨¡æ€æ¡†
        alert("æ“ä½œå·²æˆåŠŸæ’¤å›ï¼");
      }

      // =================================================================
      // å•†åº—åŠŸèƒ½
      // =================================================================
      // å­¦ç”Ÿå•†åº—
      function showShopModal(studentId) {
        const student = students.find((s) => s.id === studentId);
        if (!student) return;

        const modalContent = document.getElementById("modalContent");
        const availablePoints = student.totalPoints - student.usedPoints;

        let shopItemsHtml = "";
        if (shopItems.length > 0) {
          shopItemsHtml =
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">';
          shopItems.forEach((item) => {
            const canAfford = availablePoints >= item.cost;
            const disabled = !canAfford || item.stock <= 0;

            shopItemsHtml += `
            <div style="background: var(--light); border: 1px solid var(--line); border-radius: 12px; padding: 16px; ${
              disabled ? "opacity: 0.6;" : ""
            }">
              <div style="font-weight: 600; margin-bottom: 8px;">${
                item.name
              }</div>
              <div style="display:flex;justify-content: space-between;">
                 <div style="color: var(--primary); font-weight: 800; margin-bottom: 12px;">${
                   item.cost
                 }ç§¯åˆ†</div>  
                <div style="color: #a76969; font-weight: 800; margin-bottom: 12px;">${
                  item.stock > 0 ? "åº“å­˜:" + item.stock : "åº“å­˜ä¸è¶³"
                }</div> 
              </div>
             
              <button onclick="purchaseItem(${student.id}, ${
              item.id
            })" class="btn ${
              canAfford ? "primary" : "ghost"
            }" style="width: 100%;" ${disabled ? "disabled" : ""}>
                ${canAfford ? "å…‘æ¢" : "ç§¯åˆ†ä¸è¶³"}
              </button>
            </div>
          `;
          });
          shopItemsHtml += "</div>";
        } else {
          shopItemsHtml = "<p>å•†åº—æš‚æ— å•†å“</p>";
        }

        modalContent.innerHTML = `
        <h3>${student.name} çš„å•†åº—å…‘æ¢</h3>
        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: #2d5a47; padding: 16px; border-radius: 12px; margin-bottom: 20px; font-weight: 700; font-size: 16px; text-align: center;">
          å¯ç”¨ç§¯åˆ†: <span style="font-size: 20px; margin-left: 8px;">${availablePoints}</span>
        </div>
        ${shopItemsHtml}
      `;

        showModal("modal");
      }

      // å°ç»„å•†åº—
      function showShopModal2(groupId) {
        const group = groups.find((s) => s.id === groupId);
        if (!group) return;
        const modalContent = document.getElementById("modalContent");
        const availablePoints = group.integral - group.useintegral;

        let shopItemsHtml = "";
        if (shopItems.length > 0) {
          shopItemsHtml =
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">';
          shopItems.forEach((item) => {
            const canAfford = availablePoints >= item.cost;
            const disabled = !canAfford || item.stock <= 0;

            shopItemsHtml += `
            <div style="background: var(--light); border: 1px solid var(--line); border-radius: 12px; padding: 16px; ${
              disabled ? "opacity: 0.6;" : ""
            }">
              <div style="font-weight: 600; margin-bottom: 8px;">${
                item.name
              }</div>
              <div style="display:flex;justify-content: space-between;">
                 <div style="color: var(--primary); font-weight: 800; margin-bottom: 12px;">${
                   item.cost
                 }ç§¯åˆ†</div>  
                <div style="color: #a76969; font-weight: 800; margin-bottom: 12px;">${
                  item.stock > 0 ? "åº“å­˜:" + item.stock : "åº“å­˜ä¸è¶³"
                }</div> 
              </div>
              <button onclick="purchaseItem2(${group.id}, ${
              item.id
            })" class="btn ${
              canAfford ? "primary" : "ghost"
            }" style="width: 100%;" ${disabled ? "disabled" : ""}>
                ${canAfford ? "å…‘æ¢" : "ç§¯åˆ†ä¸è¶³"}
              </button>
            </div>
          `;
          });
          shopItemsHtml += "</div>";
        } else {
          shopItemsHtml = "<p>å•†åº—æš‚æ— å•†å“</p>";
        }

        modalContent.innerHTML = `
        <h3>${group.name} çš„å•†åº—å…‘æ¢</h3>
        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: #2d5a47; padding: 16px; border-radius: 12px; margin-bottom: 20px; font-weight: 700; font-size: 16px; text-align: center;">
          å¯ç”¨ç§¯åˆ†: <span style="font-size: 20px; margin-left: 8px;">${availablePoints}</span>
        </div>
        ${shopItemsHtml}
      `;

        showModal("modal");
      }
      //å­¦ç”Ÿå…‘æ¢
      function purchaseItem(studentId, itemId) {
        const studentIndex = students.findIndex((s) => s.id === studentId);
        const itemIndex = shopItems.findIndex((item) => item.id === itemId);

        if (studentIndex === -1 || itemIndex === -1) return;

        const item = shopItems[itemIndex];
        const availablePoints =
          students[studentIndex].totalPoints -
          students[studentIndex].usedPoints;

        if (availablePoints >= item.cost) {
          // æ‰£é™¤ç§¯åˆ†
          students[studentIndex].usedPoints += item.cost;
          if (item.stock) {
            item.stock--;
          }
          // æ·»åŠ å†å²è®°å½•
          students[studentIndex].history.push({
            date: new Date().toISOString(),
            points: -item.cost,
            reason: `å…‘æ¢å•†å“: ${item.name}`,
          });

          saveAllData();
          updateUI();
          showShopModal(students[studentIndex].id); // åˆ·æ–°å•†åº—æ¨¡æ€æ¡†

          alert(`æˆåŠŸå…‘æ¢ ${item.name}ï¼`);
        }
      }
      // å°ç»„å…‘æ¢
      function purchaseItem2(groupId, itemId) {
        console.log("11 -->", 11);
        // const studentIndex = students.findIndex((s) => s.id === studentId);
        const itemIndex = shopItems.findIndex((item) => item.id === itemId);
        const groupIndex = groups.findIndex((s) => s.id === groupId);

        if (groupIndex === -1 || itemIndex === -1) return;

        const item = shopItems[itemIndex];
        const availablePoints =
          groups[groupIndex].integral - groups[groupIndex].useintegral;

        if (availablePoints >= item.cost) {
          // æ‰£é™¤ç§¯åˆ†
          groups[groupIndex].useintegral += item.cost;
          if (item.stock) {
            item.stock--;
          }
          // æ·»åŠ å†å²è®°å½•
          console.log("groups -->", groups, groups[groupIndex]);
          groups[groupIndex].history.push({
            date: new Date().toISOString(),
            points: -item.cost,
            reason: `å…‘æ¢å•†å“: ${item.name}`,
            title: "å°ç»„ç§¯åˆ†",
          });

          saveAllData();
          updateUI();
          showShopModal2(groups[groupIndex].id); // åˆ·æ–°å•†åº—æ¨¡æ€æ¡†

          alert(`æˆåŠŸå…‘æ¢ ${item.name}ï¼`);
        }
      }

      // =================================================================
      // å°ç»„ç®¡ç†åŠŸèƒ½
      // =================================================================

      function addGroup() {
        const groupName = document.getElementById("groupName").value.trim();
        if (!groupName) return alert("è¯·è¾“å…¥å°ç»„åç§°");

        const group = {
          id: generateId(),
          name: groupName,
          integral: 0,
          useintegral: 0,
          history: [],
        };

        groups.push(group);
        document.getElementById("groupName").value = "";
        saveAllData();
        updateUI();
      }
      let tt = null;
      function deleteGroup(groupId) {
        const flag = localStorage.getItem("deleteGroup");
        if (flag === "yes") {
          return;
        }
        localStorage.setItem("deleteGroup", "yes");
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå°ç»„å—ï¼Ÿå°ç»„å†…çš„å­¦ç”Ÿå°†è¿”å›æœªåˆ†ç»„çŠ¶æ€ã€‚")) {
          tt = setTimeout(() => {
            localStorage.removeItem("deleteGroup");
            clearTimeout(tt);
          }, 200);
          return;
        }
        // å°†å°ç»„ä¸­çš„æ‰€æœ‰å­¦ç”Ÿè®¾ä¸ºæœªåˆ†ç»„
        students.forEach((student) => {
          if (student.groupId === groupId) {
            student.groupId = null;
          }
        });

        // åˆ é™¤å°ç»„
        groups = groups.filter((group) => group.id !== groupId);

        saveAllData();
        updateUI();
        tt = setTimeout(() => {
          localStorage.removeItem("deleteGroup");
          clearTimeout(tt);
        }, 200);
      }

      // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸå¯è®¿é—®
      window.deleteGroup = deleteGroup;

      function updateGroupName(groupId, newName) {
        const trimmedName = newName.trim();
        if (!trimmedName) {
          alert("å°ç»„åç§°ä¸èƒ½ä¸ºç©º");
          updateUI(); // é‡æ–°æ¸²æŸ“ä»¥æ¢å¤åŸåç§°
          return;
        }

        const groupIndex = groups.findIndex((g) => g.id === groupId);
        if (groupIndex !== -1) {
          groups[groupIndex].name = trimmedName;
          saveAllData();
          updateUI();
        }
      }

      function addStudentToGroup(groupId) {
        const selectElement = document.getElementById(
          `addStudentToGroup_${groupId}`
        );
        const studentId = parseInt(selectElement.value);
        if (!studentId) return;

        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex !== -1) {
          students[studentIndex].groupId = groupId;
          selectElement.value = ""; // æ¸…ç©ºé€‰æ‹©
          saveAllData();
          updateUI();
        }
      }

      function removeStudentFromGroup(studentId) {
        const flag = localStorage.getItem("removeStudentFromGroup");
        if (flag === "yes") {
          return;
        }
        localStorage.setItem("removeStudentFromGroup", "yes");
        if (!confirm("ç¡®å®šè¦å°†è¯¥å­¦ç”Ÿç§»å‡ºå°ç»„å—ï¼Ÿ")) {
          tt = setTimeout(() => {
            localStorage.removeItem("removeStudentFromGroup");
            clearTimeout(tt);
          }, 200);
          return;
        }

        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex !== -1) {
          students[studentIndex].groupId = null;
          saveAllData();
          updateUI();
        }
        tt = setTimeout(() => {
          localStorage.removeItem("removeStudentFromGroup");
          clearTimeout(tt);
        }, 200);
      }

      function showGroupPointsModal(groupId) {
        const group = groups.find((g) => g.id === groupId);
        const groupStudents = students.filter((s) => s.groupId === groupId);

        if (!group || groupStudents.length === 0) {
          alert("å°ç»„ä¸ºç©ºï¼Œæ— æ³•è¿›è¡Œç§¯åˆ†æ“ä½œ");
          return;
        }

        const modalContent = document.getElementById("modalContent");

        let rulesHtml = "";
        rules.forEach((rule) => {
          const sign = rule.points > 0 ? "+" : "";
          rulesHtml += `
          <div class="rule-option ${rule.points > 0 ? "positive" : "negative"}" 
               onclick="applyPointsToGroup(${groupId}, ${rule.points}, '${
            rule.name
          }')">
            <span>${rule.name}</span>
            <span>${sign}${rule.points}</span>
          </div>
        `;
        });
        console.log("groupStudents -->", groupStudents);
        const totalPoints = groupStudents.reduce(
          (sum, s) => sum + s.totalPoints,
          0
        );
        const totalUsedPoints = groupStudents.reduce(
          (sum, s) => sum + s.usedPoints,
          0
        );
        const availablePoints = totalPoints - totalUsedPoints;

        modalContent.innerHTML = `
        <h3>${group.name} å°ç»„ç§¯åˆ†ç®¡ç†</h3>
        
        <!-- å°ç»„ç§¯åˆ†ç»Ÿè®¡ -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: 12px; color: #2d5a47;">
          <div style="text-align: center;">
            <div style="font-size: 12px; opacity: 0.8;">æ€»ç§¯åˆ†</div>
            <div style="font-weight: 800; font-size: 20px;">${
              group.integral
            }</div>
          </div>
       

          <div style="text-align: center;">
            <div style="font-size: 12px; opacity: 0.8;">å·²å…‘æ¢</div>
            <div style="font-weight: 800; font-size: 20px;">${
              group.useintegral
            }</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 12px; opacity: 0.8;">å¯ç”¨ç§¯åˆ†</div>
            <div style="font-weight: 800; font-size: 20px;">${
              group.integral - group.useintegral
            }</div>
          </div>
        </div>
         
        <div onclick="resetGroup(${groupId})"  style="cursor:pointer; text-align:right; background:#fb4f4f; color:#fff; width:max-content; border-radius:5px; margin-left:auto; padding:10px 15px; font-size:14px; font-weight:700;">
          å°ç»„ç§¯åˆ†æ¸…é›¶ !!
         </div>
        <!-- æˆå‘˜ä¿¡æ¯ -->
        <div style="margin-bottom: 20px;">
          <h4>å°ç»„æˆå‘˜ (${groupStudents.length}äºº)</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 8px;">
            ${groupStudents
              .map(
                (s) => `
              <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 8px; font-size: 12px;">
                <div style="font-weight: 600;">${s.name}</div>
                <div style="color: var(--primary);">${s.totalPoints}åˆ†</div>
              </div>
            `
              )
              .join("")}
          </div>
        </div>

        <!-- ç§¯åˆ†è§„åˆ™ -->
        <div class="rules-options">
          ${rulesHtml}
        </div>
        
        <!-- è‡ªå®šä¹‰ç§¯åˆ† -->
        <div style="margin-top: 20px;">
          <h4>è‡ªå®šä¹‰ç§¯åˆ†</h4>
          <div style="display: flex; gap: 12px; margin: 12px 0;">
            <input type="number" id="customGroupPoints" class="form-control" placeholder="åˆ†æ•°" style="width: 100px;">
            <input type="text" id="customGroupReason" class="form-control" placeholder="åŸå› " style="flex: 1;">
            <button onclick="applyCustomPointsToGroup(${groupId})" class="btn primary">åº”ç”¨åˆ°å…¨ç»„</button>
          </div>
        </div>
      `;

        showModal("modal");
      }

      function applyPointsToGroup(groupId, points, reason) {
        console.log("groupId -->", groupId, points, reason);

        const groupStudents = students.filter((s) => s.groupId === groupId);
        console.log("groupStudents -->", groupStudents);
        if (groupStudents.length === 0) return;

        groups.forEach((i) => {
          if (i.id == groupId) {
            i.integral += points;
          }
        });
        groupStudents.forEach((student) => {
          const studentIndex = students.findIndex((s) => s.id === student.id);
          if (studentIndex !== -1) {
            students[studentIndex].totalPoints += points;
            students[studentIndex].history.push({
              date: new Date().toISOString(),
              points: points,
              reason: `[å°ç»„] ${reason}`,
            });
          }
        });

        saveAllData();
        updateUI();
        closeModal("modal");
        alert(
          `å·²ä¸ºå°ç»„æ‰€æœ‰æˆå‘˜${points > 0 ? "åŠ " : "å‡"}${Math.abs(points)}åˆ†`
        );
      }

      function resetGroup(groupId) {
        const groupIndex = groups.findIndex((i) => i.id == groupId);

        if (
          confirm(
            `ç¡®å®šè¦æ¸…é™¤${groups[groupIndex].name}çš„ç§¯åˆ†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`
          )
        ) {
          groups[groupIndex].integral = 0;
          groups[groupIndex].useintegral = 0;
          groups[groupIndex].history.length = 0;
          saveAllData();
          updateUI();
          document.querySelectorAll(".close")[0].click();
          alert(`${groups[groupIndex].name}å°ç»„ç§¯åˆ†æ¸…é›¶ï¼`);
        }
      }

      function applyCustomPointsToGroup(groupId) {
        const points = parseInt(
          document.getElementById("customGroupPoints").value
        );
        const reason =
          document.getElementById("customGroupReason").value.trim() ||
          "å°ç»„è‡ªå®šä¹‰";

        if (isNaN(points)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°");

        applyPointsToGroup(groupId, points, reason);
      }

      // =================================================================
      // å…¨å‘˜å’Œå¤šé€‰ç§¯åˆ†ç®¡ç†åŠŸèƒ½
      // =================================================================

      function showGlobalPointsModal(type) {
        if (students.length === 0) {
          alert("æ²¡æœ‰å­¦ç”Ÿï¼Œæ— æ³•è¿›è¡Œæ“ä½œ");
          return;
        }

        const modalContent = document.getElementById("modalContent");
        let title = type === "add" ? "å…¨å‘˜åŠ åˆ†" : "å…¨å‘˜å‡åˆ†";

        // æ ¹æ®ç±»å‹è¿‡æ»¤è§„åˆ™
        let filteredRules = rules;
        if (type === "add") {
          filteredRules = rules.filter((r) => r.points > 0);
        } else if (type === "subtract") {
          filteredRules = rules.filter((r) => r.points < 0);
        }

        let rulesHtml = "";
        filteredRules.forEach((rule) => {
          const sign = rule.points > 0 ? "+" : "";
          rulesHtml += `
          <div class="rule-option ${rule.points > 0 ? "positive" : "negative"}" 
               onclick="applyPointsToAllStudents(${rule.points}, '${
            rule.name
          }')">
            <span>${rule.name}</span>
            <span>${sign}${rule.points}</span>
          </div>
        `;
        });

        modalContent.innerHTML = `
        <h3>${title}</h3>
        <div style="background: var(--light); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          å°†å¯¹æ‰€æœ‰ <strong>${students.length}</strong> åå­¦ç”Ÿè¿›è¡Œæ“ä½œ
        </div>
        <div class="rules-options">
          ${rulesHtml || "<p>æ²¡æœ‰å¯ç”¨çš„è§„åˆ™</p>"}
        </div>
        <div style="margin-top: 20px;">
          <h4>è‡ªå®šä¹‰ç§¯åˆ†3</h4>
          <div style="background: var(--light); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          å•æ¬¡åŠ åˆ†é¡¹ï¼Œä¸è®¡å…¥ç§¯åˆ†è§„åˆ™
        </div>
          <div class="diygrade">
            <input type="number" id="customGlobalPoints" class="form-control" placeholder="åˆ†æ•°" style="width: 100px;">
            <input type="text" id="customGlobalReason" class="form-control" placeholder="åŸå› " style="flex: 1;">
            <button onclick="applyCustomPointsToAllStudents()" class="btn primary">åº”ç”¨åˆ°æ‰€æœ‰å­¦ç”Ÿ</button>
          </div>
        </div>
      `;

        showModal("modal");
      }

      function applyPointsToAllStudents(points, reason) {
        students.forEach((student, index) => {
          students[index].totalPoints += points;
          students[index].history.push({
            date: new Date().toISOString(),
            points: points,
            reason: `[å…¨å‘˜] ${reason}`,
          });
        });

        saveAllData();
        updateUI();
        closeModal("modal");
        alert(`å·²ä¸ºæ‰€æœ‰å­¦ç”Ÿ${points > 0 ? "åŠ " : "å‡"}${Math.abs(points)}åˆ†`);
      }

      function applyCustomPointsToAllStudents() {
        const points = parseInt(
          document.getElementById("customGlobalPoints").value
        );
        const reason =
          document.getElementById("customGlobalReason").value.trim() ||
          "å…¨å‘˜è‡ªå®šä¹‰";

        if (isNaN(points)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°");

        applyPointsToAllStudents(points, reason);
      }

      // å¤šé€‰æ¨¡å¼åŠŸèƒ½
      function enterMultiSelectMode() {
        isMultiSelectMode = true;
        document.body.classList.add("multi-select-mode");
        document.getElementById("exitMultiSelectMode").style.display =
          "inline-flex";
        document.getElementById("multiSelectActions").style.display = "flex";
        document.getElementById("multiSelectMode").style.display = "none";
        multiSelectedStudentIds.clear();
        updateSelectedCount();
      }

      function exitMultiSelectMode() {
        isMultiSelectMode = false;
        document.body.classList.remove("multi-select-mode");
        document.getElementById("exitMultiSelectMode").style.display = "none";
        document.getElementById("multiSelectActions").style.display = "none";
        document.getElementById("multiSelectMode").style.display =
          "inline-flex";
        multiSelectedStudentIds.clear();
        updateUI(); // é‡æ–°æ¸²æŸ“æ¸…é™¤é€‰æ‹©çŠ¶æ€
      }

      function updateSelectedCount() {
        document.getElementById("selectedCount").textContent =
          multiSelectedStudentIds.size;
      }

      function deleteSelectedStudents() {
        if (multiSelectedStudentIds.size === 0) {
          alert("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å­¦ç”Ÿ");
          return;
        }

        const selectedStudents = students.filter((s) =>
          multiSelectedStudentIds.has(s.id)
        );
        const confirmMessage = `ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹ ${
          selectedStudents.length
        } åå­¦ç”Ÿå—ï¼Ÿ\n\n${selectedStudents
          .map((s) => s.name)
          .join("ã€")}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;

        if (!confirm(confirmMessage)) return;

        // åˆ é™¤é€‰ä¸­çš„å­¦ç”Ÿ
        students = students.filter((s) => !multiSelectedStudentIds.has(s.id));

        saveAllData();
        exitMultiSelectMode();
        updateUI();
        alert(`å·²åˆ é™¤ ${selectedStudents.length} åå­¦ç”Ÿ`);
      }

      // æœç´¢åŠŸèƒ½
      function searchStudents() {
        const searchTerm = document
          .getElementById("studentSearchInput")
          .value.trim()
          .toLowerCase();

        if (!searchTerm) {
          // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿ
          updateUI();
          return;
        }

        // è¿‡æ»¤å­¦ç”Ÿ
        const filteredStudents = students.filter((student) =>
          student.name.toLowerCase().includes(searchTerm)
        );

        // é‡æ–°æ¸²æŸ“åªæ˜¾ç¤ºæœç´¢ç»“æœ
        renderFilteredStudents(filteredStudents);
      }

      function renderFilteredStudents(filteredStudents) {
        const allStudentsEl = document.getElementById("allStudents");
        allStudentsEl.innerHTML = "";

        if (filteredStudents.length === 0) {
          allStudentsEl.innerHTML =
            '<div style="text-align: center; padding: 40px; color: var(--sub);">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿ</div>';
          return;
        }

        // æŒ‰å°ç»„åˆ†ç»„æ˜¾ç¤ºæœç´¢ç»“æœ
        const ungroupedFiltered = filteredStudents.filter((s) => !s.groupId);
        const groupedFiltered = {};

        filteredStudents.forEach((student) => {
          if (student.groupId) {
            if (!groupedFiltered[student.groupId]) {
              groupedFiltered[student.groupId] = [];
            }
            groupedFiltered[student.groupId].push(student);
          }
        });

        // æ¸²æŸ“æœªåˆ†ç»„çš„æœç´¢ç»“æœ
        if (ungroupedFiltered.length > 0) {
          const section = document.createElement("div");
          section.className = "group-section";
          section.setAttribute("data-group-id", "ç©º");
          console.log("æ¸²æŸ“æœªåˆ†ç»„ -->");
          section.innerHTML = `
          <div class="group-header">
            <div class="group-name">æœªåˆ†ç»„ - æœç´¢ç»“æœ</div>
            <div class="group-stats">${ungroupedFiltered.length}äºº</div>
          </div>
        `;

          const grid = document.createElement("div");
          grid.className = "student-list";
          ungroupedFiltered.forEach((student) => {
            grid.appendChild(createStudentCard(student));
          });
          section.appendChild(grid);
          allStudentsEl.appendChild(section);
        }

        // æ¸²æŸ“å„å°ç»„çš„æœç´¢ç»“æœ
        groups.forEach((group) => {
          if (groupedFiltered[group.id]) {
            const section = document.createElement("div");
            section.className = "group-section";
            section.setAttribute("data-group-id", group.id);

            const groupStudents = groupedFiltered[group.id];
            section.innerHTML = `
            <div class="group-header">
              <div class="group-name">${group.name} - æœç´¢ç»“æœ</div>
              <div class="group-stats">${groupStudents.length}äºº</div>
            </div>
          `;

            const grid = document.createElement("div");
            grid.className = "student-list dropzone";
            grid.setAttribute("data-group-id", group.id);
            groupStudents.forEach((student) => {
              grid.appendChild(createStudentCard(student));
            });
            section.appendChild(grid);
            allStudentsEl.appendChild(section);
          }
        });

        // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
        // setupDragAndDrop();
      }

      // æ¸…ç©ºæœç´¢
      function clearSearch() {
        document.getElementById("studentSearchInput").value = "";
        updateUI();
      }

      function showMultiSelectPointsModal(type) {
        if (multiSelectedStudentIds.size === 0) {
          alert("è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„å­¦ç”Ÿ");
          return;
        }

        const selectedStudents = students.filter((s) =>
          multiSelectedStudentIds.has(s.id)
        );
        const modalContent = document.getElementById("modalContent");
        let title = type === "add" ? "å¤šé€‰åŠ åˆ†" : "å¤šé€‰å‡åˆ†";

        // æ ¹æ®ç±»å‹è¿‡æ»¤è§„åˆ™
        let filteredRules = rules;
        if (type === "add") {
          filteredRules = rules.filter((r) => r.points > 0);
        } else if (type === "subtract") {
          filteredRules = rules.filter((r) => r.points < 0);
        }

        let rulesHtml = "";
        filteredRules.forEach((rule) => {
          const sign = rule.points > 0 ? "+" : "";
          rulesHtml += `
          <div class="rule-option ${rule.points > 0 ? "positive" : "negative"}" 
               onclick="applyPointsToSelectedStudents(${rule.points}, '${
            rule.name
          }')">
            <span>${rule.name}</span>
            <span>${sign}${rule.points}</span>
          </div>
        `;
        });

        modalContent.innerHTML = `
        <h3>${title}</h3>
        <div style="background: var(--light); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          å·²é€‰æ‹© <strong>${selectedStudents.length}</strong> åå­¦ç”Ÿï¼š
          <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
            ${selectedStudents
              .map(
                (s) =>
                  `<span style="background: var(--primary); color: #2d5a47; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${s.name}</span>`
              )
              .join("")}
          </div>
        </div>
        <div class="rules-options">
          ${rulesHtml || "<p>æ²¡æœ‰å¯ç”¨çš„è§„åˆ™</p>"}
        </div>
        <div style="margin-top: 20px;">
          <h4>è‡ªå®šä¹‰ç§¯åˆ†</h4>
          <div style="display: flex; gap: 12px; margin: 12px 0;">
            <input type="number" id="customMultiPoints" class="form-control" placeholder="åˆ†æ•°" style="width: 100px;">
            <input type="text" id="customMultiReason" class="form-control" placeholder="åŸå› " style="flex: 1;">
            <button onclick="applyCustomPointsToSelectedStudents()" class="btn primary">åº”ç”¨åˆ°é€‰ä¸­å­¦ç”Ÿ</button>
          </div>
        </div>
      `;

        showModal("modal");
      }

      function applyPointsToSelectedStudents(points, reason) {
        const selectedStudentIds = Array.from(multiSelectedStudentIds);

        selectedStudentIds.forEach((studentId) => {
          const studentIndex = students.findIndex((s) => s.id === studentId);
          if (studentIndex !== -1) {
            students[studentIndex].totalPoints += points;
            students[studentIndex].history.push({
              date: new Date().toISOString(),
              points: points,
              reason: `[å¤šé€‰] ${reason}`,
            });
          }
        });

        saveAllData();
        updateUI();
        closeModal("modal");
        exitMultiSelectMode();
        alert(
          `å·²ä¸ºé€‰ä¸­çš„${selectedStudentIds.length}åå­¦ç”Ÿ${
            points > 0 ? "åŠ " : "å‡"
          }${Math.abs(points)}åˆ†`
        );
      }

      function applyCustomPointsToSelectedStudents() {
        const points = parseInt(
          document.getElementById("customMultiPoints").value
        );
        const reason =
          document.getElementById("customMultiReason").value.trim() ||
          "å¤šé€‰è‡ªå®šä¹‰";

        if (isNaN(points)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°");

        applyPointsToSelectedStudents(points, reason);
      }

      // =================================================================
      // æ•°æ®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ (é‡‡ç”¨ç¬¬äºŒä¸ªç³»ç»Ÿçš„æ™ºèƒ½å¯¼å…¥)
      // =================================================================

      function showImportModal() {
        showModal("importModal");
      }

      function exportData() {
        const data = JSON.parse(localStorage.getItem("classPointsData"));
        // const data = {
        //   students: students,
        //   groups: groups,
        //   rules: rules,
        //   shopItems: shopItems,
        // };

        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `ç­çº§ç§¯åˆ†æ•°æ®_${
          new Date().toISOString().split("T")[0]
        }.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function handleFileImport() {
        const file = document.getElementById("importFile").files[0];
        if (!file) return alert("è¯·é€‰æ‹©æ–‡ä»¶");

        const ext = file.name.split(".").pop().toLowerCase();

        if ((ext === "xlsx" || ext === "xls") && typeof XLSX !== "undefined") {
          const reader = new FileReader();
          reader.onload = function () {
            try {
              const workbook = XLSX.read(new Uint8Array(reader.result), {
                type: "array",
              });
              const sheetName = workbook.SheetNames[0];
              const rows = XLSX.utils.sheet_to_json(
                workbook.Sheets[sheetName],
                { header: 1, raw: true }
              );
              handleImportData(rowsToCSV(rows));
            } catch (err) {
              alert("Excel è§£æå¤±è´¥ï¼š" + err.message);
            }
          };
          reader.readAsArrayBuffer(file);
        } else {
          const reader = new FileReader();
          reader.onload = function () {
            try {
              handleImportData(reader.result);
            } catch (err) {
              alert("æ–‡ä»¶è§£æå¤±è´¥ï¼š" + err.message);
            }
          };
          reader.readAsText(file);
        }
      }

      function handleTextImport() {
        const text = document.getElementById("importText").value.trim();
        if (!text) return alert("è¯·è¾“å…¥è¦å¯¼å…¥çš„æ•°æ®");

        try {
          handleImportData(text);
        } catch (err) {
          alert("æ•°æ®è§£æå¤±è´¥ï¼š" + err.message);
        }
      }

      function rowsToCSV(rows) {
        return (rows || [])
          .map((row) =>
            (row || [])
              .map((cell) => `"${String(cell ?? "").replace(/"/g, '""')}"`)
              .join(",")
          )
          .join("\n");
      }
      // ä¿®æ”¹ handleImportData å‡½æ•°
      function handleImportData(text) {
        console.log("å¯¼å…¥çš„æ•°æ®:", text); // æŸ¥çœ‹å¯¼å…¥çš„åŸå§‹æ–‡æœ¬

        if (!text) throw new Error("å†…å®¹ä¸ºç©º");

        let items;

        try {
          // é¦–å…ˆå°è¯•è§£æä¸ºJSON
          if (text.trim().startsWith("[") || text.trim().startsWith("{")) {
            const jsonData = JSON.parse(text);
            console.log("jsonData -->", jsonData);
            if (Array.isArray(jsonData) && jsonData.length) {
              // æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´çš„ç³»ç»Ÿæ•°æ®æ ¼å¼
              if (jsonData[0].students && Array.isArray(jsonData[0].students)) {
                // å®Œæ•´æ•°æ®æ ¼å¼ï¼Œç›´æ¥å¯¼å…¥æ‰€æœ‰æ•°æ®
                if (
                  confirm(
                    "æ£€æµ‹åˆ°å®Œæ•´çš„ç³»ç»Ÿæ•°æ®ï¼Œæ˜¯å¦å¯¼å…¥æ‰€æœ‰æ•°æ®ï¼ˆåŒ…æ‹¬å­¦ç”Ÿã€å°ç»„ã€è§„åˆ™å’Œå•†åº—ï¼‰ï¼Ÿ"
                  )
                ) {
                  localStorage.setItem(
                    "classPointsData",
                    JSON.stringify(jsonData)
                  );
                  console.log("è·å–æ–°æ•°æ® -->");
                  loadAllData();
                  updateUI();
                  closeModal("importModal");
                  alert("å®Œæ•´æ•°æ®å¯¼å…¥æˆåŠŸï¼");
                  return;
                }
              }
              // å¦åˆ™æŒ‰æ™®é€šæ•°æ®å¤„ç†
              items = normalizeData(jsonData);
            }
          } else {
            // å¤„ç†CSV/TSVæ ¼å¼
            items = normalizeData(text);
          }

          if (!items || items.length === 0) {
            throw new Error("æœªæ‰¾åˆ°å¯å¯¼å…¥çš„æ•°æ®");
          }

          importStudentData(items);
        } catch (err) {
          console.error("å¯¼å…¥å¤„ç†å¤±è´¥:", err);
          alert("æ•°æ®å¤„ç†å¤±è´¥ï¼š" + err.message);
        }
      }

      // ä¿®æ”¹ normalizeData å‡½æ•°ï¼Œå¢å¼ºå…¼å®¹æ€§
      function normalizeData(input) {
        const out = [];
        const nameKeys = ["name", "å§“å", "å­¦ç”Ÿå§“å"];
        const scoreKeys = ["score", "ç§¯åˆ†", "æ€»ç§¯åˆ†"];
        const coinsKeys = ["coins", "å…‘æ¢å¸", "é‡‘å¸", "å·²ç”¨ç§¯åˆ†"];
        const groupKeys = ["group", "å°ç»„", "ç­çº§"];

        if (!input) return out;

        try {
          if (typeof input === "string") {
            // å¤„ç†CSV/TSVå­—ç¬¦ä¸²
            const lines = input
              .split(/\r?\n/)
              .filter((line) => line.trim() !== "");
            if (lines.length === 0) return out;

            const delim = lines[0].includes("\t") ? "\t" : ",";
            return normalizeData(
              lines.map((line) =>
                line
                  .split(new RegExp(`${delim}(?=(?:[^"]*"[^"]*")*[^"]*$)`))
                  .map((cell) => cell.replace(/^"|"$/g, "").trim())
              )
            );
          }

          if (Array.isArray(input)) {
            if (input.length === 0) return out;

            // æ£€æŸ¥æ˜¯å¦æ˜¯å¯¹è±¡æ•°ç»„
            if (typeof input[0] === "object" && !Array.isArray(input[0])) {
              input.forEach((obj) => {
                out.push({
                  name: findValue(obj, nameKeys),
                  score: findValue(obj, scoreKeys),
                  coins: findValue(obj, coinsKeys),
                  group: findValue(obj, groupKeys),
                });
              });
              return out;
            }

            // å¤„ç†äºŒç»´æ•°ç»„
            let start = 0;
            let nameIdx = 0,
              scoreIdx = -1,
              coinsIdx = -1,
              groupIdx = -1;

            if (Array.isArray(input[0])) {
              const headers = input[0].map((h) =>
                String(h || "").toLowerCase()
              );
              const findIdx = (keys) =>
                headers.findIndex((h) =>
                  keys.some((k) => h.includes(k.toLowerCase()))
                );

              nameIdx = findIdx(nameKeys);
              scoreIdx = findIdx(scoreKeys);
              coinsIdx = findIdx(coinsKeys);
              groupIdx = findIdx(groupKeys);

              // å¦‚æœæ‰¾åˆ°äº†æ ‡é¢˜è¡Œï¼Œä»ä¸‹ä¸€è¡Œå¼€å§‹å¤„ç†
              if (
                nameIdx > -1 ||
                scoreIdx > -1 ||
                coinsIdx > -1 ||
                groupIdx > -1
              ) {
                start = 1;
              } else {
                // æ²¡æœ‰æ ‡é¢˜è¡Œï¼Œå‡è®¾ç¬¬ä¸€åˆ—æ˜¯å§“å
                nameIdx = 0;
              }
            }

            // å¤„ç†æ•°æ®è¡Œ
            for (let i = start; i < input.length; i++) {
              const row = input[i];
              if (!Array.isArray(row) || row.length === 0) continue;

              const name = row[nameIdx] ? String(row[nameIdx]).trim() : "";
              if (!name) continue; // è·³è¿‡æ²¡æœ‰å§“åçš„è¡Œ

              out.push({
                name: name,
                score: scoreIdx > -1 ? row[scoreIdx] : "",
                coins: coinsIdx > -1 ? row[coinsIdx] : "",
                group: groupIdx > -1 ? row[groupIdx] : "",
              });
            }
          }
        } catch (err) {
          console.error("æ•°æ®æ ‡å‡†åŒ–å¤±è´¥:", err);
        }

        return out;
      }

      // ä¿®æ”¹ importStudentData å‡½æ•°
      function importStudentData(items) {
        if (!items || items.length === 0) {
          alert("æ²¡æœ‰å¯å¯¼å…¥çš„å­¦ç”Ÿæ•°æ®");
          return;
        }

        const existingNames = new Set(students.map((s) => s.name.trim()));
        let importCount = 0;
        let updateCount = 0;

        items.forEach((item) => {
          if (!item.name || !item.name.trim()) return;

          const name = item.name.trim();
          let groupId = null;

          // å¤„ç†å°ç»„
          if (item.group && item.group.trim()) {
            const groupName = item.group.trim();
            let group = groups.find((g) => g.name.trim() === groupName);

            if (!group) {
              // åˆ›å»ºæ–°å°ç»„
              group = { id: generateId(), name: groupName };
              groups.push(group);
            }
            groupId = group.id;
          }

          if (!existingNames.has(name)) {
            // æ–°å¢å­¦ç”Ÿ
            students.push({
              id: generateId(),
              name: name,
              gender: "male", // é»˜è®¤æ€§åˆ«
              avatar: null,
              totalPoints: item.score ? parseInt(item.score) || 0 : 0,
              usedPoints: item.coins ? parseInt(item.coins) || 0 : 0,
              history: [],
              groupId: groupId,
            });
            importCount++;
          } else {
            // æ›´æ–°ç°æœ‰å­¦ç”Ÿ
            const student = students.find((s) => s.name.trim() === name);
            if (student) {
              if (item.score && !isNaN(parseInt(item.score))) {
                student.totalPoints = parseInt(item.score);
              }
              if (item.coins && !isNaN(parseInt(item.coins))) {
                student.usedPoints = parseInt(item.coins);
              }
              if (groupId) {
                student.groupId = groupId;
              }
              updateCount++;
            }
          }
        });

        saveAllData();
        updateUI();
        closeModal("importModal");

        alert(
          `å¯¼å…¥å®Œæˆï¼æ–°å¢ ${importCount} åå­¦ç”Ÿï¼Œæ›´æ–° ${updateCount} åå­¦ç”Ÿ`
        );
      }

      function normalizeData(input) {
        const out = [];
        const nameKeys = ["name", "å§“å"];
        const scoreKeys = ["score", "ç§¯åˆ†"];
        const coinsKeys = ["coins", "å…‘æ¢å¸", "é‡‘å¸"];
        const groupKeys = ["group", "å°ç»„"];

        if (Array.isArray(input) && input.length > 0) {
          if (typeof input[0] === "object" && !Array.isArray(input[0])) {
            // å¯¹è±¡æ•°ç»„æ ¼å¼
            input.forEach((obj) => {
              out.push({
                name: findValue(obj, nameKeys),
                score: findValue(obj, scoreKeys),
                coins: findValue(obj, coinsKeys),
                group: findValue(obj, groupKeys),
              });
            });
          } else {
            // äºŒç»´æ•°ç»„æ ¼å¼
            let start = 0,
              nameIdx = 0,
              scoreIdx = 1,
              coinsIdx = 2,
              groupIdx = 3;

            if (Array.isArray(input[0])) {
              const headers = input[0].map((h) =>
                String(h || "").toLowerCase()
              );
              const findIdx = (keys) =>
                headers.findIndex((h) =>
                  keys.some((k) => h.includes(k.toLowerCase()))
                );

              const foundName = findIdx(nameKeys);
              const foundScore = findIdx(scoreKeys);
              const foundCoins = findIdx(coinsKeys);
              const foundGroup = findIdx(groupKeys);

              if (
                foundName > -1 ||
                foundScore > -1 ||
                foundCoins > -1 ||
                foundGroup > -1
              ) {
                start = 1;
                if (foundName > -1) nameIdx = foundName;
                if (foundScore > -1) scoreIdx = foundScore;
                if (foundCoins > -1) coinsIdx = foundCoins;
                if (foundGroup > -1) groupIdx = foundGroup;
              }
            }

            for (let i = start; i < input.length; i++) {
              const row = input[i];
              out.push({
                name: row[nameIdx],
                score: row[scoreIdx],
                coins: row[coinsIdx],
                group: row[groupIdx],
              });
            }
          }
        }

        return out;
      }

      function findValue(obj, keys) {
        for (const key of keys) {
          if (obj && key in obj) return obj[key];
        }
        return "";
      }

      function importStudentData(items) {
        const existingNames = new Set(students.map((s) => s.name));
        let importCount = 0;

        items.forEach((item) => {
          if (!item.name) return;

          let groupId = null;
          if (item.group) {
            const group = groups.find((g) => g.name === item.group);
            if (group) {
              groupId = group.id;
            } else {
              // è‡ªåŠ¨åˆ›å»ºå°ç»„
              const newGroup = { id: generateId(), name: item.group };
              groups.push(newGroup);
              groupId = newGroup.id;
            }
          }

          if (!existingNames.has(item.name)) {
            students.push({
              id: generateId(),
              name: item.name,
              gender: "male", // é»˜è®¤æ€§åˆ«
              avatar: null,
              totalPoints: parseInt(item.score) || 0,
              usedPoints: 0,
              history: [],
              groupId: groupId,
            });
            importCount++;
          } else {
            // æ›´æ–°ç°æœ‰å­¦ç”Ÿ
            const student = students.find((s) => s.name === item.name);
            if (student) {
              if (item.score && !isNaN(parseInt(item.score))) {
                student.totalPoints = parseInt(item.score);
              }
              if (groupId) {
                student.groupId = groupId;
              }
            }
          }
        });

        saveAllData();
        updateUI();
        closeModal("importModal");

        alert(`å¯¼å…¥æˆåŠŸï¼æ–°å¢ ${importCount} åå­¦ç”Ÿ`);
      }

      // =================================================================
      // UIæ›´æ–°å’Œæ¸²æŸ“åŠŸèƒ½
      // =================================================================

      function updateUI() {
        renderStudents();
        renderGroups();
        renderLeaderboards();
        renderRules();
        renderShopItems();
      }

      function renderStudents() {
        const allStudentsEl = document.getElementById("allStudents");
        allStudentsEl.innerHTML = "";

        // æŒ‰å°ç»„åˆ†ç»„æ˜¾ç¤º
        const ungroupedStudents = students.filter((s) => !s.groupId);
        const groupedStudents = {};

        students.forEach((student) => {
          if (student.groupId) {
            if (!groupedStudents[student.groupId]) {
              groupedStudents[student.groupId] = [];
            }
            groupedStudents[student.groupId].push(student);
          }
        });

        // æ¸²æŸ“æœªåˆ†ç»„å­¦ç”Ÿ
        if (ungroupedStudents.length > 0) {
          const section = document.createElement("div");
          section.className = "group-section";
          section.setAttribute("data-group-id", "ç©º");
          section.innerHTML = `
          <div class="group-header">
            <div class="group-name">æœªåˆ†ç»„</div>
            <div class="group-stats">${
              ungroupedStudents.length
            }äººï¼Œæ€»åˆ†: ${ungroupedStudents.reduce(
            (sum, s) => sum + s.totalPoints,
            0
          )}</div>
          </div>
        `;

          const grid = document.createElement("div");
          grid.className = "student-list";
          ungroupedStudents.forEach((student) => {
            grid.appendChild(createStudentCard(student));
          });
          section.appendChild(grid);
          allStudentsEl.appendChild(section);
        }

        // æ¸²æŸ“å„å°ç»„
        groups.forEach((group) => {
          if (groupedStudents[group.id]) {
            const section = document.createElement("div");
            section.className = "group-section";
            section.setAttribute("data-group-id", group.id);
            const groupStudents = groupedStudents[group.id];
            section.innerHTML = `
            <div class="group-header">
              <div class="group-name">${group.name}</div>
              <div class="group-stats">${
                groupStudents.length
              }äººï¼Œæ€»åˆ†: ${groupStudents.reduce(
              (sum, s) => sum + s.totalPoints,
              0
            )}</div>
            </div>
          `;

            const grid = document.createElement("div");
            grid.className = "student-list dropzone";
            grid.setAttribute("data-group-id", group.id);
            groupStudents.forEach((student) => {
              grid.appendChild(createStudentCard(student));
            });
            section.appendChild(grid);
            allStudentsEl.appendChild(section);
          }
        });

        // è®¾ç½®æ‹–æ‹½åŠŸèƒ½
        // setupDragAndDrop();
      }

      function renderGroups() {
        const groupsArea = document.getElementById("groupsArea");
        groupsArea.innerHTML = "";

        // å®šä¹‰å°ç»„èƒŒæ™¯è‰²å½©
        const groupColors = [
          "#E8F5E8", // æµ…ç»¿è‰²
          "#E8F0FF", // æµ…è“è‰²
          "#FFF0E8", // æµ…æ©™è‰²
          "#F0E8FF", // æµ…ç´«è‰²
          "#E8FFF0", // æµ…è–„è·ç»¿
          "#FFE8F0", // æµ…ç²‰è‰²
          "#F0FFE8", // æµ…é»„ç»¿è‰²
          "#E8F8FF", // æµ…å¤©è“è‰²
        ];

        groups.forEach((group, index) => {
          const groupStudents = students.filter((s) => s.groupId === group.id);
          const totalPoints = groupStudents.reduce(
            (sum, s) => sum + s.totalPoints,
            0
          );
          const totalUsedPoints = groupStudents.reduce(
            (sum, s) => sum + s.usedPoints,
            0
          );
          const availablePoints = totalPoints - totalUsedPoints;

          // è·å–æœªåˆ†ç»„çš„å­¦ç”Ÿç”¨äºæ·»åŠ 
          const ungroupedStudents = students.filter((s) => !s.groupId);

          // æ ¹æ®å°ç»„ç´¢å¼•é€‰æ‹©èƒŒæ™¯è‰²
          const backgroundColor = groupColors[index % groupColors.length];

          const groupDiv = document.createElement("div");
          groupDiv.className = "panel";
          groupDiv.style.background = backgroundColor; // åº”ç”¨èƒŒæ™¯è‰²
          groupDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <input type="text" value="${group.name}" id="groupName_${
            group.id
          }" 
                     style="font-size: 16px; font-weight: 800; border: 1px solid transparent; background: rgba(255,255,255,0.7); padding: 4px 8px; border-radius: 6px;"
                     onblur="updateGroupName(${group.id}, this.value)" 
                     onkeypress="if(event.key==='Enter') this.blur()"
                     onfocus="this.style.border='1px solid var(--primary)'; this.style.background='#fff'"
                     onblur="this.style.border='1px solid transparent'; this.style.background='rgba(255,255,255,0.7)'">
              <span style="color: var(--sub); font-size: 14px;">(${
                groupStudents.length
              }äºº)</span>
            </div>
           <div>
            
              <button class="btn primary btn-sm group-points-btn" data-group-id="${
                group.id
              }">å°ç»„ç§¯åˆ†</button>
              <button class="btn warn btn-sm delete-group-btn" data-group-id="${
                group.id
              }" style="margin-left: 8px;">åˆ é™¤å°ç»„</button>
              <button class="control-btn shop-btn" style="padding:8px 16px" onclick="showShopModal2(${
                group.id
              })" title="ç§¯åˆ†å•†åº—">ğŸ›’</button>

               <button class="control-btn history-btn" style="padding:8px 16px" onclick="showHistoryModal(${
                 group.id
               })" title="ç§¯åˆ†è®°å½•">ğŸ“‹</button>
          </div>
            </div>
          </div>

          <!-- ç§¯åˆ†ç»Ÿè®¡ä¿¡æ¯ -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.6); border-radius: 12px; backdrop-filter: blur(10px);">
            <div style="text-align: center;">
              <div style="color: var(--sub); font-size: 12px;">æ€»ç§¯åˆ†</div>
              <div style="color: var(--primary); font-weight: 800; font-size: 18px;">${
                group.integral
              }</div>
            </div>
            <div style="text-align: center;">
              <div style="color: var(--sub); font-size: 12px;">å·²å…‘æ¢</div>
              <div style="color: var(--warn); font-weight: 800; font-size: 18px;">${
                group.useintegral
              }</div>
            </div>
            <div style="text-align: center;">
              <div style="color: var(--sub); font-size: 12px;">å¯ç”¨ç§¯åˆ†</div>
              <div style="color: var(--ok); font-weight: 800; font-size: 18px;">${
                group.integral - group.useintegral
              }</div>
            </div>
          </div>

          <!-- æ·»åŠ å­¦ç”ŸåŠŸèƒ½ -->
          <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center;">
            <select id="addStudentToGroup_${
              group.id
            }" class="form-control" style="flex: 1; max-width: 200px; background: rgba(255,255,255,0.8);">
              <option value="">é€‰æ‹©å­¦ç”ŸåŠ å…¥å°ç»„...</option>
              ${ungroupedStudents
                .map((s) => `<option value="${s.id}">${s.name}</option>`)
                .join("")}
            </select>
            <button class="btn ok btn-sm add-student-btn" data-group-id="${
              group.id
            }">
              <i class="fas fa-plus add-student-btn" data-group-id="${
                group.id
              }"></i> æ·»åŠ 
            </button>
          </div>

          <!-- å°ç»„æˆå‘˜åˆ—è¡¨ -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
            ${groupStudents
              .map(
                (s) => `
              <div style="position: relative; text-align: center; padding: 12px 8px; background: rgba(255,255,255,0.8); border-radius: 12px; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px);">
                <button class="remove-student-btn" data-student-id="${s.id}"
                        style="position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; border: none; background: var(--warn); color: #fff; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                        title="ç§»å‡ºå°ç»„">Ã—</button>
                <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${
                  s.name
                }</div>
                <div style="color: var(--primary); font-weight: 800; margin-bottom: 2px;">${
                  // s.integral
                  s.totalPoints
                } æ€»åˆ†</div>
                <div style="color: var(--ok); font-size: 12px; font-weight: 600;">${
                  s.totalPoints - s.usedPoints
                } å¯ç”¨</div>
                <div style="display: flex; gap: 4px; margin-top: 6px; justify-content: center;">
                  <button onclick="showPointsModal(${
                    s.id
                  }, 'add')" class="btn ok" style="padding: 2px 6px; font-size: 10px;">+</button>
                  <button onclick="showPointsModal(${
                    s.id
                  }, 'subtract')" class="btn warn" style="padding: 2px 6px; font-size: 10px;">-</button>
                  <button onclick="showHistoryModal(${
                    s.id
                  })" class="btn secondary" style="padding: 2px 6px; font-size: 10px;">è®°å½•</button>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;
          groupsArea.appendChild(groupDiv);
        });

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        setupGroupEventListeners();
      }

      // function setupGroupEventListeners() {
      //   const groupsArea = document.getElementById('groupsArea');

      //   // åˆ é™¤å°ç»„æŒ‰é’®
      //   groupsArea.addEventListener('click', function (e) {
      //     e.stopPropagation()
      //     if (e.target.classList.contains('delete-group-btn')) {
      //       const groupId = parseInt(e.target.dataset.groupId);
      //       // if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå°ç»„å—ï¼Ÿå°ç»„å†…çš„å­¦ç”Ÿå°†è¿”å›æœªåˆ†ç»„çŠ¶æ€ã€‚')) {
      //       // å°†å°ç»„ä¸­çš„æ‰€æœ‰å­¦ç”Ÿè®¾ä¸ºæœªåˆ†ç»„
      //       deleteGroup(groupId)
      //       // students.forEach(student => {
      //       //   if (student.groupId === groupId) {
      //       //     student.groupId = null;
      //       //   }
      //       // });
      //       // åˆ é™¤å°ç»„
      //       // groups = groups.filter(group => group.id !== groupId);
      //       // saveAllData();
      //       // updateUI();
      //       // }
      //     }

      //     // å°ç»„ç§¯åˆ†æŒ‰é’®
      //     if (e.target.classList.contains('group-points-btn')) {
      //       const groupId = parseInt(e.target.dataset.groupId);
      //       showGroupPointsModal(groupId);
      //     }

      //     // æ·»åŠ å­¦ç”ŸæŒ‰é’®
      //     if (e.target.classList.contains('add-student-btn')) {
      //       const groupId = parseInt(e.target.dataset.groupId);
      //       addStudentToGroup(groupId);
      //     }

      //     // ç§»é™¤å­¦ç”ŸæŒ‰é’®
      //     if (e.target.classList.contains('remove-student-btn')) {
      //       const studentId = parseInt(e.target.dataset.studentId);
      //       removeStudentFromGroup(studentId);
      //     }
      //   });
      // }
      let handleGroupClick;
      function setupGroupEventListeners() {
        const groupsArea = document.getElementById("groupsArea");
        // å…ˆç§»é™¤å·²å­˜åœ¨çš„åŒåäº‹ä»¶ç›‘å¬ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        groupsArea.removeEventListener("click", handleGroupClick);

        // å¦‚æœå·²ç»å­˜åœ¨æ—§çš„ç›‘å¬å™¨ï¼Œå…ˆç§»é™¤
        if (handleGroupClick) {
          groupsArea.removeEventListener("click", handleGroupClick);
        }

        // å®šä¹‰å‘½åçš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œä¾¿äºåç»­ç§»é™¤
        handleGroupClick = function (e) {
          e.stopPropagation();

          // åˆ é™¤å°ç»„æŒ‰é’®
          if (e.target.classList.contains("delete-group-btn")) {
            const groupId = parseInt(e.target.dataset.groupId);
            deleteGroup(groupId);
          }

          // å°ç»„ç§¯åˆ†æŒ‰é’®
          if (e.target.classList.contains("group-points-btn")) {
            const groupId = parseInt(e.target.dataset.groupId);
            console.trace("22 -->", 22);
            showGroupPointsModal(groupId);
          }
          console.log("e.target -->", e.target);
          // æ·»åŠ å­¦ç”ŸæŒ‰é’®
          if (e.target.classList.contains("add-student-btn")) {
            const groupId = parseInt(e.target.dataset.groupId);
            addStudentToGroup(groupId);
          }

          // ç§»é™¤å­¦ç”ŸæŒ‰é’®
          if (e.target.classList.contains("remove-student-btn")) {
            const studentId = parseInt(e.target.dataset.studentId);
            removeStudentFromGroup(studentId);
          }
        };

        // å†æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬
        groupsArea.addEventListener("click", handleGroupClick);
      }

      function renderLeaderboards() {
        // ä¸ªäººæ’è¡Œæ¦œ
        const studentList = document.getElementById("studentLeaderboardList");
        studentList.innerHTML = "";

        const sortedStudents = [...students].sort(
          (a, b) => b.totalPoints - a.totalPoints
        );

        // .slice(0, 10);
        sortedStudents.forEach((student, index) => {
          const rank = index + 1;
          const rankClass = rank <= 3 ? `rank-${rank}` : "";

          const item = document.createElement("div");
          item.className = "leaderboard-item";
          item.innerHTML = `
          <div class="rank-badge ${rankClass}">${rank}</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">${student.name}</div>
            <div class="leaderboard-points">${student.totalPoints}åˆ†</div>
          </div>
        `;
          studentList.appendChild(item);
        });

        // å°ç»„æ’è¡Œæ¦œ
        const groupList = document.getElementById("groupLeaderboardList");
        groupList.innerHTML = "";

        const groupPoints = groups.map((group) => {
          const groupStudents = students.filter((s) => s.groupId === group.id);
          // const totalPoints = groupStudents.reduce(
          //   (sum, s) => sum + s.totalPoints,
          //   0
          // );
          let totalPoints = 0;
          if (group.integral > 0) {
            // totalPoints = group.integral / groupStudents.length;
            totalPoints = group.integral;
          }

          return {
            name: group.name,
            points: totalPoints,
            memberCount: groupStudents.length,
          };
        });

        const sortedGroups = groupPoints.sort((a, b) => b.points - a.points);
        sortedGroups.forEach((group, index) => {
          const rank = index + 1;
          const rankClass = rank <= 3 ? `rank-${rank}` : "";

          const item = document.createElement("div");
          item.className = "leaderboard-item";
          item.innerHTML = `
          <div class="rank-badge ${rankClass}">${rank}</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">${group.name} (${group.memberCount}äºº)</div>
            <div class="leaderboard-points">${group.points}åˆ†</div>
          </div>
        `;
          groupList.appendChild(item);
        });
      }

      function renderRules() {
        const rulesList = document.getElementById("rulesList");
        rulesList.innerHTML = "";

        rules.forEach((rule, index) => {
          const item = document.createElement("div");
          const isPositive = rule.points > 0;
          item.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          margin-bottom: 6px;
          border-radius: 8px;
          background: var(--light);
          border-left: 4px solid ${isPositive ? "var(--ok)" : "var(--warn)"};
        `;

          const sign = rule.points > 0 ? "+" : "";
          item.innerHTML = `
          <span style="flex: 1; font-weight: 600;">${rule.name}</span>
          <span style="color: ${
            isPositive ? "var(--ok)" : "var(--warn)"
          }; font-weight: 800; margin-right: 12px;">${sign}${rule.points}</span>
          <button onclick="eidtRule(${index})" class="btn flat btn-sm" style="padding: 4px 8px;margin-right:10px;">ç¼–è¾‘</button>
          <button onclick="deleteRule(${index})" class="btn warn btn-sm" style="padding: 4px 8px;">åˆ é™¤</button>
        `;

          rulesList.appendChild(item);
        });
      }

      function renderShopItems() {
        const shopItemsEl = document.getElementById("shopItems");
        shopItemsEl.innerHTML = "";

        shopItems.forEach((item, index) => {
          const div = document.createElement("div");
          div.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          margin-bottom: 6px;
          border-radius: 8px;
          background: var(--light);
          border-left: 4px solid var(--accent1);
        `;

          div.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: 600;">${item.name}</div>
            <div style="display:flex;  align-items: flex-end;">
              <div style="color: var(--primary); font-weight: 800; font-size: 14px;">${item.cost} ç§¯åˆ† </div>
              <div style=" color:#a76969; font-weight: 800; font-size: 14px; margin-left:10px;   "> åº“å­˜:${item.stock} </div>
            </div>
          </div>
          <button onclick="editShopItem(${index})" class="btn flat btn-sm" style="padding: 4px 8px;margin-right:10px;">ç¼–è¾‘</button>
          <button onclick="deleteShopItem(${index})" class="btn warn btn-sm" style="padding: 4px 8px;">åˆ é™¤</button>
        `;

          shopItemsEl.appendChild(div);
        });
      }

      function renderEditRule() {
        const ruleBox = document.getElementById("shopItems");
        shopItemsEl.innerHTML = "";
        const div = document.createElement("div");

        shopItemsEl.appendChild(div);
      }

      //===================æ—¥å‘¨æœˆå¹´===========================
      // å·¥å…·å‡½æ•°ï¼šåˆ¤æ–­æ—¶é—´æ˜¯å¦åœ¨æŒ‡å®šå¤©æ•°å†…
      function isWithinDays(dateStr, days) {
        const now = new Date();
        const target = new Date(dateStr);
        const diffTime = now - target;
        const diffDays = diffTime / (1000 * 60 * 60 * 24);
        return diffDays < days;
      }

      // è®¡ç®—æ’è¡Œæ¦œ
      function getRanking(period = "day") {
        const daysMap = {
          day: 1,
          week: 7,
          month: 30,
          year: 365,
        };
        const days = daysMap[period];

        // æŒ‰å­¦ç”Ÿç»Ÿè®¡æŒ‡å®šå‘¨æœŸå†…è·å¾—çš„ç§¯åˆ†
        const pointsMap = {};

        students.forEach((student) => {
          const recentHistory = student.history.filter((record) =>
            isWithinDays(record.date, days)
          );

          const total = recentHistory.reduce(
            (sum, rec) => sum + (rec.points > 0 ? rec.points : 0),
            0
          );

          if (total > 0) {
            pointsMap[student.id] = {
              name: student.name,
              points: total,
              avatar: student.avatar || "ğŸ§", // å¯é€‰å¤´åƒ
            };
          }
        });

        // æŒ‰ç§¯åˆ†é™åºæ’åº
        return Object.entries(pointsMap)
          .map(([id, data]) => ({ id, ...data }))
          .sort((a, b) => b.points - a.points);
      }

      function showRankModal(period) {
        const titleMap = {
          day: "æ—¥æ¦œ",
          week: "å‘¨æ¦œ",
          month: "æœˆæ¦œ",
          year: "å¹´æ¦œ",
          class: "åˆ‡æ¢ç­çº§",
        };

        const ranking = getRanking(period);
        const modalContent = document.getElementById("modalContent");

        const rankHtml =
          ranking.length > 0
            ? ranking
                .map(
                  (item, index) => `
                  <div class="rank-item" style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                    <div style="width: 30px; font-weight: bold; color: ${
                      index === 0
                        ? "gold"
                        : index === 1
                        ? "silver"
                        : index === 2
                        ? "#b87333"
                        : "#666"
                    };">
                      ${["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"][index] || index + 1}
                    </div>
                    <div style="flex: 1; padding: 0 12px;">${item.name}</div>
                    <div style="color: var(--primary); font-weight: 600;">+${
                      item.points
                    }åˆ†</div>
                  </div>
                `
                )
                .join("")
            : '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</div>';

        modalContent.innerHTML = `
            <h3>${titleMap[period]}</h3>
            <div class="rank-list" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
              ${rankHtml}
            </div>
            <button onclick="closeModal('modal')" class="btn">å…³é—­</button>
          `;

        showModal("modal");
      }

      //===================æ—¥å‘¨æœˆå¹´ end===========================

      // =================================================================
      // æ‹–æ‹½åŠŸèƒ½
      // =================================================================

      function setupDragAndDrop() {
        document.querySelectorAll(".dropzone").forEach((zone) => {
          zone.addEventListener("dragover", function (e) {
            e.preventDefault();
            this.classList.add("drag-over");
          });

          zone.addEventListener("dragleave", function () {
            this.classList.remove("drag-over");
          });

          zone.addEventListener("drop", function (e) {
            e.preventDefault();
            this.classList.remove("drag-over");

            const studentId = parseInt(e.dataTransfer.getData("text/plain"));
            let groupId = this.getAttribute("data-group-id");
            console.log("this -->", this);
            console.dir(this);
            if (!groupId) {
              groupId = this.children[0].getAttribute("data-group-id");
            }

            if (groupId) {
              const studentIndex = students.findIndex(
                (s) => s.id === studentId
              );
              if (studentIndex !== -1) {
                students[studentIndex].groupId =
                  groupId != "ç©º" ? parseInt(groupId) : null;
                saveAllData();
                updateUI();
              }
            }
          });
        });
      }

      // =================================================================
      // éšæœºç‚¹ååŠŸèƒ½
      // =================================================================

      function showRollCallModal() {
        if (students.length === 0) {
          alert("è¯·å…ˆæ·»åŠ å­¦ç”Ÿï¼");
          return;
        }

        const modal = document.getElementById("rollCallModal");
        const studentListEl = document.getElementById("rollCallStudentList");
        const countSelectEl = document.getElementById("rollCallCount");

        // å¡«å……å­¦ç”Ÿåˆ—è¡¨
        studentListEl.innerHTML = "";
        students.forEach((student) => {
          const studentEl = document.createElement("div");
          studentEl.style.cssText = `
          display: flex;
          flex-direction: column;
          align-items: center;
          width: 80px;
          transition: all 0.3s ease;
        `;
          studentEl.dataset.id = student.id;

          const avatar = document.createElement("div");
          avatar.style.cssText = `
          width: 60px;
          height: 60px;
          border-radius: 50%;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 24px;
          font-weight: 700;
          color: white;
          margin-bottom: 8px;
          border: 3px solid transparent;
          background: ${
            student.gender === "male"
              ? "linear-gradient(135deg, var(--secondary) 0%, #a8dcc2 100%)"
              : "linear-gradient(135deg, var(--warn) 0%, #ffc7c0 100%)"
          };
        `;

          if (student.avatar) {
            avatar.innerHTML = `<img src="${student.avatar}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
          } else {
            avatar.textContent = student.name.charAt(0);
          }

          const name = document.createElement("div");
          name.style.cssText =
            "font-weight: 600; font-size: 12px; color: var(--text); text-align: center;";
          name.textContent = student.name;

          studentEl.appendChild(avatar);
          studentEl.appendChild(name);
          studentListEl.appendChild(studentEl);
        });

        // å¡«å……ä¸‹æ‹‰æ¡†
        countSelectEl.innerHTML = "";
        for (let i = 1; i <= students.length; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          countSelectEl.appendChild(option);
        }
        countSelectEl.value = 1;

        showModal("rollCallModal");
        resetRollCall();
      }

      function startRollCallAnimation() {
        const startBtn = document.getElementById("startRollCallBtn");
        const resetBtn = document.getElementById("resetRollCallBtn");
        const countSelect = document.getElementById("rollCallCount");
        const studentListEl = document.getElementById("rollCallStudentList");
        const studentElements = studentListEl.querySelectorAll("div[data-id]");

        const count = parseInt(countSelect.value);

        if (count > studentElements.length) {
          alert("æŠ½å–äººæ•°ä¸èƒ½è¶…è¿‡æ€»äººæ•°ï¼");
          return;
        }

        startBtn.disabled = true;
        countSelect.disabled = true;

        let animationDuration = 3000;
        let highlightInterval = 80;
        let lastHighlighted = -1;

        rollCallInterval = setInterval(() => {
          if (lastHighlighted !== -1) {
            const lastEl =
              studentElements[lastHighlighted].querySelector("div");
            lastEl.style.borderColor = "transparent";
            lastEl.style.transform = "scale(1)";
          }

          let randomIndex = Math.floor(Math.random() * studentElements.length);
          const currentEl = studentElements[randomIndex].querySelector("div");
          currentEl.style.borderColor = "var(--accent1)";
          currentEl.style.transform = "scale(1.1)";
          currentEl.style.boxShadow = "0 0 20px var(--accent1)";

          lastHighlighted = randomIndex;
        }, highlightInterval);

        setTimeout(() => {
          clearInterval(rollCallInterval);
          if (lastHighlighted !== -1) {
            const lastEl =
              studentElements[lastHighlighted].querySelector("div");
            lastEl.style.borderColor = "transparent";
            lastEl.style.transform = "scale(1)";
            lastEl.style.boxShadow = "";
          }

          // éšæœºé€‰æ‹©æœ€ç»ˆç»“æœ
          const indices = Array.from(studentElements.keys());
          const shuffledIndices = indices.sort(() => 0.5 - Math.random());
          const winningIndices = shuffledIndices.slice(0, count);

          // éšè—æœªé€‰ä¸­çš„å­¦ç”Ÿ
          studentElements.forEach((el, index) => {
            if (!winningIndices.includes(index)) {
              el.style.opacity = "0.2";
              el.style.transform = "scale(0.8)";
            } else {
              const avatar = el.querySelector("div");
              avatar.style.borderColor = "var(--ok)";
              avatar.style.transform = "scale(1.3)";
              avatar.style.boxShadow = "0 0 25px var(--ok)";
              el.style.margin = "0 20px";
            }
          });

          startBtn.style.display = "none";
          resetBtn.style.display = "inline-flex";
        }, animationDuration);
      }

      function resetRollCall() {
        clearInterval(rollCallInterval);
        const studentListEl = document.getElementById("rollCallStudentList");

        studentListEl.querySelectorAll("div[data-id]").forEach((el) => {
          const avatar = el.querySelector("div");
          avatar.style.borderColor = "transparent";
          avatar.style.transform = "scale(1)";
          avatar.style.boxShadow = "";
          el.style.opacity = "1";
          el.style.transform = "scale(1)";
          el.style.margin = "0";
        });

        const startBtn = document.getElementById("startRollCallBtn");
        const resetBtn = document.getElementById("resetRollCallBtn");
        const countSelect = document.getElementById("rollCallCount");

        startBtn.style.display = "inline-flex";
        startBtn.disabled = false;
        resetBtn.style.display = "none";
        countSelect.disabled = false;
      }

      // =================================================================
      // å…¶ä»–åŠŸèƒ½å‡½æ•°
      // =================================================================

      function addRule() {
        const ruleName = document.getElementById("ruleName").value.trim();
        const rulePoints = parseInt(
          document.getElementById("rulePoints").value
        );

        if (!ruleName || isNaN(rulePoints))
          return alert("è¯·å¡«å†™å®Œæ•´çš„è§„åˆ™ä¿¡æ¯");

        rules.push({
          id: generateId(),
          name: ruleName,
          points: rulePoints,
        });

        document.getElementById("ruleName").value = "";
        document.getElementById("rulePoints").value = "";

        saveAllData();
        renderRules();
      }

      function deleteRule(index) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ")) return;

        rules.splice(index, 1);
        saveAllData();
        renderRules();
      }
      let editRuleFun = null;

      function eidtRule(index) {
        const ruleNameInput = document.getElementById("edititemName");
        const ruleCostInput = document.getElementById("edititemCost");

        ruleNameInput.value = rules[index].name;
        ruleCostInput.value = rules[index].points;
        showModal("editRuleModal");

        // âœ… å®šä¹‰è¦ç»‘å®šçš„å‡½æ•°ï¼ˆä½¿ç”¨é—­åŒ…æ•è· indexï¼‰
        const handleSubmit = function () {
          const name = ruleNameInput.value.trim();
          const cost = parseInt(ruleCostInput.value);

          if (!name || isNaN(cost) || cost <= 0) {
            return alert("è¯·å¡«å†™å®Œæ•´çš„å•†å“ä¿¡æ¯");
          }

          rules[index].name = name;
          rules[index].points = cost;
          saveAllData();
          renderRules();
          closeModal("editRuleModal");
        };

        const btn = document.getElementById("editRulebtn");

        // ğŸ”´ å…³é”®ï¼šå¿…é¡»å…ˆç§»é™¤ä¸Šä¸€æ¬¡ç»‘å®šçš„åŒä¸€ä¸ªå‡½æ•°å¼•ç”¨
        if (editRuleFun) {
          btn.removeEventListener("click", editRuleFun);
          console.log("å·²ç§»é™¤ä¹‹å‰çš„ç›‘å¬å™¨");
        }

        // âœ… æ›´æ–°å¼•ç”¨ï¼Œå¹¶ç»‘å®šæ–°å‡½æ•°
        editRuleFun = handleSubmit;
        btn.addEventListener("click", editRuleFun);

        console.log("å½“å‰ç»‘å®šçš„å‡½æ•°å¼•ç”¨:", editRuleFun);
      }

      let editStoreItemFun = null;
      function editShopItem(index) {
        const storeCostInput = document.getElementById("editStoreCost");
        const storeStockInput = document.getElementById("editStoreStock");
        const storeNameInput = document.getElementById("editStoreName");

        storeCostInput.value = shopItems[index].cost;
        storeStockInput.value = shopItems[index].stock;
        storeNameInput.value = shopItems[index].name;

        showModal("editStoreModal");

        // âœ… å®šä¹‰è¦ç»‘å®šçš„å‡½æ•°ï¼ˆä½¿ç”¨é—­åŒ…æ•è· indexï¼‰
        const handleSubmit = function () {
          if (
            !storeNameInput.value ||
            isNaN(storeStockInput.value) ||
            storeStockInput.value <= 0 ||
            isNaN(storeCostInput.value) ||
            storeCostInput.value <= 0
          ) {
            return alert("è¯·å¡«å†™å®Œæ•´çš„å•†å“ä¿¡æ¯");
          }

          shopItems[index].name = storeNameInput.value;
          shopItems[index].cost = storeCostInput.value;
          shopItems[index].stock = storeStockInput.value;

          saveAllData();
          renderShopItems();
          closeModal("editStoreModal");
        };

        const btn = document.getElementById("editStoreItemBtn");

        // ğŸ”´ å…³é”®ï¼šå¿…é¡»å…ˆç§»é™¤ä¸Šä¸€æ¬¡ç»‘å®šçš„åŒä¸€ä¸ªå‡½æ•°å¼•ç”¨
        if (editStoreItemFun) {
          btn.removeEventListener("click", editStoreItemFun);
          console.log("å·²ç§»é™¤ä¹‹å‰çš„ç›‘å¬å™¨");
        }

        // âœ… æ›´æ–°å¼•ç”¨ï¼Œå¹¶ç»‘å®šæ–°å‡½æ•°
        editStoreItemFun = handleSubmit;
        btn.addEventListener("click", editStoreItemFun);

        console.log("å½“å‰ç»‘å®šçš„å‡½æ•°å¼•ç”¨:", editStoreItemFun);
      }

      function addShopItem() {
        const itemName = document.getElementById("itemName").value.trim();
        const itemCost = parseInt(document.getElementById("itemCost").value);
        const itemStock = parseInt(document.getElementById("itemStock").value);
        if (
          !itemName ||
          isNaN(itemCost) ||
          itemCost <= 0 ||
          isNaN(itemStock) ||
          itemStock <= 0
        )
          return alert("è¯·å¡«å†™å®Œæ•´çš„å•†å“ä¿¡æ¯");

        shopItems.push({
          id: generateId(),
          name: itemName,
          cost: itemCost,
          stock: itemStock,
        });
        document.getElementById("itemName").value = "";
        document.getElementById("itemCost").value = "";
        document.getElementById("itemStock").value = "";
        saveAllData();
        renderShopItems();
      }

      function addAwardItem() {
        const awardItem = document.querySelector("#awardName");
        if (!awardItem.value.trim()) {
          alert("å¥–å“åç§°ä¸èƒ½ä¸ºç©ºï¼");
          return;
        }
        if (awardList.length < 8) {
          awardList.push({ name: awardItem.value, id: generateId() });
          awardItem.value = "";
        } else {
          alert("æœ€å¤šå¯è®¾ç½®8ä¸ªå¥–å“");
          return;
        }

        saveAllData();

        updataAwaitUi();

        // showModal("setsetAwardModal");
      }

      function deleteAward(id) {
        const awardItemIndex = awardList.findIndex((s) => s.id == id);
        awardList.splice(awardItemIndex, 1);
        saveAllData();
        updataAwaitUi();
      }

      function deleteShopItem(index) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ")) return;

        shopItems.splice(index, 1);
        saveAllData();
        renderShopItems();
      }

      function resetAllStudentPoints() {
        if (!confirm("ç¡®å®šè¦å°†æ‰€æœ‰å­¦ç”Ÿçš„ç§¯åˆ†æ¸…é›¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼")) return;
        if (
          !confirm(
            "äºŒæ¬¡ç¡®è®¤ï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰å­¦ç”Ÿçš„ç§¯åˆ†å’Œç§¯åˆ†å†å²è®°å½•ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ"
          )
        )
          return;

        students.forEach((student) => {
          student.totalPoints = 0;
          student.usedPoints = 0;
          student.history = [];
        });

        saveAllData();
        updateUI();
        alert("æ‰€æœ‰å­¦ç”Ÿç§¯åˆ†å·²æ¸…é›¶ï¼");
      }

      // =================================================================
      // äº‹ä»¶ç›‘å¬å™¨è®¾ç½®
      // =================================================================

      function setupEventListeners() {
        // å­¦ç”Ÿç®¡ç†
        document
          .getElementById("addStudentBtn")
          .addEventListener("click", addStudent);

        // å°ç»„ç®¡ç†
        document
          .getElementById("addGroupBtn")
          .addEventListener("click", addGroup);

        // è§„åˆ™ç®¡ç†
        document
          .getElementById("addRuleBtn")
          .addEventListener("click", addRule);

        // å•†åº—ç®¡ç†
        document
          .getElementById("addItemBtn")
          .addEventListener("click", addShopItem);

        document
          .getElementById("addAwardBtn")
          .addEventListener("click", addAwardItem);

        // æ•°æ®ç®¡ç†
        document
          .getElementById("exportDataBtn")
          .addEventListener("click", exportData);
        document
          .getElementById("importDataBtn")
          .addEventListener("click", showImportModal);
        document
          .getElementById("parseFileBtn")
          .addEventListener("click", handleFileImport);
        document
          .getElementById("parseTextBtn")
          .addEventListener("click", handleTextImport);

        // åŠŸèƒ½æŒ‰é’®
        document
          .getElementById("randomRollCallBtn")
          .addEventListener("click", showRollCallModal);
        document
          .getElementById("resetAllPoints")
          .addEventListener("click", resetAllStudentPoints);

        // æœç´¢åŠŸèƒ½
        document
          .getElementById("searchBtn")
          .addEventListener("click", searchStudents);
        document
          .getElementById("studentSearchInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              searchStudents();
            }
          });
        document
          .getElementById("studentSearchInput")
          .addEventListener("input", function () {
            // å¦‚æœæœç´¢æ¡†è¢«æ¸…ç©ºï¼Œè‡ªåŠ¨æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿ
            if (this.value.trim() === "") {
              clearSearch();
            }
          });

        // å…¨å‘˜å’Œå¤šé€‰ç§¯åˆ†åŠŸèƒ½
        document
          .getElementById("globalAddPoints")
          .addEventListener("click", () => showGlobalPointsModal("add"));
        document
          .getElementById("globalSubtractPoints")
          .addEventListener("click", () => showGlobalPointsModal("subtract"));

        // æ–°çš„å¤šé€‰ç¼–è¾‘æ¨¡å¼
        document
          .getElementById("multiSelectMode")
          .addEventListener("click", enterMultiSelectMode);
        document
          .getElementById("exitMultiSelectMode")
          .addEventListener("click", exitMultiSelectMode);

        // å¤šé€‰æ“ä½œæŒ‰é’®
        document
          .getElementById("multiSelectAdd")
          .addEventListener("click", () => showMultiSelectPointsModal("add"));
        document
          .getElementById("multiSelectSubtract")
          .addEventListener("click", () =>
            showMultiSelectPointsModal("subtract")
          );
        document
          .getElementById("multiSelectDelete")
          .addEventListener("click", deleteSelectedStudents);

        // éšæœºç‚¹å
        document
          .getElementById("startRollCallBtn")
          .addEventListener("click", startRollCallAnimation);
        document
          .getElementById("resetRollCallBtn")
          .addEventListener("click", resetRollCall);

        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const tabId = this.getAttribute("data-tab");

            document
              .querySelectorAll(".tab-btn")
              .forEach((b) => b.classList.remove("active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((content) => content.classList.remove("active"));

            this.classList.add("active");
            document.getElementById(tabId).classList.add("active");
          });
        });

        // æ¨¡æ€æ¡†å…³é—­
        document.querySelectorAll(".close").forEach((btn) => {
          btn.addEventListener("click", function () {
            this.closest(".modal").style.display = "none";
          });
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        // window.addEventListener("click", function (event) {
        //   if (event.target.classList.contains("modal")) {
        //     event.target.style.display = "none";
        //   }
        // });
      }
      function updataAwaitUi() {
        const contentHtml = document.querySelector("#awardList");

        let awardListHtml = "";
        if (awardList.length > 0) {
          awardListHtml =
            '<div style="display: grid;  gap: 12px; margin-top: 16px;">';
          awardList.forEach((item) => {
            awardListHtml += `
              <div style="background: var(--light); border: 1px solid var(--line); border-radius: 12px; padding: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px;display: flex; align-items: center;justify-content: space-between;">
                  <div>${item.name}</div> 
                  <div class="btn warn" onclick="deleteAward(${item.id})">åˆ é™¤</div>
                </div>
              </div>`;
          });
          awardListHtml += "</div>";
        } else {
          awardListHtml = "<p>å¥–æ± æš‚æ— å¥–å“</p>";
        }
        contentHtml.innerHTML = awardListHtml;
      }

      // =================================================================
      // åˆå§‹åŒ–åº”ç”¨
      // =================================================================

      // å°†æ‰€æœ‰éœ€è¦åœ¨HTMLä¸­è°ƒç”¨çš„å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
      window.deleteGroup = deleteGroup;
      window.updateGroupName = updateGroupName;
      window.addStudentToGroup = addStudentToGroup;
      window.removeStudentFromGroup = removeStudentFromGroup;
      window.showGroupPointsModal = showGroupPointsModal;
      window.applyPointsToGroup = applyPointsToGroup;
      window.applyCustomPointsToGroup = applyCustomPointsToGroup;
      window.showPointsModal = showPointsModal;
      window.applyPoints = applyPoints;
      window.applyCustomPoints = applyCustomPoints;
      window.showHistoryModal = showHistoryModal;
      window.revertHistoryItem = revertHistoryItem;
      window.showShopModal = showShopModal;
      window.showShopModal2 = showShopModal2;
      window.copyUrl = copyUrl;

      window.purchaseItem = purchaseItem;
      window.purchaseItem2 = purchaseItem2;

      window.deleteStudent = deleteStudent;
      window.updateStudentName = updateStudentName;
      window.uploadAvatar = uploadAvatar;
      window.handleAvatarUpload = handleAvatarUpload;
      window.applyPointsToAllStudents = applyPointsToAllStudents;
      window.applyCustomPointsToAllStudents = applyCustomPointsToAllStudents;
      window.applyPointsToSelectedStudents = applyPointsToSelectedStudents;
      window.applyCustomPointsToSelectedStudents =
        applyCustomPointsToSelectedStudents;
      window.deleteRule = deleteRule;
      window.deleteShopItem = deleteShopItem;
      window.closeModal = closeModal;
      window.updataAwaitUi = updataAwaitUi;

      function initApp() {
        loadAllData();
        setupEventListeners();
        updateUI();
        console.log("ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿå·²åŠ è½½å®Œæˆ");
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", initApp);
    </script>

    <script>
      // å…¨å±€å˜é‡
      let systemTitle = "ç­çº§ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ";
      let systemSlogan = "åœ¨è¿™é‡Œï¼Œç§¯åˆ†è®°å½•æ¯ä¸€æ¬¡æˆé•¿ ğŸ†"; // æ ‡è¯­å˜é‡

      // æ ‡é¢˜ä¿®æ”¹åŠŸèƒ½
      document
        .getElementById("editTitleBtn")
        .addEventListener("click", function () {
          const newTitle = prompt("è¯·è¾“å…¥æ–°çš„ç³»ç»Ÿåç§°:", systemTitle);
          if (newTitle !== null && newTitle.trim() !== "") {
            systemTitle = newTitle.trim();
            document.getElementById("systemTitle").textContent = systemTitle;
            saveAllData(); // ä¿å­˜ä¿®æ”¹
            alert("ç³»ç»Ÿåç§°å·²æ›´æ–°");
          }
        });

      // æ ‡è¯­ä¿®æ”¹åŠŸèƒ½
      document
        .getElementById("editSloganBtn")
        .addEventListener("click", function () {
          const newSlogan = prompt("è¯·è¾“å…¥æ–°çš„æ ‡è¯­:", systemSlogan);
          if (newSlogan !== null && newSlogan.trim() !== "") {
            systemSlogan = newSlogan.trim();
            document.getElementById("systemSlogan").textContent = systemSlogan;
            saveAllData(); // ä¿å­˜ä¿®æ”¹
            alert("æ ‡è¯­å·²æ›´æ–°");
          }
        });

      // é¡¶éƒ¨æ¨¡å—éšè—æ˜¾ç¤º
      document.querySelector("#sun").addEventListener("click", function () {
        const s = document.querySelector(".hero");
        console.dir(s);
        if (s.style.height) {
          s.style.minHeight = "360px";
          s.style.height = "";
        } else {
          s.style.height = 78 + "px";
          s.style.minHeight = 78 + "px";
        }
      });
      // é¡µé¢åŠ è½½æ—¶è¯»å–æ•°æ®
      loadAllData();
    </script>
    <script>
      // =================================================================
      // è®¡æ—¶å™¨åŠŸèƒ½
      // =================================================================
      let timerInterval = null;
      let totalSeconds = 0;
      let isTimerRunning = false;

      // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
      function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return [
          h.toString().padStart(2, "0"),
          m.toString().padStart(2, "0"),
          s.toString().padStart(2, "0"),
        ].join(":");
      }

      // å¯åŠ¨è®¡æ—¶å™¨
      function startTimer() {
        if (isTimerRunning) return;

        // è·å–ç”¨æˆ·è¾“å…¥çš„æ—¶é—´
        const hours =
          parseInt(document.getElementById("timerHours").value) || 0;
        const minutes =
          parseInt(document.getElementById("timerMinutes").value) || 0;
        const seconds =
          parseInt(document.getElementById("timerSeconds").value) || 0;

        // è®¡ç®—æ€»ç§’æ•°ï¼Œå¦‚æœå·²ç»åœ¨è®¡æ—¶åˆ™ç»§ç»­
        totalSeconds =
          totalSeconds > 0
            ? totalSeconds
            : hours * 3600 + minutes * 60 + seconds;

        // ç¡®ä¿è‡³å°‘æœ‰1ç§’
        if (totalSeconds <= 0) {
          totalSeconds = 1;
        }

        isTimerRunning = true;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById("startTimerBtn").style.display = "none";
        document.getElementById("pauseTimerBtn").style.display = "inline-flex";

        // å¼€å§‹è®¡æ—¶
        timerInterval = setInterval(() => {
          totalSeconds--;
          document.getElementById("timerDisplay").textContent =
            formatTime(totalSeconds);

          // è®¡æ—¶ç»“æŸ
          if (totalSeconds <= 0) {
            clearInterval(timerInterval);
            isTimerRunning = false;
            document.getElementById("startTimerBtn").style.display =
              "inline-flex";
            document.getElementById("pauseTimerBtn").style.display = "none";
          }
        }, 1000);
      }

      // æš‚åœè®¡æ—¶å™¨
      function pauseTimer() {
        clearInterval(timerInterval);
        isTimerRunning = false;
        document.getElementById("startTimerBtn").style.display = "inline-flex";
        document.getElementById("pauseTimerBtn").style.display = "none";
      }

      // é‡ç½®è®¡æ—¶å™¨
      function resetTimer() {
        clearInterval(timerInterval);
        isTimerRunning = false;
        totalSeconds = 0;
        document.getElementById("timerDisplay").textContent = "00:00:00";
        document.getElementById("timerHours").value = "0";
        document.getElementById("timerMinutes").value = "0";
        document.getElementById("timerSeconds").value = "10";
        document.getElementById("startTimerBtn").style.display = "inline-flex";
        document.getElementById("pauseTimerBtn").style.display = "none";
      }

      // ç»‘å®šè®¡æ—¶å™¨æŒ‰é’®äº‹ä»¶
      function initTimer() {
        // æ‰“å¼€è®¡æ—¶å™¨æ¨¡æ€æ¡†
        document.getElementById("timerBtn").addEventListener("click", () => {
          showModal("timerModal");
        });

        // å…³é—­æŒ‰é’®
        document
          .querySelector("#timerModal .close")
          .addEventListener("click", () => {
            closeModal("timerModal");
            pauseTimer(); // å…³é—­æ—¶æš‚åœè®¡æ—¶
          });

        // è®¡æ—¶å™¨æ§åˆ¶æŒ‰é’®
        document
          .getElementById("startTimerBtn")
          .addEventListener("click", startTimer);
        document
          .getElementById("pauseTimerBtn")
          .addEventListener("click", pauseTimer);
        document
          .getElementById("resetTimerBtn")
          .addEventListener("click", resetTimer);
      }

      // åœ¨ç°æœ‰åˆå§‹åŒ–å‡½æ•°ä¸­æ·»åŠ è®¡æ—¶å™¨åˆå§‹åŒ–
      // æ‰¾åˆ°é¡µé¢ä¸­å·²æœ‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œæ·»åŠ  initTimer()
      // ä¾‹å¦‚åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨ï¼š
      document.addEventListener("DOMContentLoaded", function () {
        // å…¶ä»–åˆå§‹åŒ–ä»£ç ...
        initTimer();
      });
    </script>
    <script>
      // å¯†ç ç›¸å…³åŠŸèƒ½
      let isPasswordSet = false;
      let currentPasswordHash = null;
      const PASSWORD_KEY = "classPointsSystemPassword";

      // éªŒè¯å¯†ç 
      function verifyPassword(password) {
        return simpleHash(password) === currentPasswordHash;
      }
      // åˆå§‹åŒ–å¯†ç çŠ¶æ€
      function initPassword() {
        try {
          const savedHash = localStorage.getItem(PASSWORD_KEY);
          if (savedHash) {
            currentPasswordHash = savedHash;
            isPasswordSet = true;
            // æ˜¾ç¤ºå¯†ç éªŒè¯æ¡†
            showModal("passwordVerifyModal");
            // éšè—ä¸»å†…å®¹
            document.querySelector("main").style.display = "none";
            document.querySelector("aside").style.display = "none";
          }
        } catch (error) {
          console.error("åˆå§‹åŒ–å¯†ç ç³»ç»Ÿå¤±è´¥:", error);
        }
      }

      // ç®€å•çš„å“ˆå¸Œå‡½æ•°ï¼ˆå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å®‰å…¨çš„åŠ å¯†æ–¹å¼ï¼‰
      function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = (hash << 5) - hash + char;
          hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        return Math.abs(hash).toString();
      }

      // è®¾ç½®æ–°å¯†ç 
      function setNewPassword(newPassword) {
        if (newPassword.length < 6) {
          alert("å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½");
          return false;
        }

        currentPasswordHash = simpleHash(newPassword);
        localStorage.setItem(PASSWORD_KEY, currentPasswordHash);
        isPasswordSet = true;
        return true;
      }

      // æ¸…é™¤å¯†ç 
      function clearPassword(Password) {
        if (!isPasswordSet) return true;

        if (verifyPassword(Password)) {
          localStorage.removeItem(PASSWORD_KEY);
          currentPasswordHash = null;
          isPasswordSet = false;
          return true;
        }
        return false;
      }

      // å¯†ç ç›¸å…³äº‹ä»¶ç›‘å¬
      function setupPasswordEventListeners() {
        // å¯†ç è®¾ç½®æŒ‰é’®
        document
          .getElementById("passwordSettingsBtn")
          .addEventListener("click", () => {
            const passwordSettingsModal = document.getElementById(
              "passwordSettingsModal"
            );
            const currentPasswordSection = document.getElementById(
              "currentPasswordSection"
            );

            // å¦‚æœå·²æœ‰å¯†ç ï¼Œæ˜¾ç¤ºå½“å‰å¯†ç è¾“å…¥æ¡†
            if (isPasswordSet) {
              currentPasswordSection.style.display = "block";
              document.getElementById("currentPassword").value = "";
              document.getElementById("currentPasswordError").style.display =
                "none";
            } else {
              currentPasswordSection.style.display = "none";
            }

            // é‡ç½®è¡¨å•
            document.getElementById("newPassword").value = "";
            document.getElementById("confirmPassword").value = "";
            document.getElementById("passwordMismatch").style.display = "none";

            showModal("passwordSettingsModal");
          });

        // ä¿å­˜å¯†ç æŒ‰é’®
        document
          .getElementById("savePasswordBtn")
          .addEventListener("click", () => {
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword =
              document.getElementById("confirmPassword").value;

            // æ£€æŸ¥å¯†ç æ˜¯å¦ä¸€è‡´
            if (newPassword !== confirmPassword) {
              document.getElementById("passwordMismatch").style.display =
                "block";
              return;
            }

            // å¦‚æœå·²æœ‰å¯†ç ï¼ŒéªŒè¯å½“å‰å¯†ç 
            if (isPasswordSet) {
              const currentPassword =
                document.getElementById("currentPassword").value;
              if (!verifyPassword(currentPassword)) {
                document.getElementById("currentPasswordError").style.display =
                  "block";
                return;
              }
            }

            // è®¾ç½®æ–°å¯†ç 
            if (setNewPassword(newPassword)) {
              alert("å¯†ç è®¾ç½®æˆåŠŸ");
              closeModal("passwordSettingsModal");
            }
          });

        // æ¸…é™¤å¯†ç æŒ‰é’®
        document
          .getElementById("clearPasswordBtn")
          .addEventListener("click", () => {
            if (!isPasswordSet) {
              alert("å½“å‰æœªè®¾ç½®å¯†ç ");
              return;
            }
            confirm("ç¡®å®šè¦æ¸…é™¤å¯†ç å—ï¼Ÿæ¸…é™¤åä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ç³»ç»Ÿã€‚");
            if (confirm("ç¡®å®šè¦æ¸…é™¤å¯†ç å—ï¼Ÿæ¸…é™¤åä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ç³»ç»Ÿã€‚")) {
              const currentPassword =
                document.getElementById("currentPassword").value;

              if (verifyPassword(currentPassword)) {
                clearPassword(currentPassword);
                alert("å¯†ç å·²æ¸…é™¤");
                closeModal("passwordSettingsModal");
              } else {
                document.getElementById("currentPasswordError").style.display =
                  "block";
              }
            }
          });

        // å¯†ç éªŒè¯æäº¤
        document
          .getElementById("submitPasswordBtn")
          .addEventListener("click", () => {
            const password = document.getElementById("verifyPassword").value;
            if (verifyPassword(password)) {
              closeModal("passwordVerifyModal");
              // æ˜¾ç¤ºä¸»å†…å®¹
              document.querySelector("main").style.display = "block";
              document.querySelector("aside").style.display = "flex";
            } else {
              document.getElementById("passwordError").style.display = "block";
            }
          });
        // å¿˜è®°å¯†ç å¼¹æ¡†
        document
          .querySelector("#forgetPasswordBtn")
          .addEventListener("click", () => {
            closeModal("passwordVerifyModal");
            showModal("forgetPasswordModal");
          });
        document
          .querySelector("#removetPasswordBtn")
          .addEventListener("click", () => {
            // verifykey
            const secretKeyValue = document.querySelector("#verifykey").value;
            console.log("secretKeyValue -->", secretKeyValue);
            console.log("secretKey -->", secretKey);
            if (secretKey == secretKeyValue) {
              console.log("æ¸…é™¤æœ¬åœ°å¯†ç ï¼Œ -->");
              localStorage.removeItem(PASSWORD_KEY);
              document.getElementById("passwordError2").style.display = "none";
              document.querySelector("main").style.display = "block";
              document.querySelector("aside").style.display = "block";
              loadAllData();
              closeModal("forgetPasswordModal");
            } else {
              document.getElementById("passwordError2").style.display = "block";
            }
          });

        document
          .querySelector("#backPasswordBtn")
          .addEventListener("click", () => {
            closeModal("forgetPasswordModal");
            showModal("passwordVerifyModal");
          });

        // æŒ‰Enteré”®æäº¤å¯†ç 
        document
          .getElementById("verifyPassword")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              document.getElementById("submitPasswordBtn").click();
            }
          });
      }

      // è§„åˆ™ç›¸å…³äº‹ä»¶ç›‘å¬
      function setupIntegrationRuleEventListeners() {
        // è§„åˆ™æŒ‰é’®
        document
          .getElementById("integrationruleBtn")
          .addEventListener("click", () => {
            console.log("dianj -->");
            const ruleSettingsModal =
              document.getElementById("ruleSettingsModal");

            showModal("ruleSettingsModal");

            renderRules();
          });
      }

      // è§„åˆ™ç›¸å…³äº‹ä»¶ç›‘å¬
      function setupMallEventListeners() {
        // è§„åˆ™æŒ‰é’®
        document
          .getElementById("integralshoppingmallBtn")
          .addEventListener("click", () => {
            const ruleSettingsModal =
              document.getElementById("mallSettingsModal");

            showModal("mallSettingsModal");
            renderShopItems();
          });

        document.getElementById("removeAll").addEventListener("click", () => {
          // å¼¹å‡ºè¾“å…¥æ¡†ï¼Œæç¤ºç”¨æˆ·è¾“å…¥åå­—ï¼Œé»˜è®¤å€¼ä¸º "å°æ˜"
          if (confirm("æ¸…ç†æœ¬åœ°æ•°æ®åä¸å¯æ¢å¤ï¼è¯·ç¡®è®¤")) {
            // æ¸…é™¤æ‰€æœ‰ localStorage æ•°æ®
            localStorage.clear();
            loadAllData();

            updateUI();
            alert("æ¸…ç†æˆåŠŸ");
          }
        });

        document.getElementById("setsetAward").addEventListener("click", () => {
          // loadAllData();
          // updateUI();
          showModal("setsetAwardModal");
          updataAwaitUi();
        });
      }

      // åœ¨ç°æœ‰åˆå§‹åŒ–ä»£ç ä¸­æ·»åŠ 
      // åˆå§‹åŒ–åº”ç”¨
      function initApp() {
        loadAllData();
        updateUI();
        setupEventListeners();
        setupPasswordEventListeners(); // æ·»åŠ å¯†ç äº‹ä»¶ç›‘å¬
        setupIntegrationRuleEventListeners(); // æ·»åŠ è§„åˆ™æ—¶é—´ç›‘å¬
        setupMallEventListeners(); // æ·»åŠ ç§¯åˆ†å•†åº—ç›‘å¬
        initPassword(); // åˆå§‹åŒ–å¯†ç éªŒè¯
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", initApp);
    </script>
    <script>
      // å…¨é€‰å­¦ç”ŸåŠŸèƒ½å®ç°
      document
        .getElementById("selectAll")
        .addEventListener("click", function () {
          // è·å–æ‰€æœ‰å­¦ç”Ÿå¤é€‰æ¡†
          const checkboxes = document.querySelectorAll(
            ".multi-select-checkbox"
          );

          // æ£€æŸ¥æ˜¯å¦å·²æœ‰é€‰ä¸­é¡¹
          const hasUnchecked = Array.from(checkboxes).some(
            (checkbox) => !checkbox.checked
          );

          // å…¨é€‰æˆ–å–æ¶ˆå…¨é€‰
          checkboxes.forEach((checkbox) => {
            checkbox.checked = hasUnchecked;

            // è·å–å¯¹åº”çš„å­¦ç”ŸID
            const studentId = parseInt(checkbox.getAttribute("data-id"));

            if (hasUnchecked) {
              // å…¨é€‰ï¼šæ·»åŠ åˆ°é€‰ä¸­é›†åˆ
              multiSelectedStudentIds.add(studentId);
            } else {
              // å–æ¶ˆå…¨é€‰ï¼šä»é€‰ä¸­é›†åˆç§»é™¤
              multiSelectedStudentIds.delete(studentId);
            }
          });

          // æ›´æ–°é€‰ä¸­è®¡æ•°æ˜¾ç¤º
          document.getElementById("selectedCount").textContent =
            multiSelectedStudentIds.size;
        });
    </script>

    <script>
      // ç­çº§æ•°æ®ï¼Œå­¦ç”Ÿæ•°æ®å¯¼å…¥å¯¼å‡º
      // ================ å¯¼å…¥å­¦ç”Ÿä¿¡æ¯ =======================================
      document
        .getElementById("addStudentBtnFile")
        .addEventListener("click", function () {
          console.dir(document.getElementById("studentFileInput"));
          document.getElementById("studentFileInput").click();
        });

      document
        .getElementById("studentFileInput")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            const data = e.target.result;
            let parsedData;

            if (file.name.endsWith(".csv")) {
              parsedData = Papa.parse(data).data;
            } else if (
              file.name.endsWith(".xlsx") ||
              file.name.endsWith(".xls")
            ) {
              const workbook = XLSX.read(data, { type: "binary" });
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              parsedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            }

            // å¤„ç†è§£æåçš„æ•°æ®
            handleImportedStudents(parsedData);
          };

          if (file.name.endsWith(".csv")) {
            reader.readAsText(file);
          } else if (
            file.name.endsWith(".xlsx") ||
            file.name.endsWith(".xls")
          ) {
            reader.readAsBinaryString(file);
          }

          const studentFileInput = document.getElementById("studentFileInput");
          studentFileInput.files.length = 0;
          studentFileInput.baseURI = "";
          studentFileInput.formAction = "";
          studentFileInput.value = "";
        });

      function handleImportedStudents(data) {
        const nameIdx = data[0].indexOf("å§“å");
        const genderIdx = data[0].indexOf("æ€§åˆ«");

        if (nameIdx === -1 || genderIdx === -1) {
          alert("æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿åŒ…å«â€œå§“åâ€å’Œâ€œæ€§åˆ«â€åˆ—");
          return;
        }
        console.log("data -->", data);
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          const name = row[nameIdx];
          let gender = row[genderIdx];
          if (row[genderIdx] == "ç”·") {
            gender = "male";
          } else if (row[genderIdx] == "å¥³") {
            gender = "female";
          }
          if (name && gender) {
            // å‡è®¾ä½ æœ‰ä¸€ä¸ª students æ•°ç»„æ¥å­˜å‚¨å­¦ç”Ÿä¿¡æ¯
            students.push({
              id: generateId(),
              name: name.trim(),
              gender: gender,
              avatar: null,
              totalPoints: 0,
              usedPoints: 0,
              history: [],
              groupId: null,
            });

            const student = {};
          }
        }
        saveAllData();
        updateUI(); // æ›´æ–°ç•Œé¢æ˜¾ç¤º
      }

      // ================ å¯¼å…¥å­¦ç”Ÿä¿¡æ¯end =======================================

      // ================ å¯¼å‡ºå­¦ç”Ÿä¿¡æ¯ =======================================
      document
        .getElementById("downloadBtnFile")
        .addEventListener("click", function () {
          const wb = XLSX.utils.book_new();

          // åˆ›å»ºå·¥ä½œè¡¨æ•°æ®
          const wsData = [
            ["ç­çº§å­¦ç”Ÿä¿¡æ¯è¡¨"],
            ["å§“å", "æ€§åˆ«", "ç§¯åˆ†", "ç§¯åˆ†è·å–è®°å½•"],
          ];

          students.forEach((student) => {
            const historyStr = student.history
              .map((h) => h.reason)
              .join("ï¼Œ\n");
            wsData.push([
              student.name,
              student.gender == "male" ? "ç”·" : "å¥³",
              student.totalPoints,
              historyStr,
            ]);
          });

          const ws = XLSX.utils.aoa_to_sheet(wsData);
          XLSX.utils.book_append_sheet(wb, ws, "å­¦ç”Ÿä¿¡æ¯");

          // ç”Ÿæˆå¹¶ä¸‹è½½æ–‡ä»¶
          XLSX.writeFile(wb, "ç­çº§å­¦ç”Ÿä¿¡æ¯è¡¨.xlsx");
        });

      // ================ å¯¼å‡ºå­¦ç”Ÿä¿¡æ¯end =======================================

      // ================ åˆ‡æ¢ç­çº§ =======================================
      // ç¤ºä¾‹ç­çº§æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»æ¥å£è·å–ï¼‰
      function deleteClass(classId) {
        const classList = JSON.parse(localStorage.getItem("classPointsData"));
        console.log("classList -->", classList);
        if (classList && classList.length) {
          const classIndex = classList.findIndex((s) => s.classId == classId);
          if (
            confirm(
              `æ˜¯å¦åˆ é™¤${classList[classIndex].systemTitle} ç­çº§,è¯¥æ“ä½œä¸å¯æ’¤é”€ï¼ï¼`
            )
          ) {
            if (classList.length == 1) {
              alert("è‡³å°‘ç•™ä¸‹ä¸€ä¸ªç­çº§ï¼");
              return;
            }
            classList.splice(classIndex, 1);
            localStorage.setItem("classPointsData", JSON.stringify(classList));
            addClassUI("dle");
            loadAllData();
          }
        }
      }
      function addClassUI(type) {
        // å…ˆå­˜å–ä¸‹æ•°æ®

        let classList = localStorage.getItem("classPointsData");
        if (classList) {
          classes = JSON.parse(classList).map((i) => {
            return {
              id: i.classId,
              name: i.systemTitle,
              title: i.systemSlogan,
            };
          });
        } else {
          classes = [
            {
              id: classObj.id,
              name: systemTitle,
              title: systemSlogan,
            },
          ];
          saveAllData();
        }
        // æ„å»ºé¡µé¢å¼¹æ¡†
        let currentClass = JSON.parse(localStorage.getItem("classObj")); // å½“å‰ç­çº§
        const modalContent = document.getElementById("modalContent");
        let rankHtml = "";
        if (type == "add") {
          rankHtml =
            classes.length > 0
              ? classes
                  .map(
                    (item, index) => `
                     <div class="rank-item  classId_${item.id} ${
                      currentClass.id == item.id ? "active_rank_item" : ""
                    }" style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;border-radius: 5px; margin-bottom:8px;">
                       <div class="classId_${
                         item.id
                       }" style="flex: 1; padding: 0 12px;">${item.name}</div>
                       <div class="classId_${
                         item.id
                       }" style="color: var(--primary); font-weight: 600;">${
                      item.title
                    }</div>
                     </div>
                   `
                  )
                  .join("")
              : '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</div>';

          modalContent.innerHTML = `
               <h3>åˆ‡æ¢ç­çº§</h3>
               <div class="rank-list changeClass" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                 ${rankHtml}
               </div>
               <div style="margin-top:20px;">
                 <input
                     type="text"
                     class="form-control"
                     placeholder="ç­çº§åç§°"
                     style="max-width: 200px"
                     id="className"
                   />
                  <button id="addClass" class="btn">æ·»åŠ ç­çº§</button>
                 </div>
             `;

          showModal("modal");
          if (addClassInfo) {
            document
              .querySelector("#addClass")
              .removeEventListener("click", addClassInfo);
          }

          document
            .querySelector("#addClass")
            .addEventListener("click", addClassInfo);

          if (changeClassInfo) {
            document
              .querySelector(".changeClass")
              .removeEventListener("click", changeClassInfo);
          }

          document
            .querySelector(".changeClass")
            .addEventListener("click", changeClassInfo);
        } else if (type == "dle") {
          rankHtml =
            classes.length > 0
              ? classes
                  .map(
                    (item, index) => `
                     <div class="rank-item  classId_${item.id}" style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                       <div class="classId_${item.id}" style="flex: 1; padding: 0 12px;">${item.name}</div>
                       <div  onClick="deleteClass(${item.id})" class="classId_${item.id}" style="color: var(--warn); font-weight: 600;cursor: pointer;">åˆ é™¤</div>
                     </div>
                   `
                  )
                  .join("")
              : '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</div>';

          modalContent.innerHTML = `
               <h3>åˆ é™¤ç­çº§</h3>
               <div class="rank-list changeClass" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                 ${rankHtml}
               </div>
             `;

          showModal("modal");
        }
      }

      let addClassInfo, changeClassInfo, classes;
      function switchClasses(type = "add") {
        // æ·»åŠ ç­çº§
        addClassInfo = function () {
          const name = document.querySelector("#className").value;
          if (!name.trim()) {
            alert("ç­çº§åç§°ä¸èƒ½ä¸ºç©ºï¼");
            return;
          }
          let classList2 = localStorage.getItem("classPointsData");
          if (classList2) {
            classList2 = JSON.parse(classList2);
          }
          const data = {
            classId: classList2[classList2.length - 1].classId + 1,
            systemTitle: name,
            systemSlogan: "åœ¨è¿™é‡Œï¼Œç§¯åˆ†è®°å½•æ¯ä¸€æ¬¡æˆé•¿ ğŸ†",
            students: [],
            groups: [],
            rules: rules, // ä¿ç•™é»˜è®¤è§„åˆ™å¦‚æœæ²¡æœ‰ä¿å­˜çš„
            shopItems: [],
            timestamp: new Date().toISOString(),
          };

          let res = localStorage.getItem("classPointsData");
          if (res) {
            res = JSON.parse(res);
            res.push(data);
            localStorage.setItem("classPointsData", JSON.stringify(res));
            addClassUI(type);
          }
        };

        changeClassInfo = function (e) {
          // å½“å‰å¯¹è±¡æ ‡è¯†ï¼Œæœ¬åœ°å¯¹è±¡æ ‡è¯†æ›´æ”¹ï¼Œè°ƒç”¨ä¸€æ¬¡ä¿å­˜ï¼Œè°ƒç”¨ä¸€æ¬¡è·å–
          console.dir(e.target);
          let id;
          if (e.target.className.includes("classId_")) {
            id = e.target.className.split("_")[1];
            const target = classes.find((i) => i.id == id);
            localStorage.setItem(
              "classObj",
              JSON.stringify({ id: id, title: target.title, name: target.name })
            );
            addClassUI(type);
            loadAllData();
            updateUI();
          }
        };
        // document
        //   .querySelector("#addClass")
        //   .addEventListener("click", addClassInfo);
        addClassUI(type);
      }

      // è”ç³»ç®¡ç†å‘˜
      function concatAdmin() {
        // const contactAdminModal = document.querySelector('#contactAdminModal')

        showModal("contactAdminModal");
      }

      // ================ åˆ‡æ¢ç­çº§end =======================================
    </script>

    <script>
      // åˆå§‹å¥–å“æ•°æ®
      let prizes = awardList.map((i) => i.name);

      let isSpinning = false;
      let currentActive = -1;
      let gridOrder = [0, 1, 2, 5, 8, 7, 6, 3]; // å¯¹åº”DOMä¸­çš„å®é™…ä½ç½®
      if (prizes.length < 8) {
        console.log(" 8 - prizes.length -->");
        let index = 8 - prizes.length;
        for (let i = 0; i <= index; i++) {
          console.log("i -->", i);
          prizes.push("æœªä¸­å¥–");
        }
      }
      // ä¹å®«æ ¼ä½ç½®æ˜ å°„ (æŒ‰é¡ºæ—¶é’ˆé¡ºåº: å·¦ä¸Šâ†’ä¸Šâ†’å³ä¸Šâ†’å³â†’å³ä¸‹â†’ä¸‹â†’å·¦ä¸‹â†’å·¦)

      function closeLottery() {
        document.getElementById("lotteryModal").style.display = "none";
        // é‡ç½®çŠ¶æ€
        isSpinning = false;
        currentActive = -1;
      }

      function addPrize() {
        const input = document.getElementById("prizeInput");
        const prizeName = input.value.trim();

        if (prizeName && !prizes.includes(prizeName)) {
          if (prizes.length < 8) {
            prizes.push(prizeName);
            input.value = "";
            // updatePrizesList();
            updateGrid();
          } else {
            alert("ä¹å®«æ ¼æœ€å¤šåªèƒ½è®¾ç½®8ä¸ªå¥–å“å“¦ï¼");
          }
        } else if (prizes.includes(prizeName)) {
          alert("è¿™ä¸ªå¥–å“å·²ç»å­˜åœ¨å•¦ï¼");
        }
      }

      function removePrize(button) {
        const prizeTag = button.parentElement;
        const prizeName = prizeTag.textContent.replace("Ã—", "").trim();
        prizes = prizes.filter((prize) => prize !== prizeName);
        // updatePrizesList();
        updateGrid();
      }

      function updatePrizesList() {
        const prizesList = document.getElementById("prizesList");
        prizesList.innerHTML = "";

        if (prizes.length === 0) {
          prizesList.innerHTML =
            '<div style="color: #999; text-align: center; padding: 20px; font-style: italic;">æš‚æ— å¥–å“ï¼Œè¯·æ·»åŠ å¥–å“åå¼€å§‹æŠ½å¥–</div>';
          return;
        }

        prizes.forEach((prize) => {
          const prizeTag = document.createElement("div");
          prizeTag.className = "prize-tag";
          prizeTag.innerHTML = `
                    ${prize}
                    <button class="remove-prize" onclick="removePrize(this)">Ã—</button>
                `;
          prizesList.appendChild(prizeTag);
        });
      }

      function updateGrid() {
        const grid = document.getElementById("lotteryGrid");
        grid.innerHTML = "";
        prizes = awardList.map((i) => i.name);
        if (prizes.length < 8) {
          console.log(" 8 - prizes.length -->");
          let index = 8 - prizes.length;
          for (let i = 0; i <= index; i++) {
            console.log("i -->", i);
            prizes.push("æœªä¸­å¥–");
          }
        }
        // åˆ›å»ºä¹å®«æ ¼ (3x3)
        for (let i = 0; i < 9; i++) {
          const gridItem = document.createElement("div");
          gridItem.className = "grid-item";
          gridItem.setAttribute("data-index", i);

          if (i === 4) {
            // ä¸­å¿ƒä½ç½® - å¼€å§‹æŒ‰é’®
            gridItem.className += " center";
            gridItem.innerHTML = "å¼€å§‹<br>æŠ½å¥–";
            gridItem.onclick = startLottery;
          } else {
            // å¥–å“ä½ç½®
            const prizeIndex = gridOrder.indexOf(i);
            if (prizeIndex !== -1 && prizeIndex < prizes.length) {
              gridItem.textContent = prizes[prizeIndex];
            } else {
              gridItem.textContent = "?";
              gridItem.className += " empty";
            }
          }

          grid.appendChild(gridItem);
        }
      }

      function startLottery() {
        prizes = awardList.map((i) => i.name);
        if (prizes.length < 8) {
          console.log(" 8 - prizes.length -->");
          let index = 8 - prizes.length;
          for (let i = 0; i <= index; i++) {
            console.log("i -->", i);
            prizes.push("æœªä¸­å¥–");
          }
        }
        if (isSpinning || prizes.length === 0) return;

        if (prizes.length === 0) {
          alert("è¯·å…ˆæ·»åŠ å¥–å“åå†å¼€å§‹æŠ½å¥–ï¼");
          return;
        }

        isSpinning = true;
        const resultDiv = document.getElementById("result");
        resultDiv.className = "result";
        resultDiv.textContent = "ğŸ¯ æŠ½å¥–è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...";

        // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
        document.querySelectorAll(".grid-item").forEach((item) => {
          item.classList.remove("active");
        });

        let currentIndex = 0;
        let speed = 150; // åˆå§‹é€Ÿåº¦(æ¯«ç§’)
        let rounds = 0;
        const maxRounds = 3; // è½¬3åœˆ
        const totalSteps = maxRounds * 8; // æ€»æ­¥æ•°
        const finalPosition = Math.floor(Math.random() * awardList.length); // æœ€ç»ˆä¸­å¥–ä½ç½®
        const finalStep = totalSteps + finalPosition; // æœ€ç»ˆåœæ­¢çš„æ­¥æ•°

        function animate() {
          // æ¸…é™¤ä¸Šä¸€ä¸ªé«˜äº®
          if (currentActive >= 0) {
            const prevItem = document.querySelector(
              `[data-index="${gridOrder[currentActive]}"]`
            );
            if (prevItem && !prevItem.classList.contains("center")) {
              prevItem.classList.remove("active");
            }
          }

          // é«˜äº®å½“å‰ä½ç½®
          currentActive = currentIndex % 8;
          const currentItem = document.querySelector(
            `[data-index="${gridOrder[currentActive]}"]`
          );
          if (currentItem && !currentItem.classList.contains("center")) {
            currentItem.classList.add("active");
          }

          currentIndex++;

          // æ£€æŸ¥æ˜¯å¦åº”è¯¥åœæ­¢
          if (currentIndex >= finalStep) {
            // åœæ­¢æŠ½å¥–
            setTimeout(() => {
              let index = finalPosition;
              if (index == 0) {
                index = 7;
              } else {
                index = index - 1;
              }
              const winningPrize = prizes[index];

              const resultDiv = document.getElementById("result");
              resultDiv.className = "result winner";
              resultDiv.innerHTML = `
                            ğŸŠ æ­å–œä½ è·å¾—ï¼š<strong style="color: #e65100; font-size: 22px;">${winningPrize}</strong> ğŸŠ<br>
                            <small style="color: #666; font-weight: normal; font-size: 14px;">å†æ¬¡ç‚¹å‡»ä¸­å¤®æŒ‰é’®å¯ç»§ç»­æŠ½å¥–</small>
                        `;
              isSpinning = false;

              // 3ç§’åæ¸…é™¤é«˜äº®
              setTimeout(() => {
                if (currentActive >= 0) {
                  const activeItem = document.querySelector(
                    `[data-index="${gridOrder[currentActive]}"]`
                  );
                  if (activeItem) activeItem.classList.remove("active");
                }
              }, 3000);
            }, 800);
            return;
          }

          // åŠ¨æ€è°ƒæ•´é€Ÿåº¦ï¼Œæœ€åå‡ æ­¥é€æ¸å‡é€Ÿ
          const remainingSteps = finalStep - currentIndex;
          if (remainingSteps <= 10) {
            speed = 150 + (10 - remainingSteps) * 50; // é€æ¸å‡é€Ÿ
          } else if (currentIndex < 8) {
            speed = Math.max(80, speed - 10); // å¼€å§‹æ—¶åŠ é€Ÿ
          } else {
            speed = 80; // ä¸­é—´ä¿æŒç¨³å®šé€Ÿåº¦
          }

          setTimeout(animate, speed);
        }

        animate();
      }

      function openLottery() {
        document.getElementById("lotteryModal").style.display = "block";
        // updatePrizesList();
        updateGrid();
      }
    </script>
  </body>
</html>

