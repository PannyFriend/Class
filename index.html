<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>班级积分管理系统 - 整合增强版</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.staticfile.net/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      /* 第二个系统的清新配色方案 */
      :root {
        --cream: #fff8ee;
        --paper: #ffffff;
        --green: #a7d7c5;
        --green2: #bde3d5;
        --sun: #ffd45a;
        --ink: #3a3a3a;
        --sub: #8e8c84;
        --line: #efe7da;
        --accent: #f7c873;
        --warn: #ffb4a8;
        --ok: #9ed39e;
        /* --primary: #a7d7c5; */
        --primary: #69a790;

        --secondary: #bde3d5;
        --accent1: #ffd45a;
        --accent2: #9ed39e;
        --accent3: #f7c873;
        --text: #3a3a3a;
        --text-light: #8e8c84;
        --border: #efe7da;
        --light: #fff8ee;
        --white: #ffffff;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: var(--cream);
        font-family: "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei",
          system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
          sans-serif;
        color: var(--ink);
        line-height: 1.6;
        min-height: 100vh;
      }

      /* 头部样式 */
      header {
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .wrap {
        /* max-width: 1400px; */
        margin: 0 auto;
        padding: 0 30px;
      }
      /* 小屏幕设备（手机，屏幕宽度 < 768px） */
      @media (max-width: 767.98px) {
        .wrap {
          padding: 0 16px; /* 更窄的内边距，避免内容太靠边 */
        }
      }

      .hero {
        background: linear-gradient(180deg, var(--green), var(--green2));
        border-radius: 28px;
        box-shadow: 0 10px 30px rgba(74, 119, 104, 0.15);
        padding: 16px;
        border: 2px solid #cfece2;
        margin: 12px 0;
        transition: all 0.3s;
        overflow: hidden;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .logo {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: #fff;
        border: 2px solid #dff4ec;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
      }

      .title {
        font-size: 22px;
        margin: 0;
        font-weight: 900;
      }

      .sun {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--sun);
        border: 3px solid #eac24f;
        box-shadow: 0 6px 0 rgba(234, 194, 79, 0.35);
        margin-left: auto;
        cursor: pointer;
      }

      .bubble {
        display: inline-block;
        background: #fff;
        border: 2px solid var(--line);
        padding: 8px 12px;
        border-radius: 18px;
        margin-bottom: 10px;
        color: #5a5a5a;
      }

      /* 工具栏样式 */
      .toolbar-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin: 10px 0;
      }

      .header-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-start;
        margin-top: 10px;
      }

      /* 按钮样式 */
      .btn {
        border: 2px solid var(--line);
        background: var(--accent);
        color: #6a530b;
        padding: 8px 14px;
        border-radius: 999px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 0 #d9c08b;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        text-decoration: none;
        border: none;
      }

      .btn:hover {
        transform: translateY(1px);
        box-shadow: 0 3px 0 #d9c08b;
      }

      .btn:active {
        transform: translateY(2px);
        box-shadow: 0 2px 0 #d9c08b;
      }

      .btn.ghost {
        background: #fff;
        color: #5b775e;
        border-color: #bfe4d5;
        box-shadow: 0 4px 0 #bfe4d5;
      }

      .btn.flat {
        background: #fff9e9;
        color: #6b5a2a;
        border-color: #eadfcb;
        box-shadow: 0 4px 0 #e1cfaa;
      }

      .btn.warn {
        background: var(--warn);
        color: #6b2222;
        border-color: #f3b1a8;
        box-shadow: 0 4px 0 #f3b1a8;
      }

      .btn.ok {
        background: var(--ok);
        color: #194f19;
        border-color: #bde8bd;
        box-shadow: 0 4px 0 #bde8bd;
      }

      .btn.primary {
        background: var(--primary);
        color: #2d5a47;
        border-color: #8cc5a8;
        box-shadow: 0 4px 0 #8cc5a8;
      }

      .btn.secondary {
        background: var(--secondary);
        color: #2d5a47;
        border-color: #9fd4b8;
        box-shadow: 0 4px 0 #9fd4b8;
      }

      .btn.rule {
        background: #e9f3ff;
        color: #2a616b;
        border-color: #cbeae4;
        box-shadow: 0 4px 0 #aadce1;
      }

      .btn.mall {
        background: #f2ffe9;
        color: #4c6b2a;
        border-color: #dfeacb;
        box-shadow: 0 4px 0 #bbe1aa;
      }
      .btn-sm {
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 16px;
      }

      .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* 表单元素样式 */
      input,
      select,
      textarea {
        padding: 10px 12px;
        border: 2px solid var(--line);
        border-radius: 14px;
        background: #fff;
        font-family: inherit;
        font-size: 14px;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(167, 215, 197, 0.3);
      }

      .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid var(--line);
        border-radius: 14px;
        background: #fff;
      }

      /* 布局样式 */
      .layout {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 16px;
        margin-top: 16px;
      }

      @media (max-width: 1200px) {
        .layout {
          grid-template-columns: 1fr;
        }
      }

      .main-content {
        display: flex;
        gap: 20px;
      }

      .left-panel {
        flex: 2;
      }

      .right-panel {
        flex: 1;
        min-width: 320px;
      }

      /* 学生卡片样式 */
      .student-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        margin-top: 16px;
      }

      .student-list {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-top: 16px;
      }

      .student-card {
        flex: 0 0 calc(25% - 16px);
        /* 每行3个卡片 */
        box-sizing: border-box;
      }

      @media (max-width: 992px) {
        .student-card {
          flex: 0 0 calc(50% - 16px);
          /* 中等屏幕每行2个 */
        }
      }
      @media (max-width: 1500px) {
        .student-card {
          flex: 0 0 calc(33.333333333333% - 16px);
        }
      }
      @media (max-width: 576px) {
        .student-card {
          flex: 0 0 100%;
          /* 小屏幕每行1个 */
        }
      }

      @media (min-width: 1800px) {
        .student-card {
          flex: 0 0 calc(20% - 16px);
        }
      }

      @media (min-width: 2040px) {
        .student-card {
          flex: 0 0 calc(16.6666666% - 16px);
        }
      }

      .student-card {
        background: var(--paper);
        border: 2px solid var(--line);
        border-radius: 22px;
        box-shadow: 0 8px 0 #efe4cf;
        padding: 16px;
        position: relative;
        transition: all 0.3s ease;
        cursor: move;
      }

      .student-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 0 #efe4cf;
      }

      .student-card.male {
        border-left: 4px solid var(--secondary);
      }

      .student-card.female {
        border-left: 4px solid var(--warn);
      }

      .student-avatar {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid var(--line);
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 700;
        color: var(--text);
        cursor: pointer;
        margin: 0 auto 12px auto;
        position: relative;
        transition: all 0.2s ease;
      }

      .student-avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .student-avatar.male {
        background: linear-gradient(135deg, var(--secondary) 0%, #a8dcc2 100%);
        color: #2d5a47;
      }

      .student-avatar.female {
        background: linear-gradient(135deg, var(--warn) 0%, #ffc7c0 100%);
        color: #6b2222;
      }

      .student-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .student-info {
        text-align: left;
      }

      .student-name-container {
        margin-bottom: 8px;
      }

      .student-name-input {
        color: var(--text);
        font-family: inherit;
      }

      .student-name-input:focus {
        outline: none;
      }

      /* 多选复选框样式优化 */
      .multi-select-checkbox {
        position: absolute;
        top: 12px;
        left: 12px;
        width: 18px;
        height: 18px;
        display: none;
        z-index: 15;
        cursor: pointer;
        accent-color: var(--primary);
      }

      body.multi-select-mode .multi-select-checkbox {
        display: block;
      }

      body.multi-select-mode .student-controls {
        opacity: 0.5;
        pointer-events: none;
      }

      .student-controls {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
        margin-top: 12px;
      }

      .control-btn {
        padding: 8px 0;
        text-align: center;
        font-weight: 800;
        border: 2px solid var(--line);
        background: #fff;
        cursor: pointer;
        border-radius: 12px;
        font-size: 12px;
        transition: all 0.2s ease;
      }

      .control-btn:hover {
        transform: translateY(1px);
      }

      .plus-btn {
        background: #e6f6ec;
        color: #194f19;
      }

      .minus-btn {
        background: #ffeae5;
        color: #6b2222;
      }

      .history-btn {
        background: #edebff;
        color: #4a4a8a;
      }

      .shop-btn {
        background: #fff4d8;
        color: #6b5a2a;
      }

      .delete-btn {
        background: #f8f6f1;
        color: #666;
      }

      /* 侧边栏样式 */
      .side {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .panel {
        background: var(--paper);
        border: 2px solid var(--line);
        border-radius: 18px;
        box-shadow: 0 6px 0 #efe4cf;
        padding: 16px;
      }

      .panel h4 {
        margin: 0 0 12px;
        font-size: 16px;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .panel_rule {
        border: 0;
        box-shadow: none;
        padding: 0;
      }

      .leaderboard-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 580px;
        overflow-y: scroll;
      }

      .leaderboard-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: var(--light);
        border-radius: 12px;
        border: 1px solid var(--line);
      }

      .rank-badge {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 12px;
        border: 2px solid var(--line);
      }

      .rank-1 {
        background: #ffd76a;
        color: #6b5a2a;
      }

      .rank-2 {
        background: #e0e0e0;
        color: #666;
      }

      .rank-3 {
        background: #f3b493;
        color: #6b4a2a;
      }

      .leaderboard-info {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .leaderboard-name {
        font-weight: 600;
      }

      .leaderboard-points {
        font-weight: 800;
        color: var(--primary);
      }

      /* 模态框样式 */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      }

      .modal-content {
        background: var(--paper);
        border-radius: 18px;
        width: 90%;
        max-width: 600px;
        margin: 10vh auto;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        border: 2px solid var(--line);
      }

      .modal-header {
        padding: 20px 24px;
        background: var(--primary);
        color: #2d5a47;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 800;
        margin: 0;
      }

      .close {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #2d5a47;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      .modal-body {
        padding: 20px 24px;
        max-height: 70vh;
        overflow-y: auto;
      }

      .modal-footer {
        padding: 16px 24px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        border-top: 1px solid var(--line);
      }

      /* 标签页样式 */
      .tabs {
        display: flex;
        background: var(--paper);
        border: 2px solid var(--line);
        border-radius: 18px 18px 0 0;
        overflow: hidden;
      }

      .tab-btn {
        flex: 1;
        padding: 12px 16px;
        background: var(--light);
        color: var(--text);
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }

      .tab-btn:hover {
        background: #f0f8f4;
      }

      .tab-btn.active {
        background: var(--paper);
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
      }

      .tab-content {
        display: none;
        background: var(--paper);
        border: 2px solid var(--line);
        border-top: none;
        border-radius: 0 0 18px 18px;
        padding: 20px;
      }

      .tab-content.active {
        display: block;
      }

      /* 搜索框样式 */
      .search-container {
        margin-bottom: 16px;
      }

      /* 多选模式样式 */
      .multi-select-checkbox {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 18px;
        height: 18px;
        display: none;
      }

      body.multi-select-mode .multi-select-checkbox {
        display: block;
      }

      body.multi-select-mode .student-controls {
        opacity: 0.5;
        pointer-events: none;
      }

      /* 拖拽样式 */
      .dropzone {
        border: 2px dashed var(--line);
        border-radius: 12px;
        transition: all 0.3s ease;
      }

      .dropzone.drag-over {
        border-color: var(--primary);
        background: rgba(167, 215, 197, 0.1);
      }

      /* 动画效果 */
      .point-animation {
        position: absolute;
        z-index: 1000;
        font-weight: 800;
        font-size: 24px;
        animation: floatUp 1.2s forwards;
        pointer-events: none;
      }

      .point-animation.positive {
        color: var(--ok);
      }

      .point-animation.negative {
        color: var(--warn);
      }

      @keyframes floatUp {
        0% {
          opacity: 0;
          transform: translateY(0) scale(0.5);
        }

        20% {
          opacity: 1;
          transform: translateY(-20px) scale(1.2);
        }

        100% {
          opacity: 0;
          transform: translateY(-80px) scale(1);
        }
      }

      /* 分割线装饰 */
      .divider {
        height: 18px;
        background: radial-gradient(
            circle at 20px -8px,
            #fff 20px,
            rgba(0, 0, 0, 0) 21px
          )
          left/40px 18px repeat-x;
        margin: 8px 0;
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .toolbar-row {
          flex-direction: column;
          align-items: stretch;
        }

        .toolbar-row > * {
          width: 100%;
        }

        .header-controls {
          justify-content: center;
        }

        .student-list {
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        }

        .layout {
          grid-template-columns: 1fr;
        }
      }

      /* 规则选项样式 */
      .rules-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }

      .rule-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid var(--line);
      }

      .rule-option.positive {
        background: rgba(158, 211, 158, 0.1);
        border-color: var(--ok);
      }

      .rule-option.negative {
        background: rgba(255, 180, 168, 0.1);
        border-color: var(--warn);
      }

      .rule-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* 导入导出样式 */
      .import-help {
        background: var(--light);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 16px;
        font-size: 13px;
        color: var(--sub);
      }

      .import-help code {
        background: var(--paper);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
      }

      /* 版权信息 */
      .copyright {
        text-align: center;
        padding: 20px;
        color: var(--sub);
        font-size: 12px;
        margin-top: 40px;
      }

      /* 工具提示 */
      .tooltip {
        position: fixed;
        background: var(--text);
        color: var(--paper);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 1001;
        display: none;
        max-width: 200px;
      }

      /* 小组部分样式 */
      .group-section {
        width: 100%;
        margin-bottom: 24px;
      }

      .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--light);
        border: 2px solid var(--line);
        border-radius: 16px;
        margin-bottom: 12px;
      }

      .group-name {
        font-size: 16px;
        font-weight: 800;
        color: var(--text);
      }

      .group-stats {
        font-size: 13px;
        color: var(--sub);
      }

      .rank-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #eee;
      }

      .rank-item:hover {
        background: #f8f9fa;
      }
      .rank-tabs button {
        background: #ffe0e0;
        color: #6b5a2a;
        border-color: #eacbcb;
        box-shadow: 0 4px 0 #e1aaaa;
        margin: 20px 10px 0 0;
        padding: 10px 20px;
        border-radius: 6px;
      }

      .active_rank_item {
        background-color: #2d5a47;
        color: #fff;
      }
      .active_rank_item:hover {
        background-color: #2d5a47;
        color: #fff;
      }
      .diygrade {
        display: flex;
        gap: 12px;
        margin: 12px 0;
      }

      /* 小屏幕设备（手机，屏幕宽度 < 768px） */
      @media (max-width: 767.98px) {
        .diygrade {
          display: block;
        }
        .diygrade input {
          margin-bottom: 8px;
        }
        .diygrade button {
          display: block;
          margin-left: auto;
        }
      }

      .bubble_classList {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      @media (max-width: 767.98px) {
        .bubble_classList {
          display: block;
        }
      }

      /* 九宫格样式 */
      .lottery-container {
        display: inline-block;
        margin: 25px 0;
      }

      .lottery-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        width: 400px;
        height: 400px;
        background: linear-gradient(145deg, #f0f8f0, #e8f5e8);
        border-radius: 25px;
        padding: 20px;
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1),
          0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .grid-item {
        background: linear-gradient(135deg, #ffffff, #f8fff8);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #4a9d6f;
        font-weight: bold;
        font-size: 16px;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        border: 2px solid transparent;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .grid-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .grid-item.active {
        background: linear-gradient(135deg, #ff7043, #ff5722);
        color: white;
        transform: scale(1.05);
        border-color: #ff3d00;
        box-shadow: 0 0 25px rgba(255, 87, 34, 0.6),
          0 4px 15px rgba(0, 0, 0, 0.2);
        animation: pulse 0.6s ease-in-out;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .grid-item.center {
        background: linear-gradient(135deg, #4a9d6f, #2e7d4f);
        color: white;
        font-size: 18px;
        cursor: pointer;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .grid-item.center:hover {
        background: linear-gradient(135deg, #2e7d4f, #1b5e3f);
        transform: translateY(-2px) scale(1.02);
      }

      .grid-item.empty {
        background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
        color: #bbb;
        cursor: not-allowed;
        font-size: 24px;
      }

      @keyframes pulse {
        0% {
          transform: scale(1.05);
        }
        50% {
          transform: scale(1.12);
        }
        100% {
          transform: scale(1.05);
        }
      }

      .result {
        margin-top: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #e8f5e8, #d4f4d4);
        border-radius: 15px;
        font-size: 18px;
        font-weight: bold;
        color: #2e7d4f;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        border: 2px solid rgba(46, 125, 79, 0.2);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .result.winner {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        color: #e65100;
        border-color: rgba(230, 81, 0, 0.3);
        animation: celebrate 1s ease-in-out;
      }

      @keyframes celebrate {
        0%,
        100% {
          transform: scale(1);
        }
        25% {
          transform: scale(1.02);
        }
        50% {
          transform: scale(1.05);
        }
        75% {
          transform: scale(1.02);
        }
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        .main-container {
          padding: 20px;
        }

        .lottery-grid {
          width: 320px;
          height: 320px;
          padding: 15px;
          gap: 6px;
        }

        .grid-item {
          font-size: 14px;
        }

        .grid-item.center {
          font-size: 16px;
        }

        .prize-input {
          flex-direction: column;
        }

        .prize-input input {
          min-width: 100%;
        }

        .control-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .action-buttons {
          width: 100%;
        }

        .btn {
          flex: 1;
          justify-content: center;
        }
      }
    </style>
  </head>
  <!-- 
积分规则逻辑

1.小组同学加分，小组加分 支持（待添加历史记录给小组  区分类型，小组/学员）
2.小组加分，小组同学加分 支持 （待添加小组积分历史记录）
3.同学积分消费，只扣减学员分，不扣减小组分 已支持
4.小组积分消费（清零），只扣减小组分，同学不扣减 （待添加小组积分消费记录）
-->
  <body>
    <!-- 头部区域 -->
    <header>
      <div class="wrap">
        <div class="hero">
          <div class="brand">
            <div class="logo" id="logo">🍃</div>
            <div style="display: flex; align-items: center; gap: 8px">
              <h1 class="title" id="systemTitle">班级积分管理系统</h1>
              <button class="btn btn-sm" id="editTitleBtn" title="修改系统名称">
                <i class="fas fa-pencil"></i>
              </button>
            </div>

            <div class="sun"></div>
            <div id="sun" class="btn flat">展开</div>
          </div>
          <div class="bubble_classList">
            <div>
              <div class="bubble" id="systemSlogan">
                在这里，积分记录每一次成长 🏆
              </div>
              <button
                class="btn btn-sm"
                id="editSloganBtn"
                title="修改系统名称"
              >
                <i class="fas fa-pencil"></i>
              </button>
            </div>
            <div>
              <div
                class="classList btn primary"
                id="switchClasses"
                onclick="concatAdmin()"
              >
                联系管理员
              </div>
              <div
                class="classList btn flat"
                id="switchClasses"
                onclick="switchClasses('add')"
              >
                班级管理
              </div>
              <div
                class="classList btn warn"
                id="switchClasses"
                onclick="switchClasses('dle')"
              >
                删除班级
              </div>
            </div>
            <!-- 切换班级 -->
          </div>
          <!-- 学生管理工具栏 -->
          <div class="toolbar-row">
            <textarea
              id="studentNames"
              class="form-control"
              placeholder="输入学生姓名，每行一个学生姓名，回车分隔"
              style="min-width: 200px"
              rows="4"
            ></textarea>
            <div style="display: flex; gap: 10px">
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  background: #fff;
                  padding: 6px 12px;
                  border-radius: 20px;
                  border: 2px solid var(--line);
                "
              >
                <input type="radio" name="gender" value="male" checked /> 男生
              </label>
              <label
                style="
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  background: #fff;
                  padding: 6px 12px;
                  border-radius: 20px;
                  border: 2px solid var(--line);
                "
              >
                <input type="radio" name="gender" value="female" /> 女生
              </label>
            </div>
            <button class="btn ok" id="addStudentBtn">
              <i class="fas fa-plus"></i> 添加学生
            </button>

            <button class="btn ok" id="addStudentBtnFile">
              <i class="fas fa-upload"></i> 导入学生数据
            </button>
            <input
              type="file"
              id="studentFileInput"
              style="display: none"
              accept=".csv, .xlsx, .xls"
            />
            <button class="btn ok" id="downloadBtnFile">
              <i class="fas fa-download"></i> 导出学生数据
            </button>
          </div>

          <!-- 功能按钮组 -->
          <div class="header-controls">
            <button class="btn primary" id="randomRollCallBtn">
              <i class="fas fa-dice"></i> 随机点名
            </button>
            <button class="btn flat" id="timerBtn">
              <i class="fas fa-stopwatch"></i> 计时器
            </button>
            <!-- <button class="btn ghost" id="themeToggle"><i class="fas fa-palette"></i> 更换主题</button> -->
            <button class="btn secondary" id="exportDataBtn">
              <i class="fas fa-download"></i> 导出班级数据
            </button>
            <button class="btn ghost" id="importDataBtn">
              <i class="fas fa-upload"></i> 导入班级数据
            </button>
            <button class="btn warn" id="resetAllPoints">
              <i class="fas fa-eraser"></i> 积分清零
            </button>
            <button class="btn flat" id="passwordSettingsBtn">
              <i class="fas fa-lock"></i> 密码设置
            </button>

            <button class="btn rule" id="integrationruleBtn">
              <i class="fas fa-list-check"></i> 积分规则
            </button>

            <button class="btn rule" id="integralshoppingmallBtn">
              <i class="fas fa-store"></i> 积分商店
            </button>

            <button class="btn mall" id="setsetAward">
              <i class="fas fa-store"></i> 抽奖设置
            </button>

            <button class="btn mall" onclick="openLottery()">
              <i class="fas fa-store"></i> 去抽奖
            </button>

            <button class="btn warn" id="removeAll">
              <i class="fas fa-store"></i> 清理缓存
            </button>
          </div>
        </div>
      </div>
      <div class="divider"></div>
    </header>

    <!-- 主内容区 -->
    <div class="wrap">
      <div class="layout">
        <!-- 左侧主面板 -->
        <main>
          <!-- 标签页导航 -->
          <div class="tabs">
            <button class="tab-btn active" data-tab="students">
              <i class="fas fa-user-graduate"></i> 学生管理
            </button>
            <button class="tab-btn" data-tab="groups">
              <i class="fas fa-users"></i> 小组管理
            </button>
          </div>

          <!-- 学生管理标签页 -->
          <div id="students" class="tab-content active">
            <!-- 工具栏 -->
            <div
              style="
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 16px;
                align-items: center;
              "
            >
              <div style="display: flex; gap: 4px; align-items: center">
                <input
                  type="text"
                  id="studentSearchInput"
                  class="form-control"
                  placeholder="搜索学生姓名..."
                  style="max-width: 200px"
                />
                <button
                  class="btn primary btn-icon"
                  id="searchBtn"
                  title="搜索"
                >
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <button class="btn ok" id="globalAddPoints">
                <i class="fas fa-plus"></i> 全员加分
              </button>
              <button class="btn warn" id="globalSubtractPoints">
                <i class="fas fa-minus"></i> 全员减分
              </button>
              <button class="btn secondary" id="multiSelectMode">
                <i class="fas fa-check-double"></i> 多选编辑
              </button>
              <button
                class="btn ghost"
                id="exitMultiSelectMode"
                style="display: none"
              >
                <i class="fas fa-times"></i> 退出多选
              </button>
              <!-- 多选模式操作按钮 -->
              <div
                id="multiSelectActions"
                style="display: none; align-items: center"
              >
                <div style="margin-right: 15px">
                  <button class="btn secondary" id="selectAll">
                    <i class="fas fa-check-double"></i> 全选
                  </button>
                </div>

                <div
                  style="
                    display: block;
                    flex-wrap: wrap;
                    gap: 10px;
                    margin-bottom: 0px;
                    padding: 12px;
                    background: var(--light);
                    border-radius: 12px;
                    border: 2px solid var(--primary);
                  "
                >
                  <div
                    style="
                      color: var(--primary);
                      font-weight: 600;
                      width: 100%;
                      margin-bottom: 8px;
                    "
                  >
                    <i class="fas fa-info-circle"></i> 已选择
                    <span id="selectedCount">0</span> 名学生，请选择操作：
                  </div>
                  <button class="btn ok" id="multiSelectAdd">
                    <i class="fas fa-plus"></i> 加分
                  </button>
                  <button class="btn warn" id="multiSelectSubtract">
                    <i class="fas fa-minus"></i> 减分
                  </button>
                  <button class="btn flat" id="multiSelectDelete">
                    <i class="fas fa-trash"></i> 删除学生
                  </button>
                </div>
              </div>
            </div>

            <!-- 学生卡片列表 -->
            <div id="allStudents" class="student-list dropzone"></div>
          </div>

          <!-- 小组管理标签页 -->
          <div id="groups" class="tab-content">
            <!-- 小组创建 -->
            <div
              style="
                display: flex;
                gap: 12px;
                margin-bottom: 20px;
                align-items: center;
              "
            >
              <input
                type="text"
                id="groupName"
                class="form-control"
                placeholder="输入小组名称"
                style="max-width: 200px"
              />
              <button id="addGroupBtn" class="btn ok">
                <i class="fas fa-plus"></i> 添加小组
              </button>
            </div>

            <!-- 小组列表 -->
            <div id="groupsArea"></div>
          </div>
        </main>

        <!-- 右侧面板 -->
        <aside class="side">
          <div class="rank-tabs">
            <button class="btn" onclick="showRankModal('day')">日榜</button>
            <button class="btn" onclick="showRankModal('week')">周榜</button>
            <button class="btn" onclick="showRankModal('month')">月榜</button>
            <button class="btn" onclick="showRankModal('year')">年榜</button>
          </div>
          <!-- 个人排行榜 -->
          <div class="panel">
            <h4><i class="fas fa-medal"></i> 个人排行榜</h4>
            <div id="studentLeaderboardList" class="leaderboard-list"></div>
          </div>

          <!-- 小组排行榜 -->
          <div class="panel">
            <h4><i class="fas fa-users"></i> 小组排行榜</h4>
            <div id="groupLeaderboardList" class="leaderboard-list"></div>
          </div>

          <!-- 积分规则 -->
          <!-- <div class="panel">
            <h4><i class="fas fa-list-check"></i> 积分规则</h4>
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="ruleName"
                class="form-control"
                placeholder="规则名称"
                style="flex: 1"
              />
              <input
                type="number"
                id="rulePoints"
                class="form-control"
                placeholder="分值"
                style="width: 80px"
              />
              <button id="addRuleBtn" class="btn primary" style="padding: 8px">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              id="rulesList"
              style="max-height: 200px; overflow-y: auto"
            ></div>
          </div> -->

          <!-- 积分商店 -->
          <!-- <div class="panel">
            <h4><i class="fas fa-store"></i> 积分商店</h4>
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="itemName"
                class="form-control"
                placeholder="商品名称"
                style="flex: 1"
              />
              <input
                type="number"
                id="itemCost"
                class="form-control"
                placeholder="积分"
                style="width: 80px"
              />
              <button id="addItemBtn" class="btn primary" style="padding: 8px">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              id="shopItems"
              style="max-height: 200px; overflow-y: auto"
            ></div>
          </div> -->
        </aside>
      </div>
    </div>

    <!-- 模态框 -->
    <div id="modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">操作</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body" id="modalContent"></div>
      </div>
    </div>

    <!-- 随机点名模态框 -->
    <div id="rollCallModal" class="modal">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-header">
          <h3 class="modal-title">随机点名</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div
            id="rollCallStudentList"
            style="
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
              gap: 16px;
              padding: 20px;
              min-height: 300px;
              align-items: center;
            "
          ></div>
        </div>
        <div class="modal-footer">
          <label>抽取人数:</label>
          <select
            id="rollCallCount"
            style="width: auto; margin-left: 8px; margin-right: 16px"
          ></select>
          <button id="startRollCallBtn" class="btn primary">
            <i class="fas fa-play"></i> 开始
          </button>
          <button
            id="resetRollCallBtn"
            class="btn secondary"
            style="display: none"
          >
            <i class="fas fa-redo"></i> 重来
          </button>
        </div>
      </div>
    </div>

    <!-- 数据导入模态框 -->
    <div id="importModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">导入数据</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="import-help">
            支持 <strong>JSON</strong>、<strong>text</strong>
          </div>
          <div style="display: flex; gap: 12px; margin-bottom: 16px">
            <input
              type="file"
              id="importFile"
              accept=".json,.txt"
              class="form-control"
            />
            <button type="button" id="parseFileBtn" class="btn primary">
              读取文件
            </button>
          </div>
          <textarea
            id="importText"
            class="form-control"
            rows="8"
            placeholder="或在此粘贴…（Excel复制的表格会以TSV格式粘贴）"
            style="margin-bottom: 16px"
          ></textarea>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('importModal')"
          >
            取消
          </button>
          <button type="button" id="parseTextBtn" class="btn ok">
            解析并导入
          </button>
        </div>
      </div>
    </div>
    <!-- 计时器模态框 -->
    <div id="timerModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3 class="modal-title">计时器</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body" style="text-align: center; padding: 30px 0">
          <div
            id="timerDisplay"
            style="
              font-size: 48px;
              font-weight: bold;
              margin: 20px 0;
              color: var(--text);
            "
          >
            00:00:00
          </div>
          <div
            style="
              display: flex;
              justify-content: center;
              gap: 15px;
              margin-top: 30px;
            "
          >
            <div style="text-align: center; margin: 0 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  font-size: 14px;
                  color: var(--text-light);
                "
                >小时</label
              >
              <input
                type="number"
                id="timerHours"
                class="form-control"
                value="0"
                min="0"
                max="23"
                style="width: 80px; text-align: center"
              />
            </div>
            <div style="text-align: center; margin: 0 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  font-size: 14px;
                  color: var(--text-light);
                "
                >分钟</label
              >
              <input
                type="number"
                id="timerMinutes"
                class="form-control"
                value="0"
                min="0"
                max="59"
                style="width: 80px; text-align: center"
              />
            </div>
            <div style="text-align: center; margin: 0 10px">
              <label
                style="
                  display: block;
                  margin-bottom: 5px;
                  font-size: 14px;
                  color: var(--text-light);
                "
                >秒钟</label
              >
              <input
                type="number"
                id="timerSeconds"
                class="form-control"
                value="10"
                min="0"
                max="59"
                style="width: 80px; text-align: center"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="startTimerBtn" class="btn ok">
            <i class="fas fa-play"></i> 开始
          </button>
          <button
            id="pauseTimerBtn"
            class="btn secondary"
            style="display: none"
          >
            <i class="fas fa-pause"></i> 暂停
          </button>
          <button id="resetTimerBtn" class="btn ghost">
            <i class="fas fa-redo"></i> 重置
          </button>
        </div>
      </div>
    </div>

    <!-- 添加密码验证模态框 -->
    <div
      id="passwordVerifyModal"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background-color: rgba(0, 0, 0, 0.5);
      "
    >
      <!-- 遮罩容器，用于居中模态框内容 -->
      <div
        style="
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100%;
        "
      >
        <div
          class="modal-content"
          style="
            max-width: 400px;
            width: 100%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
          "
        >
          <div
            class="modal-header"
            style="padding: 16px; border-bottom: 1px solid #eee"
          >
            <h3
              class="modal-title"
              style="margin: 0; font-size: 1.2rem; color: #333"
            >
              请输入密码
            </h3>
          </div>
          <div class="modal-body" style="padding: 20px">
            <p style="margin: 0 0 16px 0; color: #666">
              该系统已设置密码保护，请输入密码访问
            </p>
            <input
              type="password"
              id="verifyPassword"
              class="form-control"
              placeholder="请输入密码"
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                margin-top: 16px;
                box-sizing: border-box;
              "
            />
            <div
              style="color: var(--warn); margin-top: 8px; display: none"
              id="passwordError"
            >
              密码错误，请重新输入
            </div>
          </div>
          <div
            class="modal-footer"
            style="padding: 16px; border-top: 1px solid #eee; text-align: right"
          >
            <button
              type="button"
              id="forgetPasswordBtn"
              class="btn warn"
              style="
                padding: 8px 16px;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              忘记密码
            </button>
            <button
              type="button"
              id="submitPasswordBtn"
              class="btn ok"
              style="
                padding: 8px 16px;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              确认
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 添加密码验证模态框 -->
    <div
      id="forgetPasswordModal"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background-color: rgba(0, 0, 0, 0.5);
      "
    >
      <!-- 遮罩容器，用于居中模态框内容 -->
      <div
        style="
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100%;
        "
      >
        <div
          class="modal-content"
          style="
            max-width: 400px;
            width: 100%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            overflow: hidden;
          "
        >
          <div
            class="modal-header"
            style="padding: 16px; border-bottom: 1px solid #eee"
          >
            <h3
              class="modal-title"
              style="margin: 0; font-size: 1.2rem; color: #333"
            >
              请输入管理员密钥
            </h3>
          </div>
          <div class="modal-body" style="padding: 20px">
            <p style="margin: 0 0 16px 0; color: #666">
              输入管理员密钥，以清除密码
            </p>
            <input
              type="password"
              id="verifykey"
              class="form-control"
              placeholder="请输入管理员密钥"
              style="
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                margin-top: 16px;
                box-sizing: border-box;
              "
            />
            <div
              style="color: var(--warn); margin-top: 8px; display: none"
              id="passwordError2"
            >
              密码错误，请重新输入
            </div>
          </div>
          <div
            class="modal-footer"
            style="padding: 16px; border-top: 1px solid #eee; text-align: right"
          >
            <button
              type="button"
              id="backPasswordBtn"
              class="btn flat"
              style="
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              返回
            </button>
            <button
              type="button"
              id="removetPasswordBtn"
              class="btn ok"
              style="
                padding: 8px 16px;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              确认
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 添加密码设置模态框 -->
    <div id="passwordSettingsModal" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <div class="modal-header">
          <h3 class="modal-title">密码设置</h3>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div
            id="currentPasswordSection"
            style="display: none; margin-bottom: 16px"
          >
            <label style="display: block; margin-bottom: 8px">当前密码</label>
            <input
              type="password"
              id="currentPassword"
              class="form-control"
              placeholder="请输入当前密码"
            />
            <div
              style="color: var(--warn); margin-top: 8px; display: none"
              id="currentPasswordError"
            >
              当前密码错误
            </div>
          </div>

          <div style="margin-bottom: 16px">
            <label style="display: block; margin-bottom: 8px">新密码</label>
            <input
              type="password"
              id="newPassword"
              class="form-control"
              placeholder="请输入新密码（至少6位）"
            />
          </div>

          <div>
            <label style="display: block; margin-bottom: 8px">确认新密码</label>
            <input
              type="password"
              id="confirmPassword"
              class="form-control"
              placeholder="请再次输入新密码"
            />
            <div
              style="color: var(--warn); margin-top: 8px; display: none"
              id="passwordMismatch"
            >
              两次输入的密码不一致
            </div>
          </div>

          <div style="margin-top: 20px">
            <button id="clearPasswordBtn" class="btn warn" style="width: 100%">
              <i class="fas fa-unlock"></i> 清除密码
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('passwordSettingsModal')"
          >
            取消
          </button>
          <button type="button" id="savePasswordBtn" class="btn ok">
            保存密码
          </button>
        </div>
      </div>
    </div>
    <!-- 积分规则模态框 -->
    <div id="ruleSettingsModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h4><i class="fas fa-list-check"></i> 积分规则</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="ruleName"
                class="form-control"
                placeholder="规则名称"
                style="flex: 1"
              />
              <input
                type="number"
                id="rulePoints"
                class="form-control"
                placeholder="分值"
                style="width: 80px"
              />
              <button id="addRuleBtn" class="btn primary" style="padding: 8px">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              id="rulesList"
              style="max-height: 300px; overflow-y: auto"
            ></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('ruleSettingsModal')"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 积分商店模态框 -->
    <div id="mallSettingsModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> 积分商店</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="itemName"
                class="form-control"
                placeholder="商品名称"
                style="flex: 1"
              />
              <input
                type="number"
                id="itemStock"
                class="form-control"
                placeholder="库存"
                style="width: 80px"
              />
              <input
                type="number"
                id="itemCost"
                class="form-control"
                placeholder="积分"
                style="width: 80px"
              />
              <button id="addItemBtn" class="btn primary" style="padding: 8px">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              id="shopItems"
              style="max-height: 400px; overflow-y: auto"
            ></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('mallSettingsModal')"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!--抽奖设置模态框 -->
    <div id="setsetAwardModal" class="modal">
      <div class="modal-content" style="max-width: 600px; text-align: center">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> 抽奖设置</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="awardName"
                class="form-control"
                placeholder="奖品名称"
                style="flex: 1"
              />
              <button id="addAwardBtn" class="btn primary" style="padding: 8px">
                添加
              </button>
            </div>
            <div
              id="awardList"
              style="max-height: 400px; overflow-y: auto"
            ></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('setsetAwardModal')"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 编辑规则模态框 -->
    <div id="editRuleModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> 编辑积分规则</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <input
                type="text"
                id="edititemName"
                class="form-control"
                placeholder="商品名称"
                style="flex: 1"
              />

              <input
                type="number"
                id="edititemCost"
                class="form-control"
                placeholder="积分"
                style="width: 80px"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('editRuleModal')"
          >
            关闭
          </button>
          <button type="button" class="btn flat" id="editRulebtn">确定</button>
        </div>
      </div>
    </div>

    <!-- 编辑商店单品模态框 -->
    <div id="editStoreModal" class="modal">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> 编辑商品</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="panel panel_rule">
            <div style="display: flex; gap: 8px; margin-bottom: 12px">
              <div style="flex: 1">
                <p style="margin: 0 0 5px 5px; color: #999; font-size: 14px">
                  商品名称
                </p>
                <input
                  type="text"
                  id="editStoreName"
                  class="form-control"
                  placeholder="商品名称"
                  style="flex: 1"
                />
              </div>
              <div>
                <p style="margin: 0 0 5px 5px; color: #999; font-size: 14px">
                  库存
                </p>
                <input
                  type="number"
                  id="editStoreStock"
                  class="form-control"
                  placeholder="库存"
                  style="width: 80px"
                />
              </div>
              <div>
                <p style="margin: 0 0 5px 5px; color: #999; font-size: 14px">
                  积分
                </p>
                <input
                  type="number"
                  id="editStoreCost"
                  class="form-control"
                  placeholder="积分"
                  style="width: 80px"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('editStoreModal')"
          >
            关闭
          </button>
          <button type="button" class="btn flat" id="editStoreItemBtn">
            确定
          </button>
        </div>
      </div>
    </div>

    <!-- 九宫格抽奖模态框 -->
    <div class="modal" id="lotteryModal">
      <div class="modal-content" style="text-align: center">
        <div class="modal-header">
          <h2 class="modal-title">🎉 九宫格抽奖</h2>
          <button class="close">&times;</button>
        </div>
        <!-- 九宫格抽奖区域 -->
        <div class="lottery-container">
          <div class="lottery-grid" id="lotteryGrid">
            <!-- 九宫格会通过JS动态生成 -->
          </div>
        </div>

        <!-- 结果显示区域 -->
        <div class="result" id="result">
          点击九宫格中央的"开始"按钮开始抽奖！🍀
        </div>
      </div>
    </div>

    <!-- // 联系管理员 -->
    <!--抽奖设置模态框 -->
    <div id="contactAdminModal" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h4><i class="fas fa-store"></i> 管理员信息</h4>
          <button class="close">&times;</button>
        </div>
        <div class="modal-body">
          <div
            class="panel panel_rule"
            style="color: #2d5a47; font-weight: 700; font-size: 18px"
          >
            <div style="margin-bottom: 10px">小红书：赛尔号啊</div>

            <div style="margin-bottom: 10px">id/微信：Lidddd1122</div>

            <button type="button" class="btn flat" onclick="copyUrl()">
              复制店铺链接
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn ghost"
            onclick="closeModal('contactAdminModal')"
          >
            关闭
          </button>
        </div>
      </div>
    </div>
    <!-- 版权信息 -->
    <div class="copyright">
      赛尔号 班级积分管理系统 - 整合增强版 © 2025 | 功能完善，操作便捷
    </div>

    <!-- 工具提示 -->
    <div id="tooltip" class="tooltip"></div>

    <script>
      const secretKey = "Xy7kL9mN";
      // =================================================================
      // 全局变量和数据结构
      // =================================================================
      let classObj = {
        id: 1001,
        name: "班级积分管理系统",
        title: "在这里，积分记录每一次成长 🏆",
      };
      let students = [];
      let groups = [];
      let rules = [
        { id: generateId(), name: "回答问题正确", points: 1 },
        { id: generateId(), name: "认真完成作业", points: 2 },
        { id: generateId(), name: "帮助同学", points: 3 },
        { id: generateId(), name: "课堂表现优秀", points: 5 },
        { id: generateId(), name: "比赛获奖", points: 10 },
        { id: generateId(), name: "扰乱课堂", points: -2 },
        { id: generateId(), name: "作业不完整", points: -1 },
        { id: generateId(), name: "迟到", points: -1 },
        { id: generateId(), name: "不尊重他人", points: -3 },
      ];
      let shopItems = [];
      let isMultiSelectMode = false;
      let multiSelectedStudentIds = new Set();
      let rollCallInterval = null;
      let awardList = [
        { id: generateId(), name: "笔记本" },
        { id: generateId(), name: "圆珠笔" },
        { id: generateId(), name: "铅笔" },
        { id: generateId(), name: "水彩笔" },
      ];
      // =================================================================
      // 工具函数
      // =================================================================

      function generateId() {
        return Date.now() + Math.floor(Math.random() * 10000);
      }
      // 获取字符串的字节长度
      function getByteLength(str) {
        // 使用 encodeURIComponent 来获取接近真实字节长度的结果
        // 这种方法虽然不是最准确的，但可以作为一个近似值
        return encodeURIComponent(str).replace(/%../g, "x").length;
      }
      // 计算 本地存储大小
      function calculateLocalStorageSize() {
        let totalLength = 0;
        // 遍历 localStorage 的所有键
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          // 计算键和值的总长度
          totalLength += getByteLength(key) + getByteLength(value);
        }
        return (totalLength / (1024 * 1024)).toFixed(2) + "M";
      }
      function saveAllData() {
        let dataList = JSON.parse(localStorage.getItem("classPointsData"));
        const currentClass = JSON.parse(localStorage.getItem("classObj"));
        classObj = currentClass;
        try {
          const data = {
            classId: currentClass.id,
            systemTitle: systemTitle, // 保存系统标题
            systemSlogan: systemSlogan, // 保存系统标语
            students: students,
            groups: groups,
            rules: rules,
            shopItems: shopItems,
            awardList: awardList,

            timestamp: new Date().toISOString(),
          };

          console.log("data -->", data);

          if (!dataList || !dataList.length) {
            dataList = [data];
          } else {
            dataList.forEach((i) => {
              if (i.classId == currentClass.id) {
                i.systemTitle = data.systemTitle;
                i.systemSlogan = data.systemSlogan;
                i.students = data.students;
                i.groups = data.groups;
                i.rules = data.rules;
                i.shopItems = data.shopItems;
                i.timestamp = data.timestamp;
                i.awardList = data.awardList;
              }
            });
          }

          localStorage.setItem("classPointsData", JSON.stringify(dataList));
          localStorage.setItem("classObj", JSON.stringify(currentClass));
        } catch (error) {
          console.error("保存数据失败:", error);
          alert("保存数据失败，请检查浏览器存储权限");
        }

        const size = calculateLocalStorageSize();
      }

      function loadAllData() {
        try {
          const class_obj = JSON.parse(localStorage.getItem("classObj"));
          const savedData = localStorage.getItem("classPointsData");

          if (savedData) {
            const data = JSON.parse(savedData).find((i) => {
              return class_obj.id == i.classId;
            });
            classId = class_obj?.id || 1001;
            students = data?.students || [];
            groups = data?.groups || [];
            rules = data?.rules || rules; // 保留默认规则如果没有保存的
            shopItems = data?.shopItems || [];
            awardList = data?.awardList || [];

            if (data?.systemTitle) {
              systemTitle = data.systemTitle;
              document.getElementById("systemTitle").textContent = systemTitle;
            }

            // 读取系统标语
            if (data.systemSlogan) {
              systemSlogan = data.systemSlogan;
              document.getElementById("systemSlogan").textContent =
                systemSlogan;
            }
            console.log("从本地存储加载数据成功");
          } else {
            students = [];
            groups = [];
            rules = rules; // 保留默认规则如果没有保存的
            shopItems = [];
            awardList = awardList;
            console.log("未找到本地存储数据，使用默认设置");
            document.getElementById("systemTitle").textContent =
              "班级积分管理系统";
            document.getElementById("systemSlogan").textContent =
              "在这里，积分记录每一次成长 🏆";
            localStorage.setItem("classObj", JSON.stringify(classObj));
          }
        } catch (error) {
          console.error("加载数据失败:", error);
          console.log("使用默认数据");
        }
      }
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      function showModal(modalId) {
        document.getElementById(modalId).style.display = "block";
      }

      async function copyUrl() {
        console.log("222 -->", 222);
        const url =
          "https://www.xiaohongshu.com/user/profile/5bd082ba6d27b5000148a5db?tab=goods&channelType=share_outside&xhsshare=CopyLink&shareRedId=N0hGMDs3Rko8Szc5Sz0wNjY0PT9FOkpL&apptime=1757767218&share_id=05cdf3e03a7449d0932ccafec4764f6e";
        navigator.clipboard.writeText(url);
        alert("复制成功");
      }

      // =================================================================
      // 学生管理功能
      // =================================================================

      function addStudent() {
        const namesText = document.getElementById("studentNames").value.trim();
        const gender = document.querySelector(
          'input[name="gender"]:checked'
        ).value;

        if (!namesText) return alert("请输入学生姓名");

        const names = namesText
          .split("\n")
          .filter((name) => name.trim() !== "");

        names.forEach((name) => {
          const student = {
            id: generateId(),
            name: name.trim(),
            gender: gender,
            avatar: null,
            totalPoints: 0,
            usedPoints: 0,
            history: [],
            groupId: null,
          };
          students.push(student);
        });
        document.getElementById("studentNames").value = "";
        saveAllData();
        updateUI();
      }

      function deleteStudent(studentId) {
        if (!confirm("确定要删除该学生吗？此操作不可撤销！")) return;

        students = students.filter((s) => s.id !== studentId);
        saveAllData();
        updateUI();
      }

      function updateStudentName(studentId, newName) {
        const trimmedName = newName.trim();
        if (!trimmedName) {
          alert("学生姓名不能为空");
          updateUI(); // 重新渲染以恢复原名称
          return;
        }

        // 检查姓名是否重复
        const existingStudent = students.find(
          (s) => s.id !== studentId && s.name === trimmedName
        );
        if (existingStudent) {
          alert("该姓名已存在，请使用其他姓名");
          updateUI(); // 重新渲染以恢复原名称
          return;
        }

        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex !== -1) {
          students[studentIndex].name = trimmedName;
          console.log("students[studentIndex] -->", students[studentIndex]);
          saveAllData();
          updateUI();
        }
      }

      function uploadAvatar(studentId) {
        const fileInput = document.getElementById(`avatarInput_${studentId}`);
        if (fileInput) {
          fileInput.click();
        }
      }

      function handleAvatarUpload(studentId, fileInput) {
        const file = fileInput.files[0];
        if (!file) return;

        // 检查文件类型
        if (!file.type.startsWith("image/")) {
          alert("请选择图片文件");
          return;
        }

        // 检查文件大小 (限制为2MB)
        if (file.size > 2 * 1024 * 1024) {
          alert("图片文件不能超过2MB");
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          const studentIndex = students.findIndex((s) => s.id === studentId);
          if (studentIndex !== -1) {
            students[studentIndex].avatar = e.target.result;
            saveAllData();
            updateUI();
          }
        };
        reader.readAsDataURL(file);

        // 清空文件输入框，允许重复选择同一文件
        fileInput.value = "";
      }

      function createStudentCard(student) {
        const card = document.createElement("div");
        card.className = `student-card ${student.gender}`;
        card.setAttribute("data-id", student.id);
        card.draggable = true;

        const availablePoints = student.totalPoints - student.usedPoints;
        const isChecked = multiSelectedStudentIds.has(student.id);

        card.innerHTML = `
        <input type="checkbox" class="multi-select-checkbox" data-id="${
          student.id
        }" ${isChecked ? "checked" : ""}>
        
        <!-- 右上角积分显示 -->
        <div style="position: absolute; top: 8px; right: 8px; text-align: right; font-size: 11px; line-height: 1.2; z-index: 10;">
          <div style="background: var(--primary); color: #2d5a47; padding: 2px 6px; border-radius: 8px; margin-bottom: 2px; font-weight: 800;">
            ${student.totalPoints}总
          </div>
          <div style="background: var(--ok); color: #194f19; padding: 2px 6px; border-radius: 8px; font-weight: 800;">
            ${availablePoints}可用
          </div>
        </div>

        <!-- 头像和姓名水平排列 -->
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <!-- 头像区域 -->
          <div class="student-avatar ${student.gender}" onclick="uploadAvatar(${
          student.id
        })" title="点击上传头像" style="margin: 0; flex-shrink: 0;">
            ${
              student.avatar
                ? `<img src="${student.avatar}" alt="${student.name}">`
                : student.name.charAt(0)
            }
            <div style="position: absolute; bottom: -2px; right: -2px; width: 16px; height: 16px; background: var(--accent1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 2px solid #fff;">
              <i class="fas fa-camera"></i>
            </div>
          </div>

          <!-- 姓名区域 -->
          <div style="flex: 1;">
            <input type="text" value="${student.name}" 
                   class="student-name-input"
                   style="font-weight: 800; font-size: 16px; border: 1px solid transparent; background: transparent; padding: 4px 6px; border-radius: 4px; width: 100%; color: var(--text);"
                   onblur="updateStudentName(${student.id}, this.value)" 
                   onkeypress="if(event.key==='Enter') this.blur()"
                   onfocus="this.style.border='1px solid var(--primary)'; this.style.background='#fff'"
                   onblur="this.style.border='1px solid transparent'; this.style.background='transparent'"
                   title="点击编辑姓名">
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="student-controls">
          <button class="control-btn plus-btn" onclick="showPointsModal(${
            student.id
          }, 'add')" title="加分">+</button>
          <button class="control-btn minus-btn" onclick="showPointsModal(${
            student.id
          }, 'subtract')" title="减分">-</button>
          <button class="control-btn history-btn" onclick="showHistoryModal(${
            student.id
          }, 'no')" title="查看历史">📋记录</button>
          
          
          <button class="control-btn delete-btn" onclick="deleteStudent(${
            student.id
          })" title="删除学生">🗑️删除</button>
        <button class="control-btn " onclick="showHistoryModal(${
          student.id
        },'yes')" title="分数撤回">⚙️撤回</button>

          <button class="control-btn shop-btn color:"" onclick="showShopModal(${
            student.id
          })" title="积分商店">🛒商店</button>
          </div>


        <!-- 隐藏的文件上传输入框 -->
        <input type="file" id="avatarInput_${
          student.id
        }" accept="image/*" style="display: none;" onchange="handleAvatarUpload(${
          student.id
        }, this)">
      `;

        // 添加多选功能
        const checkbox = card.querySelector(".multi-select-checkbox");
        if (checkbox) {
          checkbox.addEventListener("change", function (e) {
            e.stopPropagation(); // 防止事件冒泡
            if (this.checked) {
              multiSelectedStudentIds.add(student.id);
            } else {
              multiSelectedStudentIds.delete(student.id);
            }
            updateSelectedCount();
          });
        }

        // // 添加拖拽功能
        // card.addEventListener("dragstart", function (e) {
        //   console.log("e -->", e);
        //   e.dataTransfer.setData("text/plain", student.id);
        // });

        return card;
      }

      // =================================================================
      // 积分管理功能
      // =================================================================

      function showPointsModal(studentId, type = null) {
        const student = students.find((s) => s.id === studentId);
        if (!student) return;

        const modalContent = document.getElementById("modalContent");
        let title =
          type === "add"
            ? `加分：${student.name}`
            : type === "subtract"
            ? `减分：${student.name}`
            : `加减分：${student.name}`;

        // 根据类型过滤规则
        let filteredRules = rules;
        if (type === "add") {
          filteredRules = rules.filter((r) => r.points > 0);
        } else if (type === "subtract") {
          filteredRules = rules.filter((r) => r.points < 0);
        }

        let rulesHtml = "";
        filteredRules.forEach((rule) => {
          const sign = rule.points > 0 ? "+" : "";
          rulesHtml += `
          <div class="rule-option ${rule.points > 0 ? "positive" : "negative"}" 
               onclick="applyPoints(${student.id}, ${rule.points}, '${
            rule.name
          }')">
            <span>${rule.name}</span>
            <span>${sign}${rule.points}</span>
          </div>
        `;
        });

        modalContent.innerHTML = `
        <h3>${title}</h3>
        <div class="rules-options">
          ${rulesHtml || "<p>没有可用的规则</p>"}
        </div>
        <div style="margin-top: 20px;">
          <h4>自定义积分</h4>
          <div  style="display: flex;gap: 12px;margin: 12px 0;">
            <input type="number" id="customPoints" class="form-control" placeholder="分数" style="width: 100px;">
            <input type="text" id="customReason" class="form-control" placeholder="原因" style="flex: 1;">
            <button onclick="applyCustomPoints(${
              student.id
            })" class="btn primary">应用</button>
          </div>
        </div>
      `;

        showModal("modal");
      }

      function applyPoints(studentId, points, reason) {
        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex === -1) return;

        const groupId = students[studentIndex].groupId;
        const groupIndex = groups.findIndex((s) => s.id === groupId);

        console.log("students[studentIndex] -->", students[studentIndex]);
        students[studentIndex].totalPoints += points;
        students[studentIndex].history.push({
          date: new Date().toISOString(),
          points: points,
          reason: reason,
        });
        if (groupIndex != -1) {
          groups[groupIndex].history.push({
            date: new Date().toISOString(),
            points: points,
            reason: reason,
            title: `${students[studentIndex].name}  ${
              points > 0 ? "加分" : "减分"
            }`,
          });
        }

        if (students[studentIndex].groupId) {
          const s = groups.find((i) => i.id == students[studentIndex].groupId);
          s.integral += points;
        }

        saveAllData();
        updateUI();

        closeModal("modal");
        // 显示动画
        showPointAnimation(studentId, points);
      }

      function applyCustomPoints(studentId) {
        const points = parseInt(document.getElementById("customPoints").value);
        const reason =
          document.getElementById("customReason").value.trim() || "自定义";

        if (isNaN(points)) return alert("请输入有效的分数");

        applyPoints(studentId, points, reason);
      }

      function showPointAnimation(studentId, points) {
        const studentCard = document.querySelector(
          `.student-card[data-id="${studentId}"]`
        );
        if (!studentCard) return;

        const animation = document.createElement("div");
        animation.className = `point-animation ${
          points > 0 ? "positive" : "negative"
        }`;
        animation.textContent = points > 0 ? `+${points}` : points;
        const rect = studentCard.getBoundingClientRect();

        // 关键：将视口坐标转换为文档绝对坐标
        const docLeft = rect.left + window.scrollX;
        const docTop = rect.top + window.scrollY;

        animation.style.left = `${docLeft - 20 + rect.width / 2}px`;
        animation.style.top = `${docTop - 25 + rect.height / 2}px`;
        console.log("studentCard -->", studentCard);
        // animation.style.left = `${rect.left}px`;
        // animation.style.top = `${rect.top}px`;
        console.log("rect -->", JSON.parse(JSON.stringify(rect)));
        document.body.appendChild(animation);
        console.log("animation -->", animation);
        // animation.addEventListener("animationend", function () {
        //   document.body.removeChild(animation);
        // });
      }
      // =================================================================
      // 历史记录功能
      // =================================================================
      function showHistoryModal(studentId, flag) {
        const student = students.find((s) => s.id === studentId);
        const group = groups.find((s) => s.id === studentId);

        const modalContent = document.getElementById("modalContent");
        let historyHtml = "";
        if (student) {
          if (student.history && student.history.length > 0) {
            historyHtml = '<div style="max-height: 400px; overflow-y: auto;">';
            student.history
              .slice()
              .reverse()
              .forEach((record, index) => {
                const date = new Date(record.date).toLocaleString();
                const pointsClass = record.points > 0 ? "positive" : "negative";
                const sign = record.points > 0 ? "+" : "";
                const realIndex = student.history.length - 1 - index;

                if (flag === "yes") {
                  historyHtml += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--light); border-radius: 8px; border-left: 4px solid ${
                      record.points > 0 ? "var(--ok)" : "var(--warn)"
                    };">
                      <div>
                        <div style="font-weight: 600;">${record.reason}</div>
                        <div style="font-size: 12px; color: var(--sub);">${date}</div>
                      </div>
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-weight: 800; font-size: 18px; color: ${
                          record.points > 0 ? "var(--ok)" : "var(--warn)"
                        };">${sign}${record.points}</span>
                        <button onclick="revertHistoryItem(${
                          student.id
                        }, ${realIndex})" class="btn-icon btn ghost" title="撤回此操作" style="width: 30px; height: 30px; padding: 0;">
                          <i class="fas fa-undo"></i>
                        </button>
                      </div>
                    </div>
                  `;
                } else {
                  historyHtml += `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--light); border-radius: 8px; border-left: 4px solid ${
                    record.points > 0 ? "var(--ok)" : "var(--warn)"
                  };">
                    <div>
                      <div style="font-weight: 600;">${record.reason}</div>
                      <div style="font-size: 12px; color: var(--sub);">${date}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <span style="font-weight: 800; font-size: 18px; color: ${
                        record.points > 0 ? "var(--ok)" : "var(--warn)"
                      };">${sign}${record.points}</span>
                    </div>
                  </div>
                `;
                }
              });
            historyHtml += "</div>";
          } else {
            historyHtml = "<p>暂无积分记录</p>";
          }

          modalContent.innerHTML = `
              <h3>${student.name} 的积分历史</h3>
              ${historyHtml}
            `;
        } else if (group) {
          if (group.history && group.history.length > 0) {
            historyHtml = '<div style="max-height: 400px; overflow-y: auto;">';
            group.history
              .slice()
              .reverse()
              .forEach((record, index) => {
                const date = new Date(record.date).toLocaleString();
                const pointsClass = record.points > 0 ? "positive" : "negative";
                const sign = record.points > 0 ? "+" : "";
                const realIndex = group.history.length - 1 - index;

                historyHtml += `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--light); border-radius: 8px; border-left: 4px solid ${
                    record.points > 0 ? "var(--ok)" : "var(--warn)"
                  };">
                    <div>
                      <div style="font-weight: 600;">${record.reason} -- ${
                  record.title
                }</div>
                      <div style="font-size: 12px; color: var(--sub);">${date}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <span style="font-weight: 800; font-size: 18px; color: ${
                        record.points > 0 ? "var(--ok)" : "var(--warn)"
                      };">${sign}${record.points}</span>
                    </div>
                  </div>
                `;
              });
            historyHtml += "</div>";
          } else {
            historyHtml = "<p>暂无积分记录</p>";
          }

          modalContent.innerHTML = `
              <h3>${group.name} 的积分历史</h3>
              ${historyHtml}
            `;
        }

        showModal("modal");
      }

      function revertHistoryItem(studentId, historyIndex) {
        if (!confirm("您确定要撤回这条操作吗？此操作不可恢复。")) return;

        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex === -1) return;

        const student = students[studentIndex];
        const recordToRevert = student.history[historyIndex];

        if (!recordToRevert) return;

        // 恢复分数
        student.totalPoints -= recordToRevert.points;

        // 如果是商品兑换，需要特殊处理
        if (recordToRevert.reason.includes("兑换商品")) {
          const cost = Math.abs(recordToRevert.points);
          student.usedPoints -= cost;

          // 这里可以增加恢复商品库存的逻辑
        }

        // 从历史记录中移除该条目
        student.history.splice(historyIndex, 1);

        saveAllData();
        updateUI();
        showHistoryModal(studentId); // 刷新历史模态框
        alert("操作已成功撤回！");
      }

      // =================================================================
      // 商店功能
      // =================================================================
      // 学生商店
      function showShopModal(studentId) {
        const student = students.find((s) => s.id === studentId);
        if (!student) return;

        const modalContent = document.getElementById("modalContent");
        const availablePoints = student.totalPoints - student.usedPoints;

        let shopItemsHtml = "";
        if (shopItems.length > 0) {
          shopItemsHtml =
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">';
          shopItems.forEach((item) => {
            const canAfford = availablePoints >= item.cost;
            const disabled = !canAfford || item.stock <= 0;

            shopItemsHtml += `
            <div style="background: var(--light); border: 1px solid var(--line); border-radius: 12px; padding: 16px; ${
              disabled ? "opacity: 0.6;" : ""
            }">
              <div style="font-weight: 600; margin-bottom: 8px;">${
                item.name
              }</div>
              <div style="display:flex;justify-content: space-between;">
                 <div style="color: var(--primary); font-weight: 800; margin-bottom: 12px;">${
                   item.cost
                 }积分</div>  
                <div style="color: #a76969; font-weight: 800; margin-bottom: 12px;">${
                  item.stock > 0 ? "库存:" + item.stock : "库存不足"
                }</div> 
              </div>
             
              <button onclick="purchaseItem(${student.id}, ${
              item.id
            })" class="btn ${
              canAfford ? "primary" : "ghost"
            }" style="width: 100%;" ${disabled ? "disabled" : ""}>
                ${canAfford ? "兑换" : "积分不足"}
              </button>
            </div>
          `;
          });
          shopItemsHtml += "</div>";
        } else {
          shopItemsHtml = "<p>商店暂无商品</p>";
        }

        modalContent.innerHTML = `
        <h3>${student.name} 的商店兑换</h3>
        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: #2d5a47; padding: 16px; border-radius: 12px; margin-bottom: 20px; font-weight: 700; font-size: 16px; text-align: center;">
          可用积分: <span style="font-size: 20px; margin-left: 8px;">${availablePoints}</span>
        </div>
        ${shopItemsHtml}
      `;

        showModal("modal");
      }

      // 小组商店
      function showShopModal2(groupId) {
        const group = groups.find((s) => s.id === groupId);
        if (!group) return;
        const modalContent = document.getElementById("modalContent");
        const availablePoints = group.integral - group.useintegral;

        let shopItemsHtml = "";
        if (shopItems.length > 0) {
          shopItemsHtml =
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">';
          shopItems.forEach((item) => {
            const canAfford = availablePoints >= item.cost;
            const disabled = !canAfford || item.stock <= 0;

            shopItemsHtml += `
            <div style="background: var(--light); border: 1px solid var(--line); border-radius: 12px; padding: 16px; ${
              disabled ? "opacity: 0.6;" : ""
            }">
              <div style="font-weight: 600; margin-bottom: 8px;">${
                item.name
              }</div>
              <div style="display:flex;justify-content: space-between;">
                 <div style="color: var(--primary); font-weight: 800; margin-bottom: 12px;">${
                   item.cost
                 }积分</div>  
                <div style="color: #a76969; font-weight: 800; margin-bottom: 12px;">${
                  item.stock > 0 ? "库存:" + item.stock : "库存不足"
                }</div> 
              </div>
              <button onclick="purchaseItem2(${group.id}, ${
              item.id
            })" class="btn ${
              canAfford ? "primary" : "ghost"
            }" style="width: 100%;" ${disabled ? "disabled" : ""}>
                ${canAfford ? "兑换" : "积分不足"}
              </button>
            </div>
          `;
          });
          shopItemsHtml += "</div>";
        } else {
          shopItemsHtml = "<p>商店暂无商品</p>";
        }

        modalContent.innerHTML = `
        <h3>${group.name} 的商店兑换</h3>
        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: #2d5a47; padding: 16px; border-radius: 12px; margin-bottom: 20px; font-weight: 700; font-size: 16px; text-align: center;">
          可用积分: <span style="font-size: 20px; margin-left: 8px;">${availablePoints}</span>
        </div>
        ${shopItemsHtml}
      `;

        showModal("modal");
      }
      //学生兑换
      function purchaseItem(studentId, itemId) {
        const studentIndex = students.findIndex((s) => s.id === studentId);
        const itemIndex = shopItems.findIndex((item) => item.id === itemId);

        if (studentIndex === -1 || itemIndex === -1) return;

        const item = shopItems[itemIndex];
        const availablePoints =
          students[studentIndex].totalPoints -
          students[studentIndex].usedPoints;

        if (availablePoints >= item.cost) {
          // 扣除积分
          students[studentIndex].usedPoints += item.cost;
          if (item.stock) {
            item.stock--;
          }
          // 添加历史记录
          students[studentIndex].history.push({
            date: new Date().toISOString(),
            points: -item.cost,
            reason: `兑换商品: ${item.name}`,
          });

          saveAllData();
          updateUI();
          showShopModal(students[studentIndex].id); // 刷新商店模态框

          alert(`成功兑换 ${item.name}！`);
        }
      }
      // 小组兑换
      function purchaseItem2(groupId, itemId) {
        console.log("11 -->", 11);
        // const studentIndex = students.findIndex((s) => s.id === studentId);
        const itemIndex = shopItems.findIndex((item) => item.id === itemId);
        const groupIndex = groups.findIndex((s) => s.id === groupId);

        if (groupIndex === -1 || itemIndex === -1) return;

        const item = shopItems[itemIndex];
        const availablePoints =
          groups[groupIndex].integral - groups[groupIndex].useintegral;

        if (availablePoints >= item.cost) {
          // 扣除积分
          groups[groupIndex].useintegral += item.cost;
          if (item.stock) {
            item.stock--;
          }
          // 添加历史记录
          console.log("groups -->", groups, groups[groupIndex]);
          groups[groupIndex].history.push({
            date: new Date().toISOString(),
            points: -item.cost,
            reason: `兑换商品: ${item.name}`,
            title: "小组积分",
          });

          saveAllData();
          updateUI();
          showShopModal2(groups[groupIndex].id); // 刷新商店模态框

          alert(`成功兑换 ${item.name}！`);
        }
      }

      // =================================================================
      // 小组管理功能
      // =================================================================

      function addGroup() {
        const groupName = document.getElementById("groupName").value.trim();
        if (!groupName) return alert("请输入小组名称");

        const group = {
          id: generateId(),
          name: groupName,
          integral: 0,
          useintegral: 0,
          history: [],
        };

        groups.push(group);
        document.getElementById("groupName").value = "";
        saveAllData();
        updateUI();
      }
      let tt = null;
      function deleteGroup(groupId) {
        const flag = localStorage.getItem("deleteGroup");
        if (flag === "yes") {
          return;
        }
        localStorage.setItem("deleteGroup", "yes");
        if (!confirm("确定要删除这个小组吗？小组内的学生将返回未分组状态。")) {
          tt = setTimeout(() => {
            localStorage.removeItem("deleteGroup");
            clearTimeout(tt);
          }, 200);
          return;
        }
        // 将小组中的所有学生设为未分组
        students.forEach((student) => {
          if (student.groupId === groupId) {
            student.groupId = null;
          }
        });

        // 删除小组
        groups = groups.filter((group) => group.id !== groupId);

        saveAllData();
        updateUI();
        tt = setTimeout(() => {
          localStorage.removeItem("deleteGroup");
          clearTimeout(tt);
        }, 200);
      }

      // 确保函数在全局作用域可访问
      window.deleteGroup = deleteGroup;

      function updateGroupName(groupId, newName) {
        const trimmedName = newName.trim();
        if (!trimmedName) {
          alert("小组名称不能为空");
          updateUI(); // 重新渲染以恢复原名称
          return;
        }

        const groupIndex = groups.findIndex((g) => g.id === groupId);
        if (groupIndex !== -1) {
          groups[groupIndex].name = trimmedName;
          saveAllData();
          updateUI();
        }
      }

      function addStudentToGroup(groupId) {
        const selectElement = document.getElementById(
          `addStudentToGroup_${groupId}`
        );
        const studentId = parseInt(selectElement.value);
        if (!studentId) return;

        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex !== -1) {
          students[studentIndex].groupId = groupId;
          selectElement.value = ""; // 清空选择
          saveAllData();
          updateUI();
        }
      }

      function removeStudentFromGroup(studentId) {
        const flag = localStorage.getItem("removeStudentFromGroup");
        if (flag === "yes") {
          return;
        }
        localStorage.setItem("removeStudentFromGroup", "yes");
        if (!confirm("确定要将该学生移出小组吗？")) {
          tt = setTimeout(() => {
            localStorage.removeItem("removeStudentFromGroup");
            clearTimeout(tt);
          }, 200);
          return;
        }

        const studentIndex = students.findIndex((s) => s.id === studentId);
        if (studentIndex !== -1) {
          students[studentIndex].groupId = null;
          saveAllData();
          updateUI();
        }
        tt = setTimeout(() => {
          localStorage.removeItem("removeStudentFromGroup");
          clearTimeout(tt);
        }, 200);
      }

      function showGroupPointsModal(groupId) {
        const group = groups.find((g) => g.id === groupId);
        const groupStudents = students.filter((s) => s.groupId === groupId);

        if (!group || groupStudents.length === 0) {
          alert("小组为空，无法进行积分操作");
          return;
        }

        const modalContent = document.getElementById("modalContent");

        let rulesHtml = "";
        rules.forEach((rule) => {
          const sign = rule.points > 0 ? "+" : "";
          rulesHtml += `
          <div class="rule-option ${rule.points > 0 ? "positive" : "negative"}" 
               onclick="applyPointsToGroup(${groupId}, ${rule.points}, '${
            rule.name
          }')">
            <span>${rule.name}</span>
            <span>${sign}${rule.points}</span>
          </div>
        `;
        });
        console.log("groupStudents -->", groupStudents);
        const totalPoints = groupStudents.reduce(
          (sum, s) => sum + s.totalPoints,
          0
        );
        const totalUsedPoints = groupStudents.reduce(
          (sum, s) => sum + s.usedPoints,
          0
        );
        const availablePoints = totalPoints - totalUsedPoints;

        modalContent.innerHTML = `
        <h3>${group.name} 小组积分管理</h3>
        
        <!-- 小组积分统计 -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); border-radius: 12px; color: #2d5a47;">
          <div style="text-align: center;">
            <div style="font-size: 12px; opacity: 0.8;">总积分</div>
            <div style="font-weight: 800; font-size: 20px;">${
              group.integral
            }</div>
          </div>
       

          <div style="text-align: center;">
            <div style="font-size: 12px; opacity: 0.8;">已兑换</div>
            <div style="font-weight: 800; font-size: 20px;">${
              group.useintegral
            }</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 12px; opacity: 0.8;">可用积分</div>
            <div style="font-weight: 800; font-size: 20px;">${
              group.integral - group.useintegral
            }</div>
          </div>
        </div>
         
        <div onclick="resetGroup(${groupId})"  style="cursor:pointer; text-align:right; background:#fb4f4f; color:#fff; width:max-content; border-radius:5px; margin-left:auto; padding:10px 15px; font-size:14px; font-weight:700;">
          小组积分清零 !!
         </div>
        <!-- 成员信息 -->
        <div style="margin-bottom: 20px;">
          <h4>小组成员 (${groupStudents.length}人)</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 8px;">
            ${groupStudents
              .map(
                (s) => `
              <div style="text-align: center; padding: 8px; background: var(--light); border-radius: 8px; font-size: 12px;">
                <div style="font-weight: 600;">${s.name}</div>
                <div style="color: var(--primary);">${s.totalPoints}分</div>
              </div>
            `
              )
              .join("")}
          </div>
        </div>

        <!-- 积分规则 -->
        <div class="rules-options">
          ${rulesHtml}
        </div>
        
        <!-- 自定义积分 -->
        <div style="margin-top: 20px;">
          <h4>自定义积分</h4>
          <div style="display: flex; gap: 12px; margin: 12px 0;">
            <input type="number" id="customGroupPoints" class="form-control" placeholder="分数" style="width: 100px;">
            <input type="text" id="customGroupReason" class="form-control" placeholder="原因" style="flex: 1;">
            <button onclick="applyCustomPointsToGroup(${groupId})" class="btn primary">应用到全组</button>
          </div>
        </div>
      `;

        showModal("modal");
      }

      function applyPointsToGroup(groupId, points, reason) {
        console.log("groupId -->", groupId, points, reason);

        const groupStudents = students.filter((s) => s.groupId === groupId);
        console.log("groupStudents -->", groupStudents);
        if (groupStudents.length === 0) return;

        groups.forEach((i) => {
          if (i.id == groupId) {
            i.integral += points;
          }
        });
        groupStudents.forEach((student) => {
          const studentIndex = students.findIndex((s) => s.id === student.id);
          if (studentIndex !== -1) {
            students[studentIndex].totalPoints += points;
            students[studentIndex].history.push({
              date: new Date().toISOString(),
              points: points,
              reason: `[小组] ${reason}`,
            });
          }
        });

        saveAllData();
        updateUI();
        closeModal("modal");
        alert(
          `已为小组所有成员${points > 0 ? "加" : "减"}${Math.abs(points)}分`
        );
      }

      function resetGroup(groupId) {
        const groupIndex = groups.findIndex((i) => i.id == groupId);

        if (
          confirm(
            `确定要清除${groups[groupIndex].name}的积分吗？此操作不可恢复！`
          )
        ) {
          groups[groupIndex].integral = 0;
          groups[groupIndex].useintegral = 0;
          groups[groupIndex].history.length = 0;
          saveAllData();
          updateUI();
          document.querySelectorAll(".close")[0].click();
          alert(`${groups[groupIndex].name}小组积分清零！`);
        }
      }

      function applyCustomPointsToGroup(groupId) {
        const points = parseInt(
          document.getElementById("customGroupPoints").value
        );
        const reason =
          document.getElementById("customGroupReason").value.trim() ||
          "小组自定义";

        if (isNaN(points)) return alert("请输入有效的分数");

        applyPointsToGroup(groupId, points, reason);
      }

      // =================================================================
      // 全员和多选积分管理功能
      // =================================================================

      function showGlobalPointsModal(type) {
        if (students.length === 0) {
          alert("没有学生，无法进行操作");
          return;
        }

        const modalContent = document.getElementById("modalContent");
        let title = type === "add" ? "全员加分" : "全员减分";

        // 根据类型过滤规则
        let filteredRules = rules;
        if (type === "add") {
          filteredRules = rules.filter((r) => r.points > 0);
        } else if (type === "subtract") {
          filteredRules = rules.filter((r) => r.points < 0);
        }

        let rulesHtml = "";
        filteredRules.forEach((rule) => {
          const sign = rule.points > 0 ? "+" : "";
          rulesHtml += `
          <div class="rule-option ${rule.points > 0 ? "positive" : "negative"}" 
               onclick="applyPointsToAllStudents(${rule.points}, '${
            rule.name
          }')">
            <span>${rule.name}</span>
            <span>${sign}${rule.points}</span>
          </div>
        `;
        });

        modalContent.innerHTML = `
        <h3>${title}</h3>
        <div style="background: var(--light); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          将对所有 <strong>${students.length}</strong> 名学生进行操作
        </div>
        <div class="rules-options">
          ${rulesHtml || "<p>没有可用的规则</p>"}
        </div>
        <div style="margin-top: 20px;">
          <h4>自定义积分3</h4>
          <div style="background: var(--light); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          单次加分项，不计入积分规则
        </div>
          <div class="diygrade">
            <input type="number" id="customGlobalPoints" class="form-control" placeholder="分数" style="width: 100px;">
            <input type="text" id="customGlobalReason" class="form-control" placeholder="原因" style="flex: 1;">
            <button onclick="applyCustomPointsToAllStudents()" class="btn primary">应用到所有学生</button>
          </div>
        </div>
      `;

        showModal("modal");
      }

      function applyPointsToAllStudents(points, reason) {
        students.forEach((student, index) => {
          students[index].totalPoints += points;
          students[index].history.push({
            date: new Date().toISOString(),
            points: points,
            reason: `[全员] ${reason}`,
          });
        });

        saveAllData();
        updateUI();
        closeModal("modal");
        alert(`已为所有学生${points > 0 ? "加" : "减"}${Math.abs(points)}分`);
      }

      function applyCustomPointsToAllStudents() {
        const points = parseInt(
          document.getElementById("customGlobalPoints").value
        );
        const reason =
          document.getElementById("customGlobalReason").value.trim() ||
          "全员自定义";

        if (isNaN(points)) return alert("请输入有效的分数");

        applyPointsToAllStudents(points, reason);
      }

      // 多选模式功能
      function enterMultiSelectMode() {
        isMultiSelectMode = true;
        document.body.classList.add("multi-select-mode");
        document.getElementById("exitMultiSelectMode").style.display =
          "inline-flex";
        document.getElementById("multiSelectActions").style.display = "flex";
        document.getElementById("multiSelectMode").style.display = "none";
        multiSelectedStudentIds.clear();
        updateSelectedCount();
      }

      function exitMultiSelectMode() {
        isMultiSelectMode = false;
        document.body.classList.remove("multi-select-mode");
        document.getElementById("exitMultiSelectMode").style.display = "none";
        document.getElementById("multiSelectActions").style.display = "none";
        document.getElementById("multiSelectMode").style.display =
          "inline-flex";
        multiSelectedStudentIds.clear();
        updateUI(); // 重新渲染清除选择状态
      }

      function updateSelectedCount() {
        document.getElementById("selectedCount").textContent =
          multiSelectedStudentIds.size;
      }

      function deleteSelectedStudents() {
        if (multiSelectedStudentIds.size === 0) {
          alert("请先选择要删除的学生");
          return;
        }

        const selectedStudents = students.filter((s) =>
          multiSelectedStudentIds.has(s.id)
        );
        const confirmMessage = `确定要删除以下 ${
          selectedStudents.length
        } 名学生吗？\n\n${selectedStudents
          .map((s) => s.name)
          .join("、")}\n\n此操作不可撤销！`;

        if (!confirm(confirmMessage)) return;

        // 删除选中的学生
        students = students.filter((s) => !multiSelectedStudentIds.has(s.id));

        saveAllData();
        exitMultiSelectMode();
        updateUI();
        alert(`已删除 ${selectedStudents.length} 名学生`);
      }

      // 搜索功能
      function searchStudents() {
        const searchTerm = document
          .getElementById("studentSearchInput")
          .value.trim()
          .toLowerCase();

        if (!searchTerm) {
          // 如果搜索框为空，显示所有学生
          updateUI();
          return;
        }

        // 过滤学生
        const filteredStudents = students.filter((student) =>
          student.name.toLowerCase().includes(searchTerm)
        );

        // 重新渲染只显示搜索结果
        renderFilteredStudents(filteredStudents);
      }

      function renderFilteredStudents(filteredStudents) {
        const allStudentsEl = document.getElementById("allStudents");
        allStudentsEl.innerHTML = "";

        if (filteredStudents.length === 0) {
          allStudentsEl.innerHTML =
            '<div style="text-align: center; padding: 40px; color: var(--sub);">没有找到匹配的学生</div>';
          return;
        }

        // 按小组分组显示搜索结果
        const ungroupedFiltered = filteredStudents.filter((s) => !s.groupId);
        const groupedFiltered = {};

        filteredStudents.forEach((student) => {
          if (student.groupId) {
            if (!groupedFiltered[student.groupId]) {
              groupedFiltered[student.groupId] = [];
            }
            groupedFiltered[student.groupId].push(student);
          }
        });

        // 渲染未分组的搜索结果
        if (ungroupedFiltered.length > 0) {
          const section = document.createElement("div");
          section.className = "group-section";
          section.setAttribute("data-group-id", "空");
          console.log("渲染未分组 -->");
          section.innerHTML = `
          <div class="group-header">
            <div class="group-name">未分组 - 搜索结果</div>
            <div class="group-stats">${ungroupedFiltered.length}人</div>
          </div>
        `;

          const grid = document.createElement("div");
          grid.className = "student-list";
          ungroupedFiltered.forEach((student) => {
            grid.appendChild(createStudentCard(student));
          });
          section.appendChild(grid);
          allStudentsEl.appendChild(section);
        }

        // 渲染各小组的搜索结果
        groups.forEach((group) => {
          if (groupedFiltered[group.id]) {
            const section = document.createElement("div");
            section.className = "group-section";
            section.setAttribute("data-group-id", group.id);

            const groupStudents = groupedFiltered[group.id];
            section.innerHTML = `
            <div class="group-header">
              <div class="group-name">${group.name} - 搜索结果</div>
              <div class="group-stats">${groupStudents.length}人</div>
            </div>
          `;

            const grid = document.createElement("div");
            grid.className = "student-list dropzone";
            grid.setAttribute("data-group-id", group.id);
            groupStudents.forEach((student) => {
              grid.appendChild(createStudentCard(student));
            });
            section.appendChild(grid);
            allStudentsEl.appendChild(section);
          }
        });

        // 设置拖拽功能
        // setupDragAndDrop();
      }

      // 清空搜索
      function clearSearch() {
        document.getElementById("studentSearchInput").value = "";
        updateUI();
      }

      function showMultiSelectPointsModal(type) {
        if (multiSelectedStudentIds.size === 0) {
          alert("请先选择要操作的学生");
          return;
        }

        const selectedStudents = students.filter((s) =>
          multiSelectedStudentIds.has(s.id)
        );
        const modalContent = document.getElementById("modalContent");
        let title = type === "add" ? "多选加分" : "多选减分";

        // 根据类型过滤规则
        let filteredRules = rules;
        if (type === "add") {
          filteredRules = rules.filter((r) => r.points > 0);
        } else if (type === "subtract") {
          filteredRules = rules.filter((r) => r.points < 0);
        }

        let rulesHtml = "";
        filteredRules.forEach((rule) => {
          const sign = rule.points > 0 ? "+" : "";
          rulesHtml += `
          <div class="rule-option ${rule.points > 0 ? "positive" : "negative"}" 
               onclick="applyPointsToSelectedStudents(${rule.points}, '${
            rule.name
          }')">
            <span>${rule.name}</span>
            <span>${sign}${rule.points}</span>
          </div>
        `;
        });

        modalContent.innerHTML = `
        <h3>${title}</h3>
        <div style="background: var(--light); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
          已选择 <strong>${selectedStudents.length}</strong> 名学生：
          <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
            ${selectedStudents
              .map(
                (s) =>
                  `<span style="background: var(--primary); color: #2d5a47; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${s.name}</span>`
              )
              .join("")}
          </div>
        </div>
        <div class="rules-options">
          ${rulesHtml || "<p>没有可用的规则</p>"}
        </div>
        <div style="margin-top: 20px;">
          <h4>自定义积分</h4>
          <div style="display: flex; gap: 12px; margin: 12px 0;">
            <input type="number" id="customMultiPoints" class="form-control" placeholder="分数" style="width: 100px;">
            <input type="text" id="customMultiReason" class="form-control" placeholder="原因" style="flex: 1;">
            <button onclick="applyCustomPointsToSelectedStudents()" class="btn primary">应用到选中学生</button>
          </div>
        </div>
      `;

        showModal("modal");
      }

      function applyPointsToSelectedStudents(points, reason) {
        const selectedStudentIds = Array.from(multiSelectedStudentIds);

        selectedStudentIds.forEach((studentId) => {
          const studentIndex = students.findIndex((s) => s.id === studentId);
          if (studentIndex !== -1) {
            students[studentIndex].totalPoints += points;
            students[studentIndex].history.push({
              date: new Date().toISOString(),
              points: points,
              reason: `[多选] ${reason}`,
            });
          }
        });

        saveAllData();
        updateUI();
        closeModal("modal");
        exitMultiSelectMode();
        alert(
          `已为选中的${selectedStudentIds.length}名学生${
            points > 0 ? "加" : "减"
          }${Math.abs(points)}分`
        );
      }

      function applyCustomPointsToSelectedStudents() {
        const points = parseInt(
          document.getElementById("customMultiPoints").value
        );
        const reason =
          document.getElementById("customMultiReason").value.trim() ||
          "多选自定义";

        if (isNaN(points)) return alert("请输入有效的分数");

        applyPointsToSelectedStudents(points, reason);
      }

      // =================================================================
      // 数据导入导出功能 (采用第二个系统的智能导入)
      // =================================================================

      function showImportModal() {
        showModal("importModal");
      }

      function exportData() {
        const data = JSON.parse(localStorage.getItem("classPointsData"));
        // const data = {
        //   students: students,
        //   groups: groups,
        //   rules: rules,
        //   shopItems: shopItems,
        // };

        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `班级积分数据_${
          new Date().toISOString().split("T")[0]
        }.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function handleFileImport() {
        const file = document.getElementById("importFile").files[0];
        if (!file) return alert("请选择文件");

        const ext = file.name.split(".").pop().toLowerCase();

        if ((ext === "xlsx" || ext === "xls") && typeof XLSX !== "undefined") {
          const reader = new FileReader();
          reader.onload = function () {
            try {
              const workbook = XLSX.read(new Uint8Array(reader.result), {
                type: "array",
              });
              const sheetName = workbook.SheetNames[0];
              const rows = XLSX.utils.sheet_to_json(
                workbook.Sheets[sheetName],
                { header: 1, raw: true }
              );
              handleImportData(rowsToCSV(rows));
            } catch (err) {
              alert("Excel 解析失败：" + err.message);
            }
          };
          reader.readAsArrayBuffer(file);
        } else {
          const reader = new FileReader();
          reader.onload = function () {
            try {
              handleImportData(reader.result);
            } catch (err) {
              alert("文件解析失败：" + err.message);
            }
          };
          reader.readAsText(file);
        }
      }

      function handleTextImport() {
        const text = document.getElementById("importText").value.trim();
        if (!text) return alert("请输入要导入的数据");

        try {
          handleImportData(text);
        } catch (err) {
          alert("数据解析失败：" + err.message);
        }
      }

      function rowsToCSV(rows) {
        return (rows || [])
          .map((row) =>
            (row || [])
              .map((cell) => `"${String(cell ?? "").replace(/"/g, '""')}"`)
              .join(",")
          )
          .join("\n");
      }
      // 修改 handleImportData 函数
      function handleImportData(text) {
        console.log("导入的数据:", text); // 查看导入的原始文本

        if (!text) throw new Error("内容为空");

        let items;

        try {
          // 首先尝试解析为JSON
          if (text.trim().startsWith("[") || text.trim().startsWith("{")) {
            const jsonData = JSON.parse(text);
            console.log("jsonData -->", jsonData);
            if (Array.isArray(jsonData) && jsonData.length) {
              // 检查是否是完整的系统数据格式
              if (jsonData[0].students && Array.isArray(jsonData[0].students)) {
                // 完整数据格式，直接导入所有数据
                if (
                  confirm(
                    "检测到完整的系统数据，是否导入所有数据（包括学生、小组、规则和商店）？"
                  )
                ) {
                  localStorage.setItem(
                    "classPointsData",
                    JSON.stringify(jsonData)
                  );
                  console.log("获取新数据 -->");
                  loadAllData();
                  updateUI();
                  closeModal("importModal");
                  alert("完整数据导入成功！");
                  return;
                }
              }
              // 否则按普通数据处理
              items = normalizeData(jsonData);
            }
          } else {
            // 处理CSV/TSV格式
            items = normalizeData(text);
          }

          if (!items || items.length === 0) {
            throw new Error("未找到可导入的数据");
          }

          importStudentData(items);
        } catch (err) {
          console.error("导入处理失败:", err);
          alert("数据处理失败：" + err.message);
        }
      }

      // 修改 normalizeData 函数，增强兼容性
      function normalizeData(input) {
        const out = [];
        const nameKeys = ["name", "姓名", "学生姓名"];
        const scoreKeys = ["score", "积分", "总积分"];
        const coinsKeys = ["coins", "兑换币", "金币", "已用积分"];
        const groupKeys = ["group", "小组", "班级"];

        if (!input) return out;

        try {
          if (typeof input === "string") {
            // 处理CSV/TSV字符串
            const lines = input
              .split(/\r?\n/)
              .filter((line) => line.trim() !== "");
            if (lines.length === 0) return out;

            const delim = lines[0].includes("\t") ? "\t" : ",";
            return normalizeData(
              lines.map((line) =>
                line
                  .split(new RegExp(`${delim}(?=(?:[^"]*"[^"]*")*[^"]*$)`))
                  .map((cell) => cell.replace(/^"|"$/g, "").trim())
              )
            );
          }

          if (Array.isArray(input)) {
            if (input.length === 0) return out;

            // 检查是否是对象数组
            if (typeof input[0] === "object" && !Array.isArray(input[0])) {
              input.forEach((obj) => {
                out.push({
                  name: findValue(obj, nameKeys),
                  score: findValue(obj, scoreKeys),
                  coins: findValue(obj, coinsKeys),
                  group: findValue(obj, groupKeys),
                });
              });
              return out;
            }

            // 处理二维数组
            let start = 0;
            let nameIdx = 0,
              scoreIdx = -1,
              coinsIdx = -1,
              groupIdx = -1;

            if (Array.isArray(input[0])) {
              const headers = input[0].map((h) =>
                String(h || "").toLowerCase()
              );
              const findIdx = (keys) =>
                headers.findIndex((h) =>
                  keys.some((k) => h.includes(k.toLowerCase()))
                );

              nameIdx = findIdx(nameKeys);
              scoreIdx = findIdx(scoreKeys);
              coinsIdx = findIdx(coinsKeys);
              groupIdx = findIdx(groupKeys);

              // 如果找到了标题行，从下一行开始处理
              if (
                nameIdx > -1 ||
                scoreIdx > -1 ||
                coinsIdx > -1 ||
                groupIdx > -1
              ) {
                start = 1;
              } else {
                // 没有标题行，假设第一列是姓名
                nameIdx = 0;
              }
            }

            // 处理数据行
            for (let i = start; i < input.length; i++) {
              const row = input[i];
              if (!Array.isArray(row) || row.length === 0) continue;

              const name = row[nameIdx] ? String(row[nameIdx]).trim() : "";
              if (!name) continue; // 跳过没有姓名的行

              out.push({
                name: name,
                score: scoreIdx > -1 ? row[scoreIdx] : "",
                coins: coinsIdx > -1 ? row[coinsIdx] : "",
                group: groupIdx > -1 ? row[groupIdx] : "",
              });
            }
          }
        } catch (err) {
          console.error("数据标准化失败:", err);
        }

        return out;
      }

      // 修改 importStudentData 函数
      function importStudentData(items) {
        if (!items || items.length === 0) {
          alert("没有可导入的学生数据");
          return;
        }

        const existingNames = new Set(students.map((s) => s.name.trim()));
        let importCount = 0;
        let updateCount = 0;

        items.forEach((item) => {
          if (!item.name || !item.name.trim()) return;

          const name = item.name.trim();
          let groupId = null;

          // 处理小组
          if (item.group && item.group.trim()) {
            const groupName = item.group.trim();
            let group = groups.find((g) => g.name.trim() === groupName);

            if (!group) {
              // 创建新小组
              group = { id: generateId(), name: groupName };
              groups.push(group);
            }
            groupId = group.id;
          }

          if (!existingNames.has(name)) {
            // 新增学生
            students.push({
              id: generateId(),
              name: name,
              gender: "male", // 默认性别
              avatar: null,
              totalPoints: item.score ? parseInt(item.score) || 0 : 0,
              usedPoints: item.coins ? parseInt(item.coins) || 0 : 0,
              history: [],
              groupId: groupId,
            });
            importCount++;
          } else {
            // 更新现有学生
            const student = students.find((s) => s.name.trim() === name);
            if (student) {
              if (item.score && !isNaN(parseInt(item.score))) {
                student.totalPoints = parseInt(item.score);
              }
              if (item.coins && !isNaN(parseInt(item.coins))) {
                student.usedPoints = parseInt(item.coins);
              }
              if (groupId) {
                student.groupId = groupId;
              }
              updateCount++;
            }
          }
        });

        saveAllData();
        updateUI();
        closeModal("importModal");

        alert(
          `导入完成！新增 ${importCount} 名学生，更新 ${updateCount} 名学生`
        );
      }

      function normalizeData(input) {
        const out = [];
        const nameKeys = ["name", "姓名"];
        const scoreKeys = ["score", "积分"];
        const coinsKeys = ["coins", "兑换币", "金币"];
        const groupKeys = ["group", "小组"];

        if (Array.isArray(input) && input.length > 0) {
          if (typeof input[0] === "object" && !Array.isArray(input[0])) {
            // 对象数组格式
            input.forEach((obj) => {
              out.push({
                name: findValue(obj, nameKeys),
                score: findValue(obj, scoreKeys),
                coins: findValue(obj, coinsKeys),
                group: findValue(obj, groupKeys),
              });
            });
          } else {
            // 二维数组格式
            let start = 0,
              nameIdx = 0,
              scoreIdx = 1,
              coinsIdx = 2,
              groupIdx = 3;

            if (Array.isArray(input[0])) {
              const headers = input[0].map((h) =>
                String(h || "").toLowerCase()
              );
              const findIdx = (keys) =>
                headers.findIndex((h) =>
                  keys.some((k) => h.includes(k.toLowerCase()))
                );

              const foundName = findIdx(nameKeys);
              const foundScore = findIdx(scoreKeys);
              const foundCoins = findIdx(coinsKeys);
              const foundGroup = findIdx(groupKeys);

              if (
                foundName > -1 ||
                foundScore > -1 ||
                foundCoins > -1 ||
                foundGroup > -1
              ) {
                start = 1;
                if (foundName > -1) nameIdx = foundName;
                if (foundScore > -1) scoreIdx = foundScore;
                if (foundCoins > -1) coinsIdx = foundCoins;
                if (foundGroup > -1) groupIdx = foundGroup;
              }
            }

            for (let i = start; i < input.length; i++) {
              const row = input[i];
              out.push({
                name: row[nameIdx],
                score: row[scoreIdx],
                coins: row[coinsIdx],
                group: row[groupIdx],
              });
            }
          }
        }

        return out;
      }

      function findValue(obj, keys) {
        for (const key of keys) {
          if (obj && key in obj) return obj[key];
        }
        return "";
      }

      function importStudentData(items) {
        const existingNames = new Set(students.map((s) => s.name));
        let importCount = 0;

        items.forEach((item) => {
          if (!item.name) return;

          let groupId = null;
          if (item.group) {
            const group = groups.find((g) => g.name === item.group);
            if (group) {
              groupId = group.id;
            } else {
              // 自动创建小组
              const newGroup = { id: generateId(), name: item.group };
              groups.push(newGroup);
              groupId = newGroup.id;
            }
          }

          if (!existingNames.has(item.name)) {
            students.push({
              id: generateId(),
              name: item.name,
              gender: "male", // 默认性别
              avatar: null,
              totalPoints: parseInt(item.score) || 0,
              usedPoints: 0,
              history: [],
              groupId: groupId,
            });
            importCount++;
          } else {
            // 更新现有学生
            const student = students.find((s) => s.name === item.name);
            if (student) {
              if (item.score && !isNaN(parseInt(item.score))) {
                student.totalPoints = parseInt(item.score);
              }
              if (groupId) {
                student.groupId = groupId;
              }
            }
          }
        });

        saveAllData();
        updateUI();
        closeModal("importModal");

        alert(`导入成功！新增 ${importCount} 名学生`);
      }

      // =================================================================
      // UI更新和渲染功能
      // =================================================================

      function updateUI() {
        renderStudents();
        renderGroups();
        renderLeaderboards();
        renderRules();
        renderShopItems();
      }

      function renderStudents() {
        const allStudentsEl = document.getElementById("allStudents");
        allStudentsEl.innerHTML = "";

        // 按小组分组显示
        const ungroupedStudents = students.filter((s) => !s.groupId);
        const groupedStudents = {};

        students.forEach((student) => {
          if (student.groupId) {
            if (!groupedStudents[student.groupId]) {
              groupedStudents[student.groupId] = [];
            }
            groupedStudents[student.groupId].push(student);
          }
        });

        // 渲染未分组学生
        if (ungroupedStudents.length > 0) {
          const section = document.createElement("div");
          section.className = "group-section";
          section.setAttribute("data-group-id", "空");
          section.innerHTML = `
          <div class="group-header">
            <div class="group-name">未分组</div>
            <div class="group-stats">${
              ungroupedStudents.length
            }人，总分: ${ungroupedStudents.reduce(
            (sum, s) => sum + s.totalPoints,
            0
          )}</div>
          </div>
        `;

          const grid = document.createElement("div");
          grid.className = "student-list";
          ungroupedStudents.forEach((student) => {
            grid.appendChild(createStudentCard(student));
          });
          section.appendChild(grid);
          allStudentsEl.appendChild(section);
        }

        // 渲染各小组
        groups.forEach((group) => {
          if (groupedStudents[group.id]) {
            const section = document.createElement("div");
            section.className = "group-section";
            section.setAttribute("data-group-id", group.id);
            const groupStudents = groupedStudents[group.id];
            section.innerHTML = `
            <div class="group-header">
              <div class="group-name">${group.name}</div>
              <div class="group-stats">${
                groupStudents.length
              }人，总分: ${groupStudents.reduce(
              (sum, s) => sum + s.totalPoints,
              0
            )}</div>
            </div>
          `;

            const grid = document.createElement("div");
            grid.className = "student-list dropzone";
            grid.setAttribute("data-group-id", group.id);
            groupStudents.forEach((student) => {
              grid.appendChild(createStudentCard(student));
            });
            section.appendChild(grid);
            allStudentsEl.appendChild(section);
          }
        });

        // 设置拖拽功能
        // setupDragAndDrop();
      }

      function renderGroups() {
        const groupsArea = document.getElementById("groupsArea");
        groupsArea.innerHTML = "";

        // 定义小组背景色彩
        const groupColors = [
          "#E8F5E8", // 浅绿色
          "#E8F0FF", // 浅蓝色
          "#FFF0E8", // 浅橙色
          "#F0E8FF", // 浅紫色
          "#E8FFF0", // 浅薄荷绿
          "#FFE8F0", // 浅粉色
          "#F0FFE8", // 浅黄绿色
          "#E8F8FF", // 浅天蓝色
        ];

        groups.forEach((group, index) => {
          const groupStudents = students.filter((s) => s.groupId === group.id);
          const totalPoints = groupStudents.reduce(
            (sum, s) => sum + s.totalPoints,
            0
          );
          const totalUsedPoints = groupStudents.reduce(
            (sum, s) => sum + s.usedPoints,
            0
          );
          const availablePoints = totalPoints - totalUsedPoints;

          // 获取未分组的学生用于添加
          const ungroupedStudents = students.filter((s) => !s.groupId);

          // 根据小组索引选择背景色
          const backgroundColor = groupColors[index % groupColors.length];

          const groupDiv = document.createElement("div");
          groupDiv.className = "panel";
          groupDiv.style.background = backgroundColor; // 应用背景色
          groupDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <input type="text" value="${group.name}" id="groupName_${
            group.id
          }" 
                     style="font-size: 16px; font-weight: 800; border: 1px solid transparent; background: rgba(255,255,255,0.7); padding: 4px 8px; border-radius: 6px;"
                     onblur="updateGroupName(${group.id}, this.value)" 
                     onkeypress="if(event.key==='Enter') this.blur()"
                     onfocus="this.style.border='1px solid var(--primary)'; this.style.background='#fff'"
                     onblur="this.style.border='1px solid transparent'; this.style.background='rgba(255,255,255,0.7)'">
              <span style="color: var(--sub); font-size: 14px;">(${
                groupStudents.length
              }人)</span>
            </div>
           <div>
            
              <button class="btn primary btn-sm group-points-btn" data-group-id="${
                group.id
              }">小组积分</button>
              <button class="btn warn btn-sm delete-group-btn" data-group-id="${
                group.id
              }" style="margin-left: 8px;">删除小组</button>
              <button class="control-btn shop-btn" style="padding:8px 16px" onclick="showShopModal2(${
                group.id
              })" title="积分商店">🛒</button>

               <button class="control-btn history-btn" style="padding:8px 16px" onclick="showHistoryModal(${
                 group.id
               })" title="积分记录">📋</button>
          </div>
            </div>
          </div>

          <!-- 积分统计信息 -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.6); border-radius: 12px; backdrop-filter: blur(10px);">
            <div style="text-align: center;">
              <div style="color: var(--sub); font-size: 12px;">总积分</div>
              <div style="color: var(--primary); font-weight: 800; font-size: 18px;">${
                group.integral
              }</div>
            </div>
            <div style="text-align: center;">
              <div style="color: var(--sub); font-size: 12px;">已兑换</div>
              <div style="color: var(--warn); font-weight: 800; font-size: 18px;">${
                group.useintegral
              }</div>
            </div>
            <div style="text-align: center;">
              <div style="color: var(--sub); font-size: 12px;">可用积分</div>
              <div style="color: var(--ok); font-weight: 800; font-size: 18px;">${
                group.integral - group.useintegral
              }</div>
            </div>
          </div>

          <!-- 添加学生功能 -->
          <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center;">
            <select id="addStudentToGroup_${
              group.id
            }" class="form-control" style="flex: 1; max-width: 200px; background: rgba(255,255,255,0.8);">
              <option value="">选择学生加入小组...</option>
              ${ungroupedStudents
                .map((s) => `<option value="${s.id}">${s.name}</option>`)
                .join("")}
            </select>
            <button class="btn ok btn-sm add-student-btn" data-group-id="${
              group.id
            }">
              <i class="fas fa-plus add-student-btn" data-group-id="${
                group.id
              }"></i> 添加
            </button>
          </div>

          <!-- 小组成员列表 -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
            ${groupStudents
              .map(
                (s) => `
              <div style="position: relative; text-align: center; padding: 12px 8px; background: rgba(255,255,255,0.8); border-radius: 12px; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(5px);">
                <button class="remove-student-btn" data-student-id="${s.id}"
                        style="position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; border: none; background: var(--warn); color: #fff; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;"
                        title="移出小组">×</button>
                <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">${
                  s.name
                }</div>
                <div style="color: var(--primary); font-weight: 800; margin-bottom: 2px;">${
                  // s.integral
                  s.totalPoints
                } 总分</div>
                <div style="color: var(--ok); font-size: 12px; font-weight: 600;">${
                  s.totalPoints - s.usedPoints
                } 可用</div>
                <div style="display: flex; gap: 4px; margin-top: 6px; justify-content: center;">
                  <button onclick="showPointsModal(${
                    s.id
                  }, 'add')" class="btn ok" style="padding: 2px 6px; font-size: 10px;">+</button>
                  <button onclick="showPointsModal(${
                    s.id
                  }, 'subtract')" class="btn warn" style="padding: 2px 6px; font-size: 10px;">-</button>
                  <button onclick="showHistoryModal(${
                    s.id
                  })" class="btn secondary" style="padding: 2px 6px; font-size: 10px;">记录</button>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;
          groupsArea.appendChild(groupDiv);
        });

        // 添加事件监听器
        setupGroupEventListeners();
      }

      // function setupGroupEventListeners() {
      //   const groupsArea = document.getElementById('groupsArea');

      //   // 删除小组按钮
      //   groupsArea.addEventListener('click', function (e) {
      //     e.stopPropagation()
      //     if (e.target.classList.contains('delete-group-btn')) {
      //       const groupId = parseInt(e.target.dataset.groupId);
      //       // if (confirm('确定要删除这个小组吗？小组内的学生将返回未分组状态。')) {
      //       // 将小组中的所有学生设为未分组
      //       deleteGroup(groupId)
      //       // students.forEach(student => {
      //       //   if (student.groupId === groupId) {
      //       //     student.groupId = null;
      //       //   }
      //       // });
      //       // 删除小组
      //       // groups = groups.filter(group => group.id !== groupId);
      //       // saveAllData();
      //       // updateUI();
      //       // }
      //     }

      //     // 小组积分按钮
      //     if (e.target.classList.contains('group-points-btn')) {
      //       const groupId = parseInt(e.target.dataset.groupId);
      //       showGroupPointsModal(groupId);
      //     }

      //     // 添加学生按钮
      //     if (e.target.classList.contains('add-student-btn')) {
      //       const groupId = parseInt(e.target.dataset.groupId);
      //       addStudentToGroup(groupId);
      //     }

      //     // 移除学生按钮
      //     if (e.target.classList.contains('remove-student-btn')) {
      //       const studentId = parseInt(e.target.dataset.studentId);
      //       removeStudentFromGroup(studentId);
      //     }
      //   });
      // }
      let handleGroupClick;
      function setupGroupEventListeners() {
        const groupsArea = document.getElementById("groupsArea");
        // 先移除已存在的同名事件监听（关键步骤）
        groupsArea.removeEventListener("click", handleGroupClick);

        // 如果已经存在旧的监听器，先移除
        if (handleGroupClick) {
          groupsArea.removeEventListener("click", handleGroupClick);
        }

        // 定义命名的事件处理函数，便于后续移除
        handleGroupClick = function (e) {
          e.stopPropagation();

          // 删除小组按钮
          if (e.target.classList.contains("delete-group-btn")) {
            const groupId = parseInt(e.target.dataset.groupId);
            deleteGroup(groupId);
          }

          // 小组积分按钮
          if (e.target.classList.contains("group-points-btn")) {
            const groupId = parseInt(e.target.dataset.groupId);
            console.trace("22 -->", 22);
            showGroupPointsModal(groupId);
          }
          console.log("e.target -->", e.target);
          // 添加学生按钮
          if (e.target.classList.contains("add-student-btn")) {
            const groupId = parseInt(e.target.dataset.groupId);
            addStudentToGroup(groupId);
          }

          // 移除学生按钮
          if (e.target.classList.contains("remove-student-btn")) {
            const studentId = parseInt(e.target.dataset.studentId);
            removeStudentFromGroup(studentId);
          }
        };

        // 再添加新的事件监听
        groupsArea.addEventListener("click", handleGroupClick);
      }

      function renderLeaderboards() {
        // 个人排行榜
        const studentList = document.getElementById("studentLeaderboardList");
        studentList.innerHTML = "";

        const sortedStudents = [...students].sort(
          (a, b) => b.totalPoints - a.totalPoints
        );

        // .slice(0, 10);
        sortedStudents.forEach((student, index) => {
          const rank = index + 1;
          const rankClass = rank <= 3 ? `rank-${rank}` : "";

          const item = document.createElement("div");
          item.className = "leaderboard-item";
          item.innerHTML = `
          <div class="rank-badge ${rankClass}">${rank}</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">${student.name}</div>
            <div class="leaderboard-points">${student.totalPoints}分</div>
          </div>
        `;
          studentList.appendChild(item);
        });

        // 小组排行榜
        const groupList = document.getElementById("groupLeaderboardList");
        groupList.innerHTML = "";

        const groupPoints = groups.map((group) => {
          const groupStudents = students.filter((s) => s.groupId === group.id);
          // const totalPoints = groupStudents.reduce(
          //   (sum, s) => sum + s.totalPoints,
          //   0
          // );
          let totalPoints = 0;
          if (group.integral > 0) {
            // totalPoints = group.integral / groupStudents.length;
            totalPoints = group.integral;
          }

          return {
            name: group.name,
            points: totalPoints,
            memberCount: groupStudents.length,
          };
        });

        const sortedGroups = groupPoints.sort((a, b) => b.points - a.points);
        sortedGroups.forEach((group, index) => {
          const rank = index + 1;
          const rankClass = rank <= 3 ? `rank-${rank}` : "";

          const item = document.createElement("div");
          item.className = "leaderboard-item";
          item.innerHTML = `
          <div class="rank-badge ${rankClass}">${rank}</div>
          <div class="leaderboard-info">
            <div class="leaderboard-name">${group.name} (${group.memberCount}人)</div>
            <div class="leaderboard-points">${group.points}分</div>
          </div>
        `;
          groupList.appendChild(item);
        });
      }

      function renderRules() {
        const rulesList = document.getElementById("rulesList");
        rulesList.innerHTML = "";

        rules.forEach((rule, index) => {
          const item = document.createElement("div");
          const isPositive = rule.points > 0;
          item.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          margin-bottom: 6px;
          border-radius: 8px;
          background: var(--light);
          border-left: 4px solid ${isPositive ? "var(--ok)" : "var(--warn)"};
        `;

          const sign = rule.points > 0 ? "+" : "";
          item.innerHTML = `
          <span style="flex: 1; font-weight: 600;">${rule.name}</span>
          <span style="color: ${
            isPositive ? "var(--ok)" : "var(--warn)"
          }; font-weight: 800; margin-right: 12px;">${sign}${rule.points}</span>
          <button onclick="eidtRule(${index})" class="btn flat btn-sm" style="padding: 4px 8px;margin-right:10px;">编辑</button>
          <button onclick="deleteRule(${index})" class="btn warn btn-sm" style="padding: 4px 8px;">删除</button>
        `;

          rulesList.appendChild(item);
        });
      }

      function renderShopItems() {
        const shopItemsEl = document.getElementById("shopItems");
        shopItemsEl.innerHTML = "";

        shopItems.forEach((item, index) => {
          const div = document.createElement("div");
          div.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          margin-bottom: 6px;
          border-radius: 8px;
          background: var(--light);
          border-left: 4px solid var(--accent1);
        `;

          div.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: 600;">${item.name}</div>
            <div style="display:flex;  align-items: flex-end;">
              <div style="color: var(--primary); font-weight: 800; font-size: 14px;">${item.cost} 积分 </div>
              <div style=" color:#a76969; font-weight: 800; font-size: 14px; margin-left:10px;   "> 库存:${item.stock} </div>
            </div>
          </div>
          <button onclick="editShopItem(${index})" class="btn flat btn-sm" style="padding: 4px 8px;margin-right:10px;">编辑</button>
          <button onclick="deleteShopItem(${index})" class="btn warn btn-sm" style="padding: 4px 8px;">删除</button>
        `;

          shopItemsEl.appendChild(div);
        });
      }

      function renderEditRule() {
        const ruleBox = document.getElementById("shopItems");
        shopItemsEl.innerHTML = "";
        const div = document.createElement("div");

        shopItemsEl.appendChild(div);
      }

      //===================日周月年===========================
      // 工具函数：判断时间是否在指定天数内
      function isWithinDays(dateStr, days) {
        const now = new Date();
        const target = new Date(dateStr);
        const diffTime = now - target;
        const diffDays = diffTime / (1000 * 60 * 60 * 24);
        return diffDays < days;
      }

      // 计算排行榜
      function getRanking(period = "day") {
        const daysMap = {
          day: 1,
          week: 7,
          month: 30,
          year: 365,
        };
        const days = daysMap[period];

        // 按学生统计指定周期内获得的积分
        const pointsMap = {};

        students.forEach((student) => {
          const recentHistory = student.history.filter((record) =>
            isWithinDays(record.date, days)
          );

          const total = recentHistory.reduce(
            (sum, rec) => sum + (rec.points > 0 ? rec.points : 0),
            0
          );

          if (total > 0) {
            pointsMap[student.id] = {
              name: student.name,
              points: total,
              avatar: student.avatar || "🧍", // 可选头像
            };
          }
        });

        // 按积分降序排序
        return Object.entries(pointsMap)
          .map(([id, data]) => ({ id, ...data }))
          .sort((a, b) => b.points - a.points);
      }

      function showRankModal(period) {
        const titleMap = {
          day: "日榜",
          week: "周榜",
          month: "月榜",
          year: "年榜",
          class: "切换班级",
        };

        const ranking = getRanking(period);
        const modalContent = document.getElementById("modalContent");

        const rankHtml =
          ranking.length > 0
            ? ranking
                .map(
                  (item, index) => `
                  <div class="rank-item" style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                    <div style="width: 30px; font-weight: bold; color: ${
                      index === 0
                        ? "gold"
                        : index === 1
                        ? "silver"
                        : index === 2
                        ? "#b87333"
                        : "#666"
                    };">
                      ${["🥇", "🥈", "🥉"][index] || index + 1}
                    </div>
                    <div style="flex: 1; padding: 0 12px;">${item.name}</div>
                    <div style="color: var(--primary); font-weight: 600;">+${
                      item.points
                    }分</div>
                  </div>
                `
                )
                .join("")
            : '<div style="text-align: center; color: #999; padding: 20px;">暂无数据</div>';

        modalContent.innerHTML = `
            <h3>${titleMap[period]}</h3>
            <div class="rank-list" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
              ${rankHtml}
            </div>
            <button onclick="closeModal('modal')" class="btn">关闭</button>
          `;

        showModal("modal");
      }

      //===================日周月年 end===========================

      // =================================================================
      // 拖拽功能
      // =================================================================

      function setupDragAndDrop() {
        document.querySelectorAll(".dropzone").forEach((zone) => {
          zone.addEventListener("dragover", function (e) {
            e.preventDefault();
            this.classList.add("drag-over");
          });

          zone.addEventListener("dragleave", function () {
            this.classList.remove("drag-over");
          });

          zone.addEventListener("drop", function (e) {
            e.preventDefault();
            this.classList.remove("drag-over");

            const studentId = parseInt(e.dataTransfer.getData("text/plain"));
            let groupId = this.getAttribute("data-group-id");
            console.log("this -->", this);
            console.dir(this);
            if (!groupId) {
              groupId = this.children[0].getAttribute("data-group-id");
            }

            if (groupId) {
              const studentIndex = students.findIndex(
                (s) => s.id === studentId
              );
              if (studentIndex !== -1) {
                students[studentIndex].groupId =
                  groupId != "空" ? parseInt(groupId) : null;
                saveAllData();
                updateUI();
              }
            }
          });
        });
      }

      // =================================================================
      // 随机点名功能
      // =================================================================

      function showRollCallModal() {
        if (students.length === 0) {
          alert("请先添加学生！");
          return;
        }

        const modal = document.getElementById("rollCallModal");
        const studentListEl = document.getElementById("rollCallStudentList");
        const countSelectEl = document.getElementById("rollCallCount");

        // 填充学生列表
        studentListEl.innerHTML = "";
        students.forEach((student) => {
          const studentEl = document.createElement("div");
          studentEl.style.cssText = `
          display: flex;
          flex-direction: column;
          align-items: center;
          width: 80px;
          transition: all 0.3s ease;
        `;
          studentEl.dataset.id = student.id;

          const avatar = document.createElement("div");
          avatar.style.cssText = `
          width: 60px;
          height: 60px;
          border-radius: 50%;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 24px;
          font-weight: 700;
          color: white;
          margin-bottom: 8px;
          border: 3px solid transparent;
          background: ${
            student.gender === "male"
              ? "linear-gradient(135deg, var(--secondary) 0%, #a8dcc2 100%)"
              : "linear-gradient(135deg, var(--warn) 0%, #ffc7c0 100%)"
          };
        `;

          if (student.avatar) {
            avatar.innerHTML = `<img src="${student.avatar}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
          } else {
            avatar.textContent = student.name.charAt(0);
          }

          const name = document.createElement("div");
          name.style.cssText =
            "font-weight: 600; font-size: 12px; color: var(--text); text-align: center;";
          name.textContent = student.name;

          studentEl.appendChild(avatar);
          studentEl.appendChild(name);
          studentListEl.appendChild(studentEl);
        });

        // 填充下拉框
        countSelectEl.innerHTML = "";
        for (let i = 1; i <= students.length; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          countSelectEl.appendChild(option);
        }
        countSelectEl.value = 1;

        showModal("rollCallModal");
        resetRollCall();
      }

      function startRollCallAnimation() {
        const startBtn = document.getElementById("startRollCallBtn");
        const resetBtn = document.getElementById("resetRollCallBtn");
        const countSelect = document.getElementById("rollCallCount");
        const studentListEl = document.getElementById("rollCallStudentList");
        const studentElements = studentListEl.querySelectorAll("div[data-id]");

        const count = parseInt(countSelect.value);

        if (count > studentElements.length) {
          alert("抽取人数不能超过总人数！");
          return;
        }

        startBtn.disabled = true;
        countSelect.disabled = true;

        let animationDuration = 3000;
        let highlightInterval = 80;
        let lastHighlighted = -1;

        rollCallInterval = setInterval(() => {
          if (lastHighlighted !== -1) {
            const lastEl =
              studentElements[lastHighlighted].querySelector("div");
            lastEl.style.borderColor = "transparent";
            lastEl.style.transform = "scale(1)";
          }

          let randomIndex = Math.floor(Math.random() * studentElements.length);
          const currentEl = studentElements[randomIndex].querySelector("div");
          currentEl.style.borderColor = "var(--accent1)";
          currentEl.style.transform = "scale(1.1)";
          currentEl.style.boxShadow = "0 0 20px var(--accent1)";

          lastHighlighted = randomIndex;
        }, highlightInterval);

        setTimeout(() => {
          clearInterval(rollCallInterval);
          if (lastHighlighted !== -1) {
            const lastEl =
              studentElements[lastHighlighted].querySelector("div");
            lastEl.style.borderColor = "transparent";
            lastEl.style.transform = "scale(1)";
            lastEl.style.boxShadow = "";
          }

          // 随机选择最终结果
          const indices = Array.from(studentElements.keys());
          const shuffledIndices = indices.sort(() => 0.5 - Math.random());
          const winningIndices = shuffledIndices.slice(0, count);

          // 隐藏未选中的学生
          studentElements.forEach((el, index) => {
            if (!winningIndices.includes(index)) {
              el.style.opacity = "0.2";
              el.style.transform = "scale(0.8)";
            } else {
              const avatar = el.querySelector("div");
              avatar.style.borderColor = "var(--ok)";
              avatar.style.transform = "scale(1.3)";
              avatar.style.boxShadow = "0 0 25px var(--ok)";
              el.style.margin = "0 20px";
            }
          });

          startBtn.style.display = "none";
          resetBtn.style.display = "inline-flex";
        }, animationDuration);
      }

      function resetRollCall() {
        clearInterval(rollCallInterval);
        const studentListEl = document.getElementById("rollCallStudentList");

        studentListEl.querySelectorAll("div[data-id]").forEach((el) => {
          const avatar = el.querySelector("div");
          avatar.style.borderColor = "transparent";
          avatar.style.transform = "scale(1)";
          avatar.style.boxShadow = "";
          el.style.opacity = "1";
          el.style.transform = "scale(1)";
          el.style.margin = "0";
        });

        const startBtn = document.getElementById("startRollCallBtn");
        const resetBtn = document.getElementById("resetRollCallBtn");
        const countSelect = document.getElementById("rollCallCount");

        startBtn.style.display = "inline-flex";
        startBtn.disabled = false;
        resetBtn.style.display = "none";
        countSelect.disabled = false;
      }

      // =================================================================
      // 其他功能函数
      // =================================================================

      function addRule() {
        const ruleName = document.getElementById("ruleName").value.trim();
        const rulePoints = parseInt(
          document.getElementById("rulePoints").value
        );

        if (!ruleName || isNaN(rulePoints))
          return alert("请填写完整的规则信息");

        rules.push({
          id: generateId(),
          name: ruleName,
          points: rulePoints,
        });

        document.getElementById("ruleName").value = "";
        document.getElementById("rulePoints").value = "";

        saveAllData();
        renderRules();
      }

      function deleteRule(index) {
        if (!confirm("确定要删除这条规则吗？")) return;

        rules.splice(index, 1);
        saveAllData();
        renderRules();
      }
      let editRuleFun = null;

      function eidtRule(index) {
        const ruleNameInput = document.getElementById("edititemName");
        const ruleCostInput = document.getElementById("edititemCost");

        ruleNameInput.value = rules[index].name;
        ruleCostInput.value = rules[index].points;
        showModal("editRuleModal");

        // ✅ 定义要绑定的函数（使用闭包捕获 index）
        const handleSubmit = function () {
          const name = ruleNameInput.value.trim();
          const cost = parseInt(ruleCostInput.value);

          if (!name || isNaN(cost) || cost <= 0) {
            return alert("请填写完整的商品信息");
          }

          rules[index].name = name;
          rules[index].points = cost;
          saveAllData();
          renderRules();
          closeModal("editRuleModal");
        };

        const btn = document.getElementById("editRulebtn");

        // 🔴 关键：必须先移除上一次绑定的同一个函数引用
        if (editRuleFun) {
          btn.removeEventListener("click", editRuleFun);
          console.log("已移除之前的监听器");
        }

        // ✅ 更新引用，并绑定新函数
        editRuleFun = handleSubmit;
        btn.addEventListener("click", editRuleFun);

        console.log("当前绑定的函数引用:", editRuleFun);
      }

      let editStoreItemFun = null;
      function editShopItem(index) {
        const storeCostInput = document.getElementById("editStoreCost");
        const storeStockInput = document.getElementById("editStoreStock");
        const storeNameInput = document.getElementById("editStoreName");

        storeCostInput.value = shopItems[index].cost;
        storeStockInput.value = shopItems[index].stock;
        storeNameInput.value = shopItems[index].name;

        showModal("editStoreModal");

        // ✅ 定义要绑定的函数（使用闭包捕获 index）
        const handleSubmit = function () {
          if (
            !storeNameInput.value ||
            isNaN(storeStockInput.value) ||
            storeStockInput.value <= 0 ||
            isNaN(storeCostInput.value) ||
            storeCostInput.value <= 0
          ) {
            return alert("请填写完整的商品信息");
          }

          shopItems[index].name = storeNameInput.value;
          shopItems[index].cost = storeCostInput.value;
          shopItems[index].stock = storeStockInput.value;

          saveAllData();
          renderShopItems();
          closeModal("editStoreModal");
        };

        const btn = document.getElementById("editStoreItemBtn");

        // 🔴 关键：必须先移除上一次绑定的同一个函数引用
        if (editStoreItemFun) {
          btn.removeEventListener("click", editStoreItemFun);
          console.log("已移除之前的监听器");
        }

        // ✅ 更新引用，并绑定新函数
        editStoreItemFun = handleSubmit;
        btn.addEventListener("click", editStoreItemFun);

        console.log("当前绑定的函数引用:", editStoreItemFun);
      }

      function addShopItem() {
        const itemName = document.getElementById("itemName").value.trim();
        const itemCost = parseInt(document.getElementById("itemCost").value);
        const itemStock = parseInt(document.getElementById("itemStock").value);
        if (
          !itemName ||
          isNaN(itemCost) ||
          itemCost <= 0 ||
          isNaN(itemStock) ||
          itemStock <= 0
        )
          return alert("请填写完整的商品信息");

        shopItems.push({
          id: generateId(),
          name: itemName,
          cost: itemCost,
          stock: itemStock,
        });
        document.getElementById("itemName").value = "";
        document.getElementById("itemCost").value = "";
        document.getElementById("itemStock").value = "";
        saveAllData();
        renderShopItems();
      }

      function addAwardItem() {
        const awardItem = document.querySelector("#awardName");
        if (!awardItem.value.trim()) {
          alert("奖品名称不能为空！");
          return;
        }
        if (awardList.length < 8) {
          awardList.push({ name: awardItem.value, id: generateId() });
          awardItem.value = "";
        } else {
          alert("最多可设置8个奖品");
          return;
        }

        saveAllData();

        updataAwaitUi();

        // showModal("setsetAwardModal");
      }

      function deleteAward(id) {
        const awardItemIndex = awardList.findIndex((s) => s.id == id);
        awardList.splice(awardItemIndex, 1);
        saveAllData();
        updataAwaitUi();
      }

      function deleteShopItem(index) {
        if (!confirm("确定要删除这个商品吗？")) return;

        shopItems.splice(index, 1);
        saveAllData();
        renderShopItems();
      }

      function resetAllStudentPoints() {
        if (!confirm("确定要将所有学生的积分清零吗？此操作不可撤销！")) return;
        if (
          !confirm(
            "二次确认：这将清除所有学生的积分和积分历史记录，确定继续吗？"
          )
        )
          return;

        students.forEach((student) => {
          student.totalPoints = 0;
          student.usedPoints = 0;
          student.history = [];
        });

        saveAllData();
        updateUI();
        alert("所有学生积分已清零！");
      }

      // =================================================================
      // 事件监听器设置
      // =================================================================

      function setupEventListeners() {
        // 学生管理
        document
          .getElementById("addStudentBtn")
          .addEventListener("click", addStudent);

        // 小组管理
        document
          .getElementById("addGroupBtn")
          .addEventListener("click", addGroup);

        // 规则管理
        document
          .getElementById("addRuleBtn")
          .addEventListener("click", addRule);

        // 商店管理
        document
          .getElementById("addItemBtn")
          .addEventListener("click", addShopItem);

        document
          .getElementById("addAwardBtn")
          .addEventListener("click", addAwardItem);

        // 数据管理
        document
          .getElementById("exportDataBtn")
          .addEventListener("click", exportData);
        document
          .getElementById("importDataBtn")
          .addEventListener("click", showImportModal);
        document
          .getElementById("parseFileBtn")
          .addEventListener("click", handleFileImport);
        document
          .getElementById("parseTextBtn")
          .addEventListener("click", handleTextImport);

        // 功能按钮
        document
          .getElementById("randomRollCallBtn")
          .addEventListener("click", showRollCallModal);
        document
          .getElementById("resetAllPoints")
          .addEventListener("click", resetAllStudentPoints);

        // 搜索功能
        document
          .getElementById("searchBtn")
          .addEventListener("click", searchStudents);
        document
          .getElementById("studentSearchInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              searchStudents();
            }
          });
        document
          .getElementById("studentSearchInput")
          .addEventListener("input", function () {
            // 如果搜索框被清空，自动显示所有学生
            if (this.value.trim() === "") {
              clearSearch();
            }
          });

        // 全员和多选积分功能
        document
          .getElementById("globalAddPoints")
          .addEventListener("click", () => showGlobalPointsModal("add"));
        document
          .getElementById("globalSubtractPoints")
          .addEventListener("click", () => showGlobalPointsModal("subtract"));

        // 新的多选编辑模式
        document
          .getElementById("multiSelectMode")
          .addEventListener("click", enterMultiSelectMode);
        document
          .getElementById("exitMultiSelectMode")
          .addEventListener("click", exitMultiSelectMode);

        // 多选操作按钮
        document
          .getElementById("multiSelectAdd")
          .addEventListener("click", () => showMultiSelectPointsModal("add"));
        document
          .getElementById("multiSelectSubtract")
          .addEventListener("click", () =>
            showMultiSelectPointsModal("subtract")
          );
        document
          .getElementById("multiSelectDelete")
          .addEventListener("click", deleteSelectedStudents);

        // 随机点名
        document
          .getElementById("startRollCallBtn")
          .addEventListener("click", startRollCallAnimation);
        document
          .getElementById("resetRollCallBtn")
          .addEventListener("click", resetRollCall);

        // 标签页切换
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const tabId = this.getAttribute("data-tab");

            document
              .querySelectorAll(".tab-btn")
              .forEach((b) => b.classList.remove("active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((content) => content.classList.remove("active"));

            this.classList.add("active");
            document.getElementById(tabId).classList.add("active");
          });
        });

        // 模态框关闭
        document.querySelectorAll(".close").forEach((btn) => {
          btn.addEventListener("click", function () {
            this.closest(".modal").style.display = "none";
          });
        });

        // 点击模态框背景关闭
        // window.addEventListener("click", function (event) {
        //   if (event.target.classList.contains("modal")) {
        //     event.target.style.display = "none";
        //   }
        // });
      }
      function updataAwaitUi() {
        const contentHtml = document.querySelector("#awardList");

        let awardListHtml = "";
        if (awardList.length > 0) {
          awardListHtml =
            '<div style="display: grid;  gap: 12px; margin-top: 16px;">';
          awardList.forEach((item) => {
            awardListHtml += `
              <div style="background: var(--light); border: 1px solid var(--line); border-radius: 12px; padding: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px;display: flex; align-items: center;justify-content: space-between;">
                  <div>${item.name}</div> 
                  <div class="btn warn" onclick="deleteAward(${item.id})">删除</div>
                </div>
              </div>`;
          });
          awardListHtml += "</div>";
        } else {
          awardListHtml = "<p>奖池暂无奖品</p>";
        }
        contentHtml.innerHTML = awardListHtml;
      }

      // =================================================================
      // 初始化应用
      // =================================================================

      // 将所有需要在HTML中调用的函数暴露到全局作用域
      window.deleteGroup = deleteGroup;
      window.updateGroupName = updateGroupName;
      window.addStudentToGroup = addStudentToGroup;
      window.removeStudentFromGroup = removeStudentFromGroup;
      window.showGroupPointsModal = showGroupPointsModal;
      window.applyPointsToGroup = applyPointsToGroup;
      window.applyCustomPointsToGroup = applyCustomPointsToGroup;
      window.showPointsModal = showPointsModal;
      window.applyPoints = applyPoints;
      window.applyCustomPoints = applyCustomPoints;
      window.showHistoryModal = showHistoryModal;
      window.revertHistoryItem = revertHistoryItem;
      window.showShopModal = showShopModal;
      window.showShopModal2 = showShopModal2;
      window.copyUrl = copyUrl;

      window.purchaseItem = purchaseItem;
      window.purchaseItem2 = purchaseItem2;

      window.deleteStudent = deleteStudent;
      window.updateStudentName = updateStudentName;
      window.uploadAvatar = uploadAvatar;
      window.handleAvatarUpload = handleAvatarUpload;
      window.applyPointsToAllStudents = applyPointsToAllStudents;
      window.applyCustomPointsToAllStudents = applyCustomPointsToAllStudents;
      window.applyPointsToSelectedStudents = applyPointsToSelectedStudents;
      window.applyCustomPointsToSelectedStudents =
        applyCustomPointsToSelectedStudents;
      window.deleteRule = deleteRule;
      window.deleteShopItem = deleteShopItem;
      window.closeModal = closeModal;
      window.updataAwaitUi = updataAwaitUi;

      function initApp() {
        loadAllData();
        setupEventListeners();
        updateUI();
        console.log("班级积分管理系统已加载完成");
      }

      // 页面加载完成后初始化
      document.addEventListener("DOMContentLoaded", initApp);
    </script>

    <script>
      // 全局变量
      let systemTitle = "班级积分管理系统";
      let systemSlogan = "在这里，积分记录每一次成长 🏆"; // 标语变量

      // 标题修改功能
      document
        .getElementById("editTitleBtn")
        .addEventListener("click", function () {
          const newTitle = prompt("请输入新的系统名称:", systemTitle);
          if (newTitle !== null && newTitle.trim() !== "") {
            systemTitle = newTitle.trim();
            document.getElementById("systemTitle").textContent = systemTitle;
            saveAllData(); // 保存修改
            alert("系统名称已更新");
          }
        });

      // 标语修改功能
      document
        .getElementById("editSloganBtn")
        .addEventListener("click", function () {
          const newSlogan = prompt("请输入新的标语:", systemSlogan);
          if (newSlogan !== null && newSlogan.trim() !== "") {
            systemSlogan = newSlogan.trim();
            document.getElementById("systemSlogan").textContent = systemSlogan;
            saveAllData(); // 保存修改
            alert("标语已更新");
          }
        });

      // 顶部模块隐藏显示
      document.querySelector("#sun").addEventListener("click", function () {
        const s = document.querySelector(".hero");
        console.dir(s);
        if (s.style.height) {
          s.style.minHeight = "360px";
          s.style.height = "";
        } else {
          s.style.height = 78 + "px";
          s.style.minHeight = 78 + "px";
        }
      });
      // 页面加载时读取数据
      loadAllData();
    </script>
    <script>
      // =================================================================
      // 计时器功能
      // =================================================================
      let timerInterval = null;
      let totalSeconds = 0;
      let isTimerRunning = false;

      // 格式化时间显示
      function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;
        return [
          h.toString().padStart(2, "0"),
          m.toString().padStart(2, "0"),
          s.toString().padStart(2, "0"),
        ].join(":");
      }

      // 启动计时器
      function startTimer() {
        if (isTimerRunning) return;

        // 获取用户输入的时间
        const hours =
          parseInt(document.getElementById("timerHours").value) || 0;
        const minutes =
          parseInt(document.getElementById("timerMinutes").value) || 0;
        const seconds =
          parseInt(document.getElementById("timerSeconds").value) || 0;

        // 计算总秒数，如果已经在计时则继续
        totalSeconds =
          totalSeconds > 0
            ? totalSeconds
            : hours * 3600 + minutes * 60 + seconds;

        // 确保至少有1秒
        if (totalSeconds <= 0) {
          totalSeconds = 1;
        }

        isTimerRunning = true;

        // 更新按钮状态
        document.getElementById("startTimerBtn").style.display = "none";
        document.getElementById("pauseTimerBtn").style.display = "inline-flex";

        // 开始计时
        timerInterval = setInterval(() => {
          totalSeconds--;
          document.getElementById("timerDisplay").textContent =
            formatTime(totalSeconds);

          // 计时结束
          if (totalSeconds <= 0) {
            clearInterval(timerInterval);
            isTimerRunning = false;
            document.getElementById("startTimerBtn").style.display =
              "inline-flex";
            document.getElementById("pauseTimerBtn").style.display = "none";
          }
        }, 1000);
      }

      // 暂停计时器
      function pauseTimer() {
        clearInterval(timerInterval);
        isTimerRunning = false;
        document.getElementById("startTimerBtn").style.display = "inline-flex";
        document.getElementById("pauseTimerBtn").style.display = "none";
      }

      // 重置计时器
      function resetTimer() {
        clearInterval(timerInterval);
        isTimerRunning = false;
        totalSeconds = 0;
        document.getElementById("timerDisplay").textContent = "00:00:00";
        document.getElementById("timerHours").value = "0";
        document.getElementById("timerMinutes").value = "0";
        document.getElementById("timerSeconds").value = "10";
        document.getElementById("startTimerBtn").style.display = "inline-flex";
        document.getElementById("pauseTimerBtn").style.display = "none";
      }

      // 绑定计时器按钮事件
      function initTimer() {
        // 打开计时器模态框
        document.getElementById("timerBtn").addEventListener("click", () => {
          showModal("timerModal");
        });

        // 关闭按钮
        document
          .querySelector("#timerModal .close")
          .addEventListener("click", () => {
            closeModal("timerModal");
            pauseTimer(); // 关闭时暂停计时
          });

        // 计时器控制按钮
        document
          .getElementById("startTimerBtn")
          .addEventListener("click", startTimer);
        document
          .getElementById("pauseTimerBtn")
          .addEventListener("click", pauseTimer);
        document
          .getElementById("resetTimerBtn")
          .addEventListener("click", resetTimer);
      }

      // 在现有初始化函数中添加计时器初始化
      // 找到页面中已有的初始化函数，添加 initTimer()
      // 例如在页面加载完成后调用：
      document.addEventListener("DOMContentLoaded", function () {
        // 其他初始化代码...
        initTimer();
      });
    </script>
    <script>
      // 密码相关功能
      let isPasswordSet = false;
      let currentPasswordHash = null;
      const PASSWORD_KEY = "classPointsSystemPassword";

      // 验证密码
      function verifyPassword(password) {
        return simpleHash(password) === currentPasswordHash;
      }
      // 初始化密码状态
      function initPassword() {
        try {
          const savedHash = localStorage.getItem(PASSWORD_KEY);
          if (savedHash) {
            currentPasswordHash = savedHash;
            isPasswordSet = true;
            // 显示密码验证框
            showModal("passwordVerifyModal");
            // 隐藏主内容
            document.querySelector("main").style.display = "none";
            document.querySelector("aside").style.display = "none";
          }
        } catch (error) {
          console.error("初始化密码系统失败:", error);
        }
      }

      // 简单的哈希函数（实际应用中应使用更安全的加密方式）
      function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          const char = str.charCodeAt(i);
          hash = (hash << 5) - hash + char;
          hash = hash & hash; // 转换为32位整数
        }
        return Math.abs(hash).toString();
      }

      // 设置新密码
      function setNewPassword(newPassword) {
        if (newPassword.length < 6) {
          alert("密码长度不能少于6位");
          return false;
        }

        currentPasswordHash = simpleHash(newPassword);
        localStorage.setItem(PASSWORD_KEY, currentPasswordHash);
        isPasswordSet = true;
        return true;
      }

      // 清除密码
      function clearPassword(Password) {
        if (!isPasswordSet) return true;

        if (verifyPassword(Password)) {
          localStorage.removeItem(PASSWORD_KEY);
          currentPasswordHash = null;
          isPasswordSet = false;
          return true;
        }
        return false;
      }

      // 密码相关事件监听
      function setupPasswordEventListeners() {
        // 密码设置按钮
        document
          .getElementById("passwordSettingsBtn")
          .addEventListener("click", () => {
            const passwordSettingsModal = document.getElementById(
              "passwordSettingsModal"
            );
            const currentPasswordSection = document.getElementById(
              "currentPasswordSection"
            );

            // 如果已有密码，显示当前密码输入框
            if (isPasswordSet) {
              currentPasswordSection.style.display = "block";
              document.getElementById("currentPassword").value = "";
              document.getElementById("currentPasswordError").style.display =
                "none";
            } else {
              currentPasswordSection.style.display = "none";
            }

            // 重置表单
            document.getElementById("newPassword").value = "";
            document.getElementById("confirmPassword").value = "";
            document.getElementById("passwordMismatch").style.display = "none";

            showModal("passwordSettingsModal");
          });

        // 保存密码按钮
        document
          .getElementById("savePasswordBtn")
          .addEventListener("click", () => {
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword =
              document.getElementById("confirmPassword").value;

            // 检查密码是否一致
            if (newPassword !== confirmPassword) {
              document.getElementById("passwordMismatch").style.display =
                "block";
              return;
            }

            // 如果已有密码，验证当前密码
            if (isPasswordSet) {
              const currentPassword =
                document.getElementById("currentPassword").value;
              if (!verifyPassword(currentPassword)) {
                document.getElementById("currentPasswordError").style.display =
                  "block";
                return;
              }
            }

            // 设置新密码
            if (setNewPassword(newPassword)) {
              alert("密码设置成功");
              closeModal("passwordSettingsModal");
            }
          });

        // 清除密码按钮
        document
          .getElementById("clearPasswordBtn")
          .addEventListener("click", () => {
            if (!isPasswordSet) {
              alert("当前未设置密码");
              return;
            }
            confirm("确定要清除密码吗？清除后任何人都可以访问系统。");
            if (confirm("确定要清除密码吗？清除后任何人都可以访问系统。")) {
              const currentPassword =
                document.getElementById("currentPassword").value;

              if (verifyPassword(currentPassword)) {
                clearPassword(currentPassword);
                alert("密码已清除");
                closeModal("passwordSettingsModal");
              } else {
                document.getElementById("currentPasswordError").style.display =
                  "block";
              }
            }
          });

        // 密码验证提交
        document
          .getElementById("submitPasswordBtn")
          .addEventListener("click", () => {
            const password = document.getElementById("verifyPassword").value;
            if (verifyPassword(password)) {
              closeModal("passwordVerifyModal");
              // 显示主内容
              document.querySelector("main").style.display = "block";
              document.querySelector("aside").style.display = "flex";
            } else {
              document.getElementById("passwordError").style.display = "block";
            }
          });
        // 忘记密码弹框
        document
          .querySelector("#forgetPasswordBtn")
          .addEventListener("click", () => {
            closeModal("passwordVerifyModal");
            showModal("forgetPasswordModal");
          });
        document
          .querySelector("#removetPasswordBtn")
          .addEventListener("click", () => {
            // verifykey
            const secretKeyValue = document.querySelector("#verifykey").value;
            console.log("secretKeyValue -->", secretKeyValue);
            console.log("secretKey -->", secretKey);
            if (secretKey == secretKeyValue) {
              console.log("清除本地密码， -->");
              localStorage.removeItem(PASSWORD_KEY);
              document.getElementById("passwordError2").style.display = "none";
              document.querySelector("main").style.display = "block";
              document.querySelector("aside").style.display = "block";
              loadAllData();
              closeModal("forgetPasswordModal");
            } else {
              document.getElementById("passwordError2").style.display = "block";
            }
          });

        document
          .querySelector("#backPasswordBtn")
          .addEventListener("click", () => {
            closeModal("forgetPasswordModal");
            showModal("passwordVerifyModal");
          });

        // 按Enter键提交密码
        document
          .getElementById("verifyPassword")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              document.getElementById("submitPasswordBtn").click();
            }
          });
      }

      // 规则相关事件监听
      function setupIntegrationRuleEventListeners() {
        // 规则按钮
        document
          .getElementById("integrationruleBtn")
          .addEventListener("click", () => {
            console.log("dianj -->");
            const ruleSettingsModal =
              document.getElementById("ruleSettingsModal");

            showModal("ruleSettingsModal");

            renderRules();
          });
      }

      // 规则相关事件监听
      function setupMallEventListeners() {
        // 规则按钮
        document
          .getElementById("integralshoppingmallBtn")
          .addEventListener("click", () => {
            const ruleSettingsModal =
              document.getElementById("mallSettingsModal");

            showModal("mallSettingsModal");
            renderShopItems();
          });

        document.getElementById("removeAll").addEventListener("click", () => {
          // 弹出输入框，提示用户输入名字，默认值为 "小明"
          if (confirm("清理本地数据后不可恢复！请确认")) {
            // 清除所有 localStorage 数据
            localStorage.clear();
            loadAllData();

            updateUI();
            alert("清理成功");
          }
        });

        document.getElementById("setsetAward").addEventListener("click", () => {
          // loadAllData();
          // updateUI();
          showModal("setsetAwardModal");
          updataAwaitUi();
        });
      }

      // 在现有初始化代码中添加
      // 初始化应用
      function initApp() {
        loadAllData();
        updateUI();
        setupEventListeners();
        setupPasswordEventListeners(); // 添加密码事件监听
        setupIntegrationRuleEventListeners(); // 添加规则时间监听
        setupMallEventListeners(); // 添加积分商店监听
        initPassword(); // 初始化密码验证
      }

      // 页面加载完成后初始化
      document.addEventListener("DOMContentLoaded", initApp);
    </script>
    <script>
      // 全选学生功能实现
      document
        .getElementById("selectAll")
        .addEventListener("click", function () {
          // 获取所有学生复选框
          const checkboxes = document.querySelectorAll(
            ".multi-select-checkbox"
          );

          // 检查是否已有选中项
          const hasUnchecked = Array.from(checkboxes).some(
            (checkbox) => !checkbox.checked
          );

          // 全选或取消全选
          checkboxes.forEach((checkbox) => {
            checkbox.checked = hasUnchecked;

            // 获取对应的学生ID
            const studentId = parseInt(checkbox.getAttribute("data-id"));

            if (hasUnchecked) {
              // 全选：添加到选中集合
              multiSelectedStudentIds.add(studentId);
            } else {
              // 取消全选：从选中集合移除
              multiSelectedStudentIds.delete(studentId);
            }
          });

          // 更新选中计数显示
          document.getElementById("selectedCount").textContent =
            multiSelectedStudentIds.size;
        });
    </script>

    <script>
      // 班级数据，学生数据导入导出
      // ================ 导入学生信息 =======================================
      document
        .getElementById("addStudentBtnFile")
        .addEventListener("click", function () {
          console.dir(document.getElementById("studentFileInput"));
          document.getElementById("studentFileInput").click();
        });

      document
        .getElementById("studentFileInput")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            const data = e.target.result;
            let parsedData;

            if (file.name.endsWith(".csv")) {
              parsedData = Papa.parse(data).data;
            } else if (
              file.name.endsWith(".xlsx") ||
              file.name.endsWith(".xls")
            ) {
              const workbook = XLSX.read(data, { type: "binary" });
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              parsedData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            }

            // 处理解析后的数据
            handleImportedStudents(parsedData);
          };

          if (file.name.endsWith(".csv")) {
            reader.readAsText(file);
          } else if (
            file.name.endsWith(".xlsx") ||
            file.name.endsWith(".xls")
          ) {
            reader.readAsBinaryString(file);
          }

          const studentFileInput = document.getElementById("studentFileInput");
          studentFileInput.files.length = 0;
          studentFileInput.baseURI = "";
          studentFileInput.formAction = "";
          studentFileInput.value = "";
        });

      function handleImportedStudents(data) {
        const nameIdx = data[0].indexOf("姓名");
        const genderIdx = data[0].indexOf("性别");

        if (nameIdx === -1 || genderIdx === -1) {
          alert("文件格式错误，请确保包含“姓名”和“性别”列");
          return;
        }
        console.log("data -->", data);
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          const name = row[nameIdx];
          let gender = row[genderIdx];
          if (row[genderIdx] == "男") {
            gender = "male";
          } else if (row[genderIdx] == "女") {
            gender = "female";
          }
          if (name && gender) {
            // 假设你有一个 students 数组来存储学生信息
            students.push({
              id: generateId(),
              name: name.trim(),
              gender: gender,
              avatar: null,
              totalPoints: 0,
              usedPoints: 0,
              history: [],
              groupId: null,
            });

            const student = {};
          }
        }
        saveAllData();
        updateUI(); // 更新界面显示
      }

      // ================ 导入学生信息end =======================================

      // ================ 导出学生信息 =======================================
      document
        .getElementById("downloadBtnFile")
        .addEventListener("click", function () {
          const wb = XLSX.utils.book_new();

          // 创建工作表数据
          const wsData = [
            ["班级学生信息表"],
            ["姓名", "性别", "积分", "积分获取记录"],
          ];

          students.forEach((student) => {
            const historyStr = student.history
              .map((h) => h.reason)
              .join("，\n");
            wsData.push([
              student.name,
              student.gender == "male" ? "男" : "女",
              student.totalPoints,
              historyStr,
            ]);
          });

          const ws = XLSX.utils.aoa_to_sheet(wsData);
          XLSX.utils.book_append_sheet(wb, ws, "学生信息");

          // 生成并下载文件
          XLSX.writeFile(wb, "班级学生信息表.xlsx");
        });

      // ================ 导出学生信息end =======================================

      // ================ 切换班级 =======================================
      // 示例班级数据（实际项目中可从接口获取）
      function deleteClass(classId) {
        const classList = JSON.parse(localStorage.getItem("classPointsData"));
        console.log("classList -->", classList);
        if (classList && classList.length) {
          const classIndex = classList.findIndex((s) => s.classId == classId);
          if (
            confirm(
              `是否删除${classList[classIndex].systemTitle} 班级,该操作不可撤销！！`
            )
          ) {
            if (classList.length == 1) {
              alert("至少留下一个班级！");
              return;
            }
            classList.splice(classIndex, 1);
            localStorage.setItem("classPointsData", JSON.stringify(classList));
            addClassUI("dle");
            loadAllData();
          }
        }
      }
      function addClassUI(type) {
        // 先存取下数据

        let classList = localStorage.getItem("classPointsData");
        if (classList) {
          classes = JSON.parse(classList).map((i) => {
            return {
              id: i.classId,
              name: i.systemTitle,
              title: i.systemSlogan,
            };
          });
        } else {
          classes = [
            {
              id: classObj.id,
              name: systemTitle,
              title: systemSlogan,
            },
          ];
          saveAllData();
        }
        // 构建页面弹框
        let currentClass = JSON.parse(localStorage.getItem("classObj")); // 当前班级
        const modalContent = document.getElementById("modalContent");
        let rankHtml = "";
        if (type == "add") {
          rankHtml =
            classes.length > 0
              ? classes
                  .map(
                    (item, index) => `
                     <div class="rank-item  classId_${item.id} ${
                      currentClass.id == item.id ? "active_rank_item" : ""
                    }" style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;border-radius: 5px; margin-bottom:8px;">
                       <div class="classId_${
                         item.id
                       }" style="flex: 1; padding: 0 12px;">${item.name}</div>
                       <div class="classId_${
                         item.id
                       }" style="color: var(--primary); font-weight: 600;">${
                      item.title
                    }</div>
                     </div>
                   `
                  )
                  .join("")
              : '<div style="text-align: center; color: #999; padding: 20px;">暂无数据</div>';

          modalContent.innerHTML = `
               <h3>切换班级</h3>
               <div class="rank-list changeClass" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                 ${rankHtml}
               </div>
               <div style="margin-top:20px;">
                 <input
                     type="text"
                     class="form-control"
                     placeholder="班级名称"
                     style="max-width: 200px"
                     id="className"
                   />
                  <button id="addClass" class="btn">添加班级</button>
                 </div>
             `;

          showModal("modal");
          if (addClassInfo) {
            document
              .querySelector("#addClass")
              .removeEventListener("click", addClassInfo);
          }

          document
            .querySelector("#addClass")
            .addEventListener("click", addClassInfo);

          if (changeClassInfo) {
            document
              .querySelector(".changeClass")
              .removeEventListener("click", changeClassInfo);
          }

          document
            .querySelector(".changeClass")
            .addEventListener("click", changeClassInfo);
        } else if (type == "dle") {
          rankHtml =
            classes.length > 0
              ? classes
                  .map(
                    (item, index) => `
                     <div class="rank-item  classId_${item.id}" style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                       <div class="classId_${item.id}" style="flex: 1; padding: 0 12px;">${item.name}</div>
                       <div  onClick="deleteClass(${item.id})" class="classId_${item.id}" style="color: var(--warn); font-weight: 600;cursor: pointer;">删除</div>
                     </div>
                   `
                  )
                  .join("")
              : '<div style="text-align: center; color: #999; padding: 20px;">暂无数据</div>';

          modalContent.innerHTML = `
               <h3>删除班级</h3>
               <div class="rank-list changeClass" style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
                 ${rankHtml}
               </div>
             `;

          showModal("modal");
        }
      }

      let addClassInfo, changeClassInfo, classes;
      function switchClasses(type = "add") {
        // 添加班级
        addClassInfo = function () {
          const name = document.querySelector("#className").value;
          if (!name.trim()) {
            alert("班级名称不能为空！");
            return;
          }
          let classList2 = localStorage.getItem("classPointsData");
          if (classList2) {
            classList2 = JSON.parse(classList2);
          }
          const data = {
            classId: classList2[classList2.length - 1].classId + 1,
            systemTitle: name,
            systemSlogan: "在这里，积分记录每一次成长 🏆",
            students: [],
            groups: [],
            rules: rules, // 保留默认规则如果没有保存的
            shopItems: [],
            timestamp: new Date().toISOString(),
          };

          let res = localStorage.getItem("classPointsData");
          if (res) {
            res = JSON.parse(res);
            res.push(data);
            localStorage.setItem("classPointsData", JSON.stringify(res));
            addClassUI(type);
          }
        };

        changeClassInfo = function (e) {
          // 当前对象标识，本地对象标识更改，调用一次保存，调用一次获取
          console.dir(e.target);
          let id;
          if (e.target.className.includes("classId_")) {
            id = e.target.className.split("_")[1];
            const target = classes.find((i) => i.id == id);
            localStorage.setItem(
              "classObj",
              JSON.stringify({ id: id, title: target.title, name: target.name })
            );
            addClassUI(type);
            loadAllData();
            updateUI();
          }
        };
        // document
        //   .querySelector("#addClass")
        //   .addEventListener("click", addClassInfo);
        addClassUI(type);
      }

      // 联系管理员
      function concatAdmin() {
        // const contactAdminModal = document.querySelector('#contactAdminModal')

        showModal("contactAdminModal");
      }

      // ================ 切换班级end =======================================
    </script>

    <script>
      // 初始奖品数据
      let prizes = awardList.map((i) => i.name);

      let isSpinning = false;
      let currentActive = -1;
      let gridOrder = [0, 1, 2, 5, 8, 7, 6, 3]; // 对应DOM中的实际位置
      if (prizes.length < 8) {
        console.log(" 8 - prizes.length -->");
        let index = 8 - prizes.length;
        for (let i = 0; i <= index; i++) {
          console.log("i -->", i);
          prizes.push("未中奖");
        }
      }
      // 九宫格位置映射 (按顺时针顺序: 左上→上→右上→右→右下→下→左下→左)

      function closeLottery() {
        document.getElementById("lotteryModal").style.display = "none";
        // 重置状态
        isSpinning = false;
        currentActive = -1;
      }

      function addPrize() {
        const input = document.getElementById("prizeInput");
        const prizeName = input.value.trim();

        if (prizeName && !prizes.includes(prizeName)) {
          if (prizes.length < 8) {
            prizes.push(prizeName);
            input.value = "";
            // updatePrizesList();
            updateGrid();
          } else {
            alert("九宫格最多只能设置8个奖品哦！");
          }
        } else if (prizes.includes(prizeName)) {
          alert("这个奖品已经存在啦！");
        }
      }

      function removePrize(button) {
        const prizeTag = button.parentElement;
        const prizeName = prizeTag.textContent.replace("×", "").trim();
        prizes = prizes.filter((prize) => prize !== prizeName);
        // updatePrizesList();
        updateGrid();
      }

      function updatePrizesList() {
        const prizesList = document.getElementById("prizesList");
        prizesList.innerHTML = "";

        if (prizes.length === 0) {
          prizesList.innerHTML =
            '<div style="color: #999; text-align: center; padding: 20px; font-style: italic;">暂无奖品，请添加奖品后开始抽奖</div>';
          return;
        }

        prizes.forEach((prize) => {
          const prizeTag = document.createElement("div");
          prizeTag.className = "prize-tag";
          prizeTag.innerHTML = `
                    ${prize}
                    <button class="remove-prize" onclick="removePrize(this)">×</button>
                `;
          prizesList.appendChild(prizeTag);
        });
      }

      function updateGrid() {
        const grid = document.getElementById("lotteryGrid");
        grid.innerHTML = "";
        prizes = awardList.map((i) => i.name);
        if (prizes.length < 8) {
          console.log(" 8 - prizes.length -->");
          let index = 8 - prizes.length;
          for (let i = 0; i <= index; i++) {
            console.log("i -->", i);
            prizes.push("未中奖");
          }
        }
        // 创建九宫格 (3x3)
        for (let i = 0; i < 9; i++) {
          const gridItem = document.createElement("div");
          gridItem.className = "grid-item";
          gridItem.setAttribute("data-index", i);

          if (i === 4) {
            // 中心位置 - 开始按钮
            gridItem.className += " center";
            gridItem.innerHTML = "开始<br>抽奖";
            gridItem.onclick = startLottery;
          } else {
            // 奖品位置
            const prizeIndex = gridOrder.indexOf(i);
            if (prizeIndex !== -1 && prizeIndex < prizes.length) {
              gridItem.textContent = prizes[prizeIndex];
            } else {
              gridItem.textContent = "?";
              gridItem.className += " empty";
            }
          }

          grid.appendChild(gridItem);
        }
      }

      function startLottery() {
        prizes = awardList.map((i) => i.name);
        if (prizes.length < 8) {
          console.log(" 8 - prizes.length -->");
          let index = 8 - prizes.length;
          for (let i = 0; i <= index; i++) {
            console.log("i -->", i);
            prizes.push("未中奖");
          }
        }
        if (isSpinning || prizes.length === 0) return;

        if (prizes.length === 0) {
          alert("请先添加奖品后再开始抽奖！");
          return;
        }

        isSpinning = true;
        const resultDiv = document.getElementById("result");
        resultDiv.className = "result";
        resultDiv.textContent = "🎯 抽奖进行中，请稍候...";

        // 清除之前的高亮
        document.querySelectorAll(".grid-item").forEach((item) => {
          item.classList.remove("active");
        });

        let currentIndex = 0;
        let speed = 150; // 初始速度(毫秒)
        let rounds = 0;
        const maxRounds = 3; // 转3圈
        const totalSteps = maxRounds * 8; // 总步数
        const finalPosition = Math.floor(Math.random() * awardList.length); // 最终中奖位置
        const finalStep = totalSteps + finalPosition; // 最终停止的步数

        function animate() {
          // 清除上一个高亮
          if (currentActive >= 0) {
            const prevItem = document.querySelector(
              `[data-index="${gridOrder[currentActive]}"]`
            );
            if (prevItem && !prevItem.classList.contains("center")) {
              prevItem.classList.remove("active");
            }
          }

          // 高亮当前位置
          currentActive = currentIndex % 8;
          const currentItem = document.querySelector(
            `[data-index="${gridOrder[currentActive]}"]`
          );
          if (currentItem && !currentItem.classList.contains("center")) {
            currentItem.classList.add("active");
          }

          currentIndex++;

          // 检查是否应该停止
          if (currentIndex >= finalStep) {
            // 停止抽奖
            setTimeout(() => {
              let index = finalPosition;
              if (index == 0) {
                index = 7;
              } else {
                index = index - 1;
              }
              const winningPrize = prizes[index];

              const resultDiv = document.getElementById("result");
              resultDiv.className = "result winner";
              resultDiv.innerHTML = `
                            🎊 恭喜你获得：<strong style="color: #e65100; font-size: 22px;">${winningPrize}</strong> 🎊<br>
                            <small style="color: #666; font-weight: normal; font-size: 14px;">再次点击中央按钮可继续抽奖</small>
                        `;
              isSpinning = false;

              // 3秒后清除高亮
              setTimeout(() => {
                if (currentActive >= 0) {
                  const activeItem = document.querySelector(
                    `[data-index="${gridOrder[currentActive]}"]`
                  );
                  if (activeItem) activeItem.classList.remove("active");
                }
              }, 3000);
            }, 800);
            return;
          }

          // 动态调整速度，最后几步逐渐减速
          const remainingSteps = finalStep - currentIndex;
          if (remainingSteps <= 10) {
            speed = 150 + (10 - remainingSteps) * 50; // 逐渐减速
          } else if (currentIndex < 8) {
            speed = Math.max(80, speed - 10); // 开始时加速
          } else {
            speed = 80; // 中间保持稳定速度
          }

          setTimeout(animate, speed);
        }

        animate();
      }

      function openLottery() {
        document.getElementById("lotteryModal").style.display = "block";
        // updatePrizesList();
        updateGrid();
      }
    </script>
  </body>
</html>

